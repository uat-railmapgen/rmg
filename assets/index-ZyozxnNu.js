import{j as e}from"./chakra-IsC3UXVX.js";import{r as d}from"./react-3b0LFcOb.js";import{g as k,aV as O,u as p,m as se,S as _,aT as B,P as C}from"./index-v47a8GMz.js";import{a as ie,c as N,b as oe,d as le,S as K}from"./share-joFUzs7U.js";import{i as ce}from"./param-manager-utils-qSvRt4D8.js";function me(t){const{num:n,inStrip:a,...r}=t;return e.jsxs("g",{textAnchor:"middle",fill:a?k.black:"var(--rmg-theme-fg)",...r,children:[e.jsx("rect",{height:40,width:40,rx:4,x:-20,fill:a?"#fff":"var(--rmg-theme-colour)"}),e.jsx("text",{className:"rmg-name__en",fontSize:20,dy:12,children:n}),e.jsx("text",{className:"rmg-name__zh",fontSize:12,dy:26,children:"屏蔽门"}),e.jsx("text",{className:"rmg-name__en",fontSize:6.5,dy:36,children:"Screen Door"})]})}const Q=t=>{const n=(s=>{switch(s){case"gz28":case"gz2otis":case"gz6":case"gzgf":return 60;case"gz1":case"gz3":return 40;case"gz4":case"gz5":case"gz1421":return 20;default:return 0}})(t.variant),a=d.useMemo(()=>{switch(t.variant){case"gz1":return e.jsx("circle",{cy:-58,r:16,fill:"red"});case"gz28":case"gz2otis":return e.jsx("ellipse",{cy:-30,rx:24,ry:12,fill:"orange"});case"gz3":return e.jsx("rect",{x:-15,y:-55,height:30,width:30,fill:"red"});case"gz6":return e.jsx("ellipse",{cy:-30,rx:24,ry:12,fill:"white"});case"gz1421":return e.jsx("ellipse",{cy:-38,rx:24,ry:12,fill:"orange"});case"gz5":return e.jsx("rect",{x:-30,y:-70,height:30,width:60,fill:"orange"});case"gz4":return e.jsx("rect",{x:-50,y:-50,height:25,width:100,fill:"whitesmoke"});case"gzgf":return e.jsx("rect",{x:-30,y:-58,height:30,width:60,fill:"orange"});default:return e.jsx(e.Fragment,{})}},[t.variant]),r=-20;return e.jsxs("g",{transform:"translate(0,".concat(t.variant==="gz4"?r:0,")"),children:[e.jsx("rect",{id:"strip_gz",style:{"--height":"".concat(n,"px")}}),e.jsx("g",{style:{transform:"translate(calc(var(--rmg-svg-width) / 2),var(--rmg-svg-height))"},children:t.isShowLight&&a}),t.isShowPSD!==!1&&e.jsx(de,{...t})]})},de=d.memo(function(n){const a=["gz28","gz2otis","gz6","gzgf"].includes(n.variant),r=(s=>{switch(s){case"gz1":case"gz3":return"82px";case"gz4":return"65px";case"gz5":return"80px";case"gz1421":return"62px";default:return"58px"}})(n.variant);return e.jsx(me,{num:n.isShowPSD,inStrip:a,style:{"--psd-dy":r,transform:"translate(var(--translate-x), var(--translate-y))","--translate-x":"calc(var(--rmg-svg-width) / 2 + 80px)","--translate-y":"calc(var(--rmg-svg-height) - var(--psd-dy, 58px))"}})},(t,n)=>t.variant===n.variant&&t.isShowPSD===n.isShowPSD);var D=45,$=D-3,ee=function(t,n){var a=[t,n].map(function(r){return r.match(/^(\w+).+$/)});if(a[0]&&a[1]&&a[0][1]===a[1][1])return a[0][1]},H=function(t){var n=t.match(/^(\d+)\D+$/);return n==null?void 0:n[1]},L=function(){return L=Object.assign||function(t){for(var n,a=1,r=arguments.length;a<r;a++){n=arguments[a];for(var s in n)Object.prototype.hasOwnProperty.call(n,s)&&(t[s]=n[s])}return t},L.apply(this,arguments)},he=function(t,n){var a={};for(var r in t)Object.prototype.hasOwnProperty.call(t,r)&&n.indexOf(r)<0&&(a[r]=t[r]);if(t!=null&&typeof Object.getOwnPropertySymbols=="function")for(var s=0,r=Object.getOwnPropertySymbols(t);s<r.length;s++)n.indexOf(r[s])<0&&Object.prototype.propertyIsEnumerable.call(t,r[s])&&(a[r[s]]=t[r[s]]);return a};function A(t){var n=t.customWidth,a=he(t,["customWidth"]),r=(n!=null?n:D)-D;return e.jsx("rect",L({x:-22.5-r/2,height:24,width:n!=null?n:D,rx:4.5},a,{"data-testid":"intBox"}))}var xe=function(t,n){var a=typeof Symbol=="function"&&t[Symbol.iterator];if(!a)return t;var r=a.call(t),s,o=[],i;try{for(;(n===void 0||n-- >0)&&!(s=r.next()).done;)o.push(s.value)}catch(c){i={error:c}}finally{try{s&&!s.done&&(a=r.return)&&a.call(r)}finally{if(i)throw i.error}}return o},ue=function(t,n){var a=H(t);if(a)return{isDigit:!0,spanningPart:a};var r=ee(t,n);return r?{isDigit:!1,spanningPart:r}:{isDigit:!1,spanningPart:""}};function X(t){var n=t.zhName,a=t.enName,r=t.foregroundColour,s=t.backgroundColour,o=t.zhClassName,i=t.enClassName,c=t.passed,m=ue(n,a),l=m.isDigit,x=m.spanningPart,h=d.useRef(null),u=xe(d.useState({x:0,height:0,width:0}),2),f=u[0],g=u[1];d.useEffect(function(){h.current&&g(h.current.getBBox())},[n,a]);var j=$/Math.max($,f.width),y=(-f.x-f.width/2)*j,S=f.height*(1-j)/2;return e.jsxs("g",{textAnchor:"middle",fill:c?k.white:r,children:[e.jsx(A,{fill:c?"#aaa":s}),e.jsx("g",{ref:h,transform:"translate(".concat(y,",").concat(S,")scale(").concat(j,")"),children:e.jsxs("text",{className:o,fontSize:21,x:-1,y:12,textAnchor:"end",dominantBaseline:"central",children:[x,e.jsx("tspan",{className:o,fontSize:10,x:0,dy:-4,textAnchor:"start",dominantBaseline:"central",children:n.slice(x.length).trim()}),e.jsx("tspan",{className:i,fontSize:6.5,letterSpacing:-.1,x:0,dy:10,textAnchor:"start",dominantBaseline:"middle",children:l?a:a.slice(x.length).trim()})]})})]})}var U=function(t,n){var a=typeof Symbol=="function"&&t[Symbol.iterator];if(!a)return t;var r=a.call(t),s,o=[],i;try{for(;(n===void 0||n-- >0)&&!(s=r.next()).done;)o.push(s.value)}catch(c){i={error:c}}finally{try{s&&!s.done&&(a=r.return)&&a.call(r)}finally{if(i)throw i.error}}return o};function ge(t){var n,a=t.zhName,r=t.enName,s=t.foregroundColour,o=t.backgroundColour,i=t.zhClassName,c=t.enClassName,m=t.passed,l=(n=H(a))!==null&&n!==void 0?n:"",x=d.useRef(null),h=d.useRef(null),u=U(d.useState({width:0}),2),f=u[0],g=u[1],j=U(d.useState({width:0}),2),y=j[0],S=j[1];d.useEffect(function(){x.current&&g(x.current.getBBox()),h.current&&S(h.current.getBBox())},[a,r]);var w=$/Math.max($,f.width),b=$/Math.max($,y.width),E={nameZh:{y:7.3+13.5*(1-w)*w/2},nameEn:{y:19.5-9*(1-b)*b/2}};return e.jsxs("g",{textAnchor:"middle",fill:m?k.white:s,children:[e.jsx(A,{fill:m?"#aaa":o}),e.jsxs("text",{ref:x,className:i,fontSize:12,transform:"translate(0,".concat(E.nameZh.y,")scale(").concat(w,")"),dominantBaseline:"central",children:[e.jsx("tspan",{fontSize:16,dy:.7,dominantBaseline:"central",children:l}),e.jsx("tspan",{dy:-.7,dominantBaseline:"central",children:a.slice(l.length)})]}),e.jsx("text",{ref:h,className:c,fontSize:8,transform:"translate(0,".concat(E.nameEn.y,")scale(").concat(b,")"),dominantBaseline:"middle",children:r})]})}var fe=function(t,n){var a=typeof Symbol=="function"&&t[Symbol.iterator];if(!a)return t;var r=a.call(t),s,o=[],i;try{for(;(n===void 0||n-- >0)&&!(s=r.next()).done;)o.push(s.value)}catch(c){i={error:c}}finally{try{s&&!s.done&&(a=r.return)&&a.call(r)}finally{if(i)throw i.error}}return o};function ye(t){var n=t.zhName,a=t.enName,r=t.foregroundColour,s=t.backgroundColour,o=t.zhClassName,i=t.enClassName,c=t.passed,m=d.useRef(null),l=fe(d.useState({width:0}),2),x=l[0],h=l[1];d.useEffect(function(){m.current&&h(m.current.getBBox())},[n,a]);var u=Math.max(45,x.width+4);return e.jsxs("g",{textAnchor:"middle",fill:c?k.white:r,children:[e.jsx(A,{customWidth:u,fill:c?"#aaa":s}),e.jsxs("g",{ref:m,children:[e.jsx("text",{className:o,fontSize:8.5,y:8,dominantBaseline:"central",children:n}),e.jsx("text",{className:i,fontSize:5.5,y:18,dominantBaseline:"middle",children:a})]})]})}var V=function(t,n){var a=typeof Symbol=="function"&&t[Symbol.iterator];if(!a)return t;var r=a.call(t),s,o=[],i;try{for(;(n===void 0||n-- >0)&&!(s=r.next()).done;)o.push(s.value)}catch(c){i={error:c}}finally{try{s&&!s.done&&(a=r.return)&&a.call(r)}finally{if(i)throw i.error}}return o};function je(t){var n=t.zhName,a=t.enName,r=t.foregroundColour,s=t.backgroundColour,o=t.zhClassName,i=t.enClassName,c=t.passed,m=d.useRef(null),l=d.useRef(null),x=V(d.useState({width:0}),2),h=x[0],u=x[1],f=V(d.useState({width:0}),2),g=f[0],j=f[1];d.useEffect(function(){m.current&&u(m.current.getBBox()),l.current&&j(l.current.getBBox())},[n,a]);var y=$/Math.max($,h.width),S=$/Math.max($,g.width),w={nameZh:{y:7.3+13.5*(1-y)*y/2},nameEn:{y:19.5-9*(1-S)*S/2}};return e.jsxs("g",{textAnchor:"middle",fill:c?k.white:r,children:[e.jsx(A,{fill:c?"#aaa":s}),e.jsx("text",{ref:m,className:o,fontSize:12,transform:"translate(0,".concat(w.nameZh.y,")scale(").concat(y,")"),dominantBaseline:"central",children:n}),e.jsx("text",{ref:l,className:i,fontSize:8,transform:"translate(0,".concat(w.nameEn.y,")scale(").concat(S,")"),dominantBaseline:"middle",children:a})]})}var R=function(){return R=Object.assign||function(t){for(var n,a=1,r=arguments.length;a<r;a++){n=arguments[a];for(var s in n)Object.prototype.hasOwnProperty.call(n,s)&&(t[s]=n[s])}return t},R.apply(this,arguments)};const te=d.memo(function(n){var a=n.zhName,r=n.enName,s=n.spanDigits,o=_e(a,r);switch(o){case 1:return s?e.jsx(X,R({},n)):e.jsx(ge,R({},n));case 2:return e.jsx(X,R({},n));default:return a.length>=5?e.jsx(ye,R({},n)):e.jsx(je,R({},n))}});var _e=function(t,n){var a=H(t);if(a!==void 0)return 1;var r=ee(t,n);return r!==void 0?2:3};const Se=d.memo(function(n){var a=n.stroke,r=n.filled,s="M0,9.25 V-9.25 H-9.25 a9.25,9.25 0 0,0 0,18.5 h18.5 a9.25,9.25 0 0,0 0,-18.5 H0";return e.jsx("path",{d:s,fill:r?a:"#fff",strokeWidth:1.3,stroke:a})});var W=function(){return W=Object.assign||function(t){for(var n,a=1,r=arguments.length;a<r;a++){n=arguments[a];for(var s in n)Object.prototype.hasOwnProperty.call(n,s)&&(t[s]=n[s])}return t},W.apply(this,arguments)},Ne=function(t,n){var a={};for(var r in t)Object.prototype.hasOwnProperty.call(t,r)&&n.indexOf(r)<0&&(a[r]=t[r]);if(t!=null&&typeof Object.getOwnPropertySymbols=="function")for(var s=0,r=Object.getOwnPropertySymbols(t);s<r.length;s++)n.indexOf(r[s])<0&&Object.prototype.propertyIsEnumerable.call(t,r[s])&&(a[r[s]]=t[r[s]]);return a},Y=function(t,n){var a=typeof Symbol=="function"&&t[Symbol.iterator];if(!a)return t;var r=a.call(t),s,o=[],i;try{for(;(n===void 0||n-- >0)&&!(s=r.next()).done;)o.push(s.value)}catch(c){i={error:c}}finally{try{s&&!s.done&&(a=r.return)&&a.call(r)}finally{if(i)throw i.error}}return o},T=15;function pe(t){var n=t.Icon,a=t.lineNum,r=t.stnNum,s=t.strokeColour,o=t.passed,i=t.size,c=t.textClassName,m=Ne(t,["Icon","lineNum","stnNum","strokeColour","passed","size","textClassName"]),l=d.useRef(null),x=d.useRef(null),h=Y(d.useState({width:0}),2),u=h[0],f=h[1],g=Y(d.useState({width:0}),2),j=g[0],y=g[1];d.useEffect(function(){l.current&&f(l.current.getBBox()),x.current&&y(x.current.getBBox())},[a,r]);var S=T/Math.max(T,u.width),w=(a==null?void 0:a.length)===2&&(r==null?void 0:r.length)===2?S:T/Math.max(T,j.width),b=i==="sm"?"0.7":i==="lg"?"1.4":1;return e.jsx("g",W({},m,{children:e.jsxs("g",{transform:"scale(".concat(b,")"),children:[e.jsx(n,{stroke:o?"#aaa":s,filled:!a&&!r}),(a||r)&&e.jsxs("g",{textAnchor:"middle",fontSize:13.5,fill:o?"#aaa":"#000",children:[e.jsx("g",{transform:"translate(-9.25,0)scale(".concat(S,")"),children:e.jsx("text",{ref:l,className:c,dominantBaseline:"central",x:.5,children:a})}),e.jsx("g",{transform:"translate(9.25,0)scale(".concat(w,")"),children:e.jsx("text",{ref:x,className:c,dominantBaseline:"central",children:r})})]})]})}))}var M=function(){return M=Object.assign||function(t){for(var n,a=1,r=arguments.length;a<r;a++){n=arguments[a];for(var s in n)Object.prototype.hasOwnProperty.call(n,s)&&(t[s]=n[s])}return t},M.apply(this,arguments)};function ne(t){return e.jsx(pe,M({Icon:Se},t))}const ve=d.memo(function(n){const{stnName:a,onUpdate:r}=n,s=d.useRef(null);return d.useEffect(()=>{s.current&&r&&r(s.current.getBBox())},[a.toString()]),e.jsxs("g",{ref:s,children:[e.jsx("text",{className:"rmg-name__zh",fontSize:18,children:a[0]}),e.jsx("g",{fontSize:10.5,children:a[1].split("\\").map((o,i)=>e.jsx("text",{className:"rmg-name__en",dy:16+i*11,children:o},i))})]})},(t,n)=>t.stnName.toString()===n.stnName.toString());function ze(t){const{stnName:n,onUpdate:a,passed:r,...s}=t,o=d.useRef(null),[i,c]=d.useState({x:0,width:0});return d.useEffect(()=>{if(o.current){const m=o.current.getBBox();c(m),a&&a(m)}},[n.toString()]),!n[0]&&!n[1]?e.jsx(e.Fragment,{}):e.jsxs("g",{fill:r?"#aaa":"#000",...s,children:[e.jsxs("g",{transform:"translate(0,3)",fontSize:18,children:[e.jsx("text",{textAnchor:"end",x:i.x-3,className:"rmg-name__zh",children:"("}),e.jsx("text",{textAnchor:"start",x:i.width+i.x+3,className:"rmg-name__zh",children:")"})]}),e.jsxs("g",{ref:o,textAnchor:"middle",children:[e.jsx("text",{className:"rmg-name__zh",fontSize:13,children:n[0]}),e.jsx("text",{dy:10,className:"rmg-name__en",fontSize:6.5,children:n[1]})]})]})}function Be(t){const{passed:n,...a}=t;return e.jsxs("g",{textAnchor:"middle",fill:n?"#aaa":"var(--rmg-theme-colour)",...a,children:[e.jsx("text",{className:"rmg-name__zh",fontSize:13,children:"快车停靠站"}),e.jsx("text",{dy:10,className:"rmg-name__en",fontSize:6.5,children:"Express Station"})]})}function we(t){const{primaryName:n,secondaryName:a,stationState:r,flipped:s,express:o}=t,[i,c]=d.useState({width:0}),[m,l]=d.useState({x:0,width:-20}),x=f=>{switch(f){case O.PASSED:return"#aaa";case O.CURRENT:return"#f00";case O.FUTURE:return"#000"}},h=n[1].split("\\").length,u={g:{x:0,y:s?17.5:-20-h*14*Math.cos(-45)},StationSecondaryName:{x:(i.width+m.width/2+10)*(s?-1:1),y:2+5*(h-1)},ExpressTag:{x:(i.width+m.width+20+35)*(s?-1:1),y:2+5*(h-1)}};return e.jsxs("g",{textAnchor:s?"end":"start",fill:x(r),transform:"translate(".concat(u.g.x,",").concat(u.g.y,")rotate(-45)"),children:[e.jsx(ve,{stnName:n,onUpdate:c}),a&&e.jsx(ze,{stnName:a,onUpdate:l,passed:r===O.PASSED,transform:"translate(".concat(u.StationSecondaryName.x,",").concat(u.StationSecondaryName.y,")")}),o&&e.jsx(Be,{passed:r===O.PASSED,transform:"translate(".concat(u.ExpressTag.x,",").concat(u.ExpressTag.y,")")})]})}function be(t){var g,j,y,S,w,b;const{stnId:n,stnState:a,stnY:r}=t,{theme:s,line_name:o,line_num:i,spanLineNum:c,stn_list:m}=p(E=>E.param),l=m[n],x=l.parents.length===2||l.children.length===2,h=r>0||l.parents.indexOf(((j=(g=l.branch)==null?void 0:g.left)==null?void 0:j[1])||"")===1||l.children.indexOf(((S=(y=l.branch)==null?void 0:y.right)==null?void 0:S[1])||"")===1?180:0,u=l.name[1].split("\\").length,f=x?h===180?16+(u-1)*12*Math.cos(-45):-9:h===180?-6:(25+(u-1)*15)*Math.cos(-45);return e.jsxs(e.Fragment,{children:[e.jsx($e,{intInfos:x?[{theme:[s[0],s[1],"var(--rmg-theme-colour)","var(--rmg-theme-fg)"],name:o},...(w=l.transfer.groups[0].lines)!=null?w:[]]:(b=l.transfer.groups[0].lines)!=null?b:[],stnState:a,tickRotation:h,spanDigits:c}),e.jsx(ne,{lineNum:i,stnNum:l.num,strokeColour:s[2],textClassName:"rmg-name__zh",passed:a===-1}),e.jsx("g",{transform:"translate(".concat(-f,",0)"),children:e.jsx(we,{primaryName:l.name,secondaryName:l.secondaryName||void 0,stationState:a,flipped:h===180,express:l.services.includes(se.express)})})]})}const $e=t=>e.jsxs(e.Fragment,{children:[e.jsx(Ce,{strokeWidth:4,...t}),e.jsx(Ee,{transform:"translate(0,".concat(t.tickRotation===180?-47:23,")"),...t})]}),Ce=t=>{const{intInfos:n,stnState:a,tickRotation:r,spanDigits:s,...o}=t;return e.jsx("g",{...o,children:n.map((i,c)=>{var m;return e.jsx("use",{xlinkHref:"#inttick",stroke:a===-1?"#aaa":(m=i.theme)==null?void 0:m[2],transform:"translate(".concat(-2*(n.length-1)+4*c,",0)rotate(").concat(r===180?180:0,")")},c)})})},Ee=t=>{const{intInfos:n,tickRotation:a,stnState:r,spanDigits:s,...o}=t;return e.jsx("g",{...o,children:n.map((i,c)=>{var m,l,x,h;return e.jsx("g",{transform:"translate(0,".concat(c*28*(a===180?-1:1),")"),children:e.jsx(te,{zhName:i.name[0],enName:i.name[1],foregroundColour:(l=(m=i.theme)==null?void 0:m[3])!=null?l:k.white,backgroundColour:(h=(x=i.theme)==null?void 0:x[2])!=null?h:"#aaaaaa",zhClassName:"rmg-name__zh",enClassName:"rmg-name__en",passed:r===-1,spanDigits:s})},c)})})},J=(t,n)=>t[n].parents.length===2||t[n].children.length===2?.25:0,Re=(t,n,a)=>{const r=N("linestart","lineend",n);if(r.nodes.includes(t))return N(r.nodes[1],t,n).len;{const s=a.filter(l=>l.includes(t))[0];let o=t;for(;!r.nodes.includes(o);)o=s[s.indexOf(o)-1];let i=t;for(;!r.nodes.includes(i);)i=s[s.indexOf(i)+1];const c=o==="linestart",m=i==="lineend";if(s.toString()===a[0].toString()){const l=[];return!c&&!m?(l[0]=N(r.nodes[1],o,n).len,l[1]=N(o,i,n).len,l[2]=N(o,t,n).len,l[3]=N(t,i,n).len):c?(l[0]=0,l[1]=N(r.nodes[1],i,n).len,l[2]=N(s[1],t,n).len,l[3]=N(t,i,n).len):(l[0]=N(r.nodes[1],o,n).len,l[1]=N(o,r.nodes.slice(-2)[0],n).len,l[2]=N(o,t,n).len,l[3]=N(t,s.slice(-2)[0],n).len),l[0]+l[2]*l[1]/(l[2]+l[3])}else if(!c&&!m){const l=[];return l[0]=N(r.nodes[1],o,n).len,l[1]=N(o,i,n).len,l[2]=N(o,t,n).len,l[3]=N(t,i,n).len,l[0]+l[2]*l[1]/(l[2]+l[3])}else return c?N(r.nodes[1],i,n).len-N(t,i,n).len:N(r.nodes[1],o,n).len+N(o,t,n).len}},ke=()=>{const{branches:t,routes:n,depsStr:a}=p(v=>v.helper),{svgWidth:r,svg_height:s,y_pc:o,padding:i,branchSpacingPct:c,direction:m,line_name:l,spanLineNum:x,current_stn_idx:h,stn_list:u}=p(v=>v.param),f=ie(u,J,J),g=d.useMemo(()=>(console.log("computing x shares"),Object.keys(u).reduce((v,z)=>({...v,[z]:Re(z,f,t)}),{})),[t.toString(),JSON.stringify(f)]),j=N("linestart","lineend",f),y=N(j.nodes[1],j.nodes.slice(-2)[0],f),S=m===_.right?[r[B.RailMap]*i/100+65,r[B.RailMap]*(1-i/100)-20]:[r[B.RailMap]*i/100,r[B.RailMap]*(1-i/100)-65],w=Object.keys(g).reduce((v,z)=>({...v,[z]:S[0]+g[z]/y.len*(S[1]-S[0])}),{}),b=d.useMemo(()=>(console.log("computing y shares"),Object.keys(u).reduce((v,z)=>{if(t[0].includes(z))return{...v,[z]:0};{const P=t.slice(1).filter(ae=>ae.includes(z))[0];return{...v,[z]:u[P[0]].children.indexOf(P[1])?-2:2}}},{})),[a]),E=Object.keys(b).reduce((v,z)=>({...v,[z]:-b[z]*c*s/200}),{}),F=d.useMemo(()=>oe(h,n,m),[h,m,n.toString()]),G=t.map(v=>le(v,F)).reduce((v,z)=>(v.main.push(z.main),v.pass.push(z.pass),v),{main:[],pass:[]}),re=Object.keys(G).reduce((v,z)=>({...v,[z]:G[z].map(P=>Pe(P,w,E))}),{});return e.jsxs("g",{id:"main",style:{"--y-percentage":o,transform:"translateY(calc(var(--y-percentage) * var(--rmg-svg-height) / 100))"},children:[e.jsx(Oe,{paths:re}),e.jsx(Te,{xs:w,ys:E,stnStates:F}),e.jsx("g",{id:"line_name",style:{"--translate-x":m===_.right?"".concat(S[0]-65,"px"):"".concat(S[1]+65,"px")},children:e.jsx(te,{zhName:l[0],enName:l[1],foregroundColour:"var(--rmg-theme-fg)",backgroundColour:"var(--rmg-theme-colour)",zhClassName:"rmg-name__zh",enClassName:"rmg-name__en",spanDigits:x})})]})},Oe=d.memo(function(n){return e.jsxs("g",{fill:"none",strokeWidth:4,children:[e.jsx("g",{stroke:"#aaa",strokeDasharray:4,children:n.paths.pass.map((a,r)=>e.jsx("path",{d:a},r))}),e.jsx("g",{stroke:"var(--rmg-theme-colour)",children:n.paths.main.map((a,r)=>e.jsx("path",{d:a},r))})]})},(t,n)=>JSON.stringify(t.paths)===JSON.stringify(n.paths)),Pe=(t,n,a)=>{let r;const s=[];return t.forEach(o=>{const i=n[o],c=a[o];if(!r&&r!==0){r=c,s.push("M ".concat(i,",").concat(c));return}c===0?(c<r&&s.push("H ".concat(i-40),"a 40,40 0 0,0 40,-40","V ".concat(c)),c>r&&s.push("H ".concat(i-40),"a 40,40 0 0,1 40,40","V ".concat(c))):(c<r&&s.push("V ".concat(c+40),"a 40,40 0 0,1 40,-40","H ".concat(i)),c>r&&s.push("V ".concat(c-40),"a 40,40 0 0,0 40,40","H ".concat(i))),s.push("H ".concat(i)),r=c}),s.join(" ").replace(/( H ([\d.]+))+/g," H $2")},Te=t=>{const{xs:n,ys:a,stnStates:r}=t,s=p(o=>o.param.stn_list);return e.jsx("g",{id:"stn_icons",children:Object.keys(s).filter(o=>!["linestart","lineend"].includes(o)).map(o=>e.jsx("g",{style:{transform:"translate(".concat(n[o],"px,").concat(a[o],"px)")},children:e.jsx(be,{stnId:o,stnState:r[o],stnY:a[o]})},o))})};function Z(t){return e.jsx("path",{d:"M60,60 L0,0 L60,-60 H90 L40,-10 H150 V10 H40 L90,60z",fill:"black",...t})}function De(t){const{destIds:n,textAnchor:a,...r}=t,s=p(l=>l.param.direction),o=p(l=>l.param.stn_list),i=n.map(l=>o[l].name[0].length),c=Math.min(...i),m=c>1&&i[0]!==i[1]?Math.abs(i[0]-i[1])/(c-1):0;return e.jsxs("g",{textAnchor:a,...r,children:[n.map((l,x)=>{const h=i[x]>i[1-x],u=!ce()&&a==="end"&&!h;return e.jsxs(d.Fragment,{children:[e.jsx("text",{className:"rmg-name__zh",fontSize:25,x:s===_.left?0:-75,y:-21+42*x,letterSpacing:h?"0em":"".concat(m,"em"),dx:u?"".concat(m,"em"):"0em",children:o[l].name[0]}),e.jsx("text",{className:"rmg-name__en",fontSize:11.5,x:s===_.left?0:-75,y:-1+42*x,children:"Towards "+o[l].name[1].replace("\\"," ")})]},l)}),e.jsx("text",{className:"rmg-name__zh",fontSize:28,x:s===_.left?25*(Math.max(...i)+1):0,y:5,children:"方向"})]})}const q=B.RailMap,Ae=()=>{const{canvasScale:t}=p(u=>u.app),{svgWidth:n,svg_height:a,direction:r,psd_num:s,info_panel_type:o,notesGZMTR:i,current_stn_idx:c,stn_list:m,theme:l}=p(u=>u.param),x=n[q],h=m[c];return e.jsxs(K,{type:q,svgWidth:x,svgHeight:a,canvasScale:t,theme:l,children:[e.jsx(Ie,{}),e.jsx(Q,{variant:o,isShowLight:o===C.gz2otis,isShowPSD:o===C.gz2otis&&s}),r===_.left&&h.parents.includes("linestart")||r===_.right&&h.children.includes("lineend")?e.jsx(Me,{}):e.jsxs(e.Fragment,{children:[e.jsx(ke,{}),e.jsx(Le,{}),i==null?void 0:i.map((u,f)=>e.jsx(He,{note:u},f))]}),o===C.gz2otis&&e.jsx("line",{x2:x,transform:"translate(0,90)",strokeWidth:3,stroke:"black"})]})},Ie=d.memo(function(){return e.jsx("defs",{children:e.jsx("path",{id:"inttick",d:"M 0,0 v 18",strokeLinecap:"square"})})}),Le=()=>{const{routes:t}=p(c=>c.helper),{direction:n,direction_gz_x:a,direction_gz_y:r,current_stn_idx:s}=p(c=>c.param),o=d.useMemo(()=>[...new Set(t.reduce((c,m)=>m.includes(s)?c.concat(m.filter(l=>!["linestart","lineend"].includes(l)).slice(n===_.left?0:-1)[0]):c,[]).filter(c=>c!==s))],[s,n,t.toString()]),i={textAnchor:n===_.left?"start":"end",transform:"translate(".concat(n===_.left?65:-65,",-5)"),destIds:o};return e.jsxs("g",{id:"direction_gz",style:{"--x-percentage":a,"--y-percentage":r},children:[e.jsx(Z,{transform:"scale(0.35)rotate(".concat(n===_.left?0:180,")")}),o.length!==2?e.jsx(We,{...i}):e.jsx(De,{...i})]})},We=t=>{const{destIds:n,...a}=t,r=p(s=>s.param.stn_list);return e.jsxs("g",{...a,children:[e.jsx("text",{className:"rmg-name__zh",fontSize:28,children:n.map(s=>r[s].name[0]).join("/")+"方向"}),e.jsx("text",{className:"rmg-name__en",fontSize:14,dy:22,children:"Towards "+n.map(s=>r[s].name[1].replace("\\"," ")).join("/")})]})},Me=d.memo(function(){return e.jsxs("g",{id:"terminus_gz",textAnchor:"middle",children:[e.jsx("text",{className:"rmg-name__zh",fontSize:90,children:"终 点 站"}),e.jsx("text",{dy:70,className:"rmg-name__en",fontSize:36,children:"Terminal"}),e.jsxs("g",{strokeWidth:8,stroke:"#000",children:[e.jsx("path",{d:"M -160,68 h -160"}),e.jsx("path",{d:"M 160,68 h 160"})]})]})}),He=d.memo(function(n){const a=d.useRef(null),[r,s]=d.useState({width:0,height:0,y:0});return d.useEffect(()=>{a.current&&s(a.current.getBBox())},[n.note[0],n.note[1]]),e.jsxs("g",{className:"note-box",style:{"--x-percentage":n.note[2],"--y-percentage":n.note[3]},children:[n.note[4]&&e.jsx("rect",{height:r.height+4,width:r.width+4,x:-2,y:r.y-2,fill:"none",stroke:"black",strokeWidth:.5}),e.jsxs("g",{ref:a,children:[e.jsx("g",{fontSize:16,letterSpacing:1.2,children:n.note[0].split("\n").map((o,i)=>e.jsx("text",{className:"rmg-name__zh",y:i*18,children:o},i))}),e.jsx("g",{fontSize:10,letterSpacing:.33,transform:"translate(0,".concat(18*n.note[0].split("\n").length,")"),children:n.note[1].split("\n").map((o,i)=>{var c;return e.jsx("text",{className:"rmg-name__en",y:i*11,textLength:i<(((c=n.note[1].match(/\n/g))==null?void 0:c.length)||0)?r.width:navigator.userAgent.includes("Firefox")?-1:0,lengthAdjust:"spacing",children:o},i)})})]})]})},(t,n)=>t.note.toString()===n.note.toString()),Ze=d.memo(function(n){const{stnName:a,onUpdate:r}=n,s=d.useRef(null);return d.useEffect(()=>{s.current&&r&&r(s.current.getBBox())},[a.toString()]),e.jsxs("g",{ref:s,children:[e.jsx("text",{className:"rmg-name__zh",fontSize:90,children:a[0]}),e.jsx("g",{fontSize:36,children:a[1].split("\\").map((o,i)=>e.jsx("text",{className:"rmg-name__en",dy:70+i*36,children:o},i))})]})},(t,n)=>t.stnName.toString()===n.stnName.toString()),Fe=t=>{const{secondaryName:n,transform:a}=t,r=d.useRef(null),[s,o]=d.useState({x:0,width:0});return d.useEffect(()=>{r.current&&o(r.current.getBBox())},[n.toString()]),e.jsxs("g",{transform:a,children:[e.jsxs("g",{transform:"translate(0,4.5)",fontSize:36,children:[e.jsx("text",{textAnchor:"end",x:s.x-3,className:"rmg-name__zh",children:"("}),e.jsx("text",{textAnchor:"start",x:s.width+s.x+3,className:"rmg-name__zh",children:")"})]}),e.jsxs("g",{ref:r,textAnchor:"middle",children:[e.jsx("text",{className:"rmg-name__zh",fontSize:26,children:n[0]}),e.jsx("text",{dy:22,className:"rmg-name__en",fontSize:14,children:n[1]})]})]})},Ge=()=>{const{svg_height:t,svgWidth:n,theme:a,direction:r,info_panel_type:s,line_num:o,current_stn_idx:i,stn_list:c}=p(g=>g.param),m=c[i],[l,x]=d.useState({width:0}),h=m[r===_.left?"parents":"children"],u={name:"translate(".concat((r===_.left?1:-1)*n[B.RunIn]/4,",45)"),next:"translate(".concat((r===_.left?1:-1)*n[B.RunIn]/10,",45)")},f={nameGroup:{x:n.runin/2,y:.5*t-50-(m.name[1].split("\\").length-1)*18-(m.secondaryName?29:0)},secondaryName:{x:0,y:70+m.name[1].split("\\").length*36}};return e.jsxs("g",{children:[e.jsxs("g",{transform:s===C.gz2otis?u.name:"",children:[e.jsxs("g",{textAnchor:"middle",transform:"translate(".concat(f.nameGroup.x,",").concat(f.nameGroup.y,")"),children:[e.jsx(Ze,{stnName:m.name,onUpdate:x}),m.secondaryName&&e.jsx(Fe,{secondaryName:m.secondaryName,transform:"translate(".concat(f.secondaryName.x,",").concat(f.secondaryName.y,")")})]}),e.jsx(ne,{lineNum:o,stnNum:m.num,strokeColour:a[2],textClassName:"rmg-name__zh",style:{"--translate-x":"".concat((n[B.RunIn]+l.width)/2+55,"px"),"--translate-y":"".concat(.5*t-30-(m.name[1].split("\\").length-1)*18-(m.secondaryName?58/2:0),"px"),transform:"translate(var(--translate-x, 800px), var(--translate-y, 145px))"},size:"lg"})]}),e.jsx("g",{transform:s===C.gz2otis?u.next:"",children:!h||h.includes("linestart")||h.includes("lineend")?e.jsx(e.Fragment,{}):h.length===1?e.jsx(Xe,{nextId:h[0],nameBBox:l}):e.jsx(Ve,{nextIds:h,nameBBox:l})})]})},Xe=t=>{const{nextId:n,nameBBox:a}=t,r=p(f=>f.param.svgWidth),s=p(f=>f.param.direction),o=p(f=>f.param.stn_list[n]),{name:i,secondaryName:c}=o,[m,l]=d.useState({width:0}),x=d.useRef(null);d.useEffect(()=>{x.current&&l(x.current.getBBox())},[i.toString()]);const h=i[0].length,u=(r[B.RunIn]-a.width)/2;return e.jsxs(e.Fragment,{children:[e.jsxs("g",{id:"big_next",children:[e.jsxs("g",{textAnchor:"middle",style:{"--translate-x":s===_.left?"80px":h<=2?"".concat(r[B.RunIn]-45-m.width-70,"px"):"".concat(r[B.RunIn]-45-m.width-35*1.5,"px")},children:[e.jsx("text",{className:"rmg-name__zh",fontSize:35,children:"下站"}),e.jsx("text",{className:"rmg-name__en",fontSize:17,dy:30,children:"Next"})]}),e.jsxs("g",{textAnchor:"start",ref:x,style:{"--translate-x":s===_.left?h<=2?"150px":"".concat(115+35/2,"px"):"".concat(r[B.RunIn]-45-m.width,"px")},children:[e.jsx("text",{className:"rmg-name__zh",fontSize:35,children:i[0]}),e.jsx("g",{fontSize:17,children:i[1].split("\\").map((f,g)=>e.jsx("text",{className:"rmg-name__en",dy:30+g*17,children:f},g))})]}),c&&e.jsx("g",{textAnchor:"middle",style:{"--translate-x":s===_.left?h<=2?"150px":"".concat(115+35/2,"px"):"".concat(r[B.RunIn]-45-m.width,"px")},children:e.jsx(Ue,{secName:c,transform:"translate(".concat(m.width/2,",").concat(30+i[1].split("\\").length*17+5,")")})})]}),e.jsx(Z,{id:"arrow",style:{"--translate-x":s===_.left?"".concat((115+35*((h<=2?1:.5)+h)+u)/2-20,"px"):"".concat((r[B.RunIn]-45-m.width-(h<=2?105:35*2.5)+u+t.nameBBox.width+55+18.5*1.4)/2+20,"px"),"--rotate":s===_.left?"0deg":"180deg"}})]})},Ue=t=>{const{secName:n,...a}=t,r=d.useRef(null),[s,o]=d.useState({x:0,width:0});return d.useEffect(()=>{r.current&&o(r.current.getBBox())},[t.secName.toString()]),e.jsxs("g",{...a,children:[e.jsxs("g",{transform:"translate(0,2.5)",fontSize:25,children:[e.jsx("text",{textAnchor:"end",x:s.x-3,className:"rmg-name__zh",children:"("}),e.jsx("text",{textAnchor:"start",x:s.width+s.x+3,className:"rmg-name__zh",children:")"})]}),e.jsxs("g",{ref:r,children:[e.jsx("text",{className:"rmg-name__zh",fontSize:18,children:n[0]}),e.jsx("text",{className:"rmg-name__en",fontSize:10,dy:15,children:n[1]})]})]})},Ve=t=>{const{nextIds:n,nameBBox:a}=t,{routes:r}=p(g=>g.helper),s=p(g=>g.param.svgWidth),o=p(g=>g.param.direction),i=p(g=>g.param.stn_list),c=n.map(g=>i[g].name),[m,l]=d.useState({width:0}),x=d.useRef([]);d.useEffect(()=>{l(g=>({...g,width:0})),x.current.forEach(g=>{const j=g==null?void 0:g.getBBox();l(y=>j?y.width>j.width?y:j:y)})},[c.toString()]);const h=t.nextIds.map(g=>r.reduce((j,y)=>y.includes(g)?j.concat(y.filter(S=>!["linestart","lineend"].includes(S)).slice(o===_.left?0:-1)[0]):j,[])),u=Math.max(...c.map(g=>g[0].length)),f=(s[B.RunIn]-a.width)/2;return e.jsxs(e.Fragment,{children:[e.jsx("g",{id:"big_next_2",children:c.map((g,j)=>e.jsxs(d.Fragment,{children:[e.jsxs("g",{textAnchor:"middle",style:{"--translate-x":o===_.left?"72px":"".concat(s[B.RunIn]-45-m.width-41,"px")},children:[e.jsx("text",{className:"rmg-name__zh",children:"下站"}),e.jsx("text",{className:"rmg-name__en",y:22,children:"Next"})]}),e.jsxs("g",{ref:y=>x.current[j]=y,textAnchor:"start",style:{"--translate-x":o===_.left?"113px":"".concat(s[B.RunIn]-45-m.width,"px")},children:[e.jsx("text",{className:"rmg-name__zh",children:g[0]}),g[1].split("\\").map((y,S)=>e.jsx("text",{className:"rmg-name__en",y:22+S*13,children:y},S)),e.jsx("text",{className:"rmg-name__zh",y:-35,children:h[j].map(y=>i[y].name[0]).join("/")+"方向"}),e.jsx("text",{className:"rmg-name__en rmg-name__gzmtr--next2-dest",y:-20,children:"Towards "+h[j].map(y=>i[y].name[1]).join("/").replace("\\"," ")})]})]},j))}),e.jsx(Z,{id:"arrow",style:{"--translate-x":o===_.left?"".concat((99+27*(1+u)+f)/2-20,"px"):"".concat((s[B.RunIn]-45-m.width-41-27+f+t.nameBBox.width+55+18.5*1.4)/2+20,"px"),"--rotate":o===_.left?"0deg":"180deg"}})]})};function Ye(t){const{num:n,...a}=t;return e.jsxs("g",{textAnchor:"middle",fill:"var(--rmg-theme-fg)",...a,children:[e.jsx("circle",{cx:0,cy:0,r:30,fill:"var(--rmg-theme-colour)"}),e.jsx("text",{className:"rmg-name__en",fontSize:38,dy:-9.5,children:n}),e.jsx("text",{className:"rmg-name__zh",fontSize:13,dy:10,children:"站台"}),e.jsx("text",{className:"rmg-name__en",fontSize:9,dy:21,children:"Platform"})]})}function Je(t){const{canvasType:n}=t,{svgWidth:a,svg_height:r}=p(s=>s.param);return e.jsxs("g",{id:"otis_frame",strokeWidth:3,stroke:"black",children:[e.jsx("line",{y2:r,transform:"translate(".concat(a[n]/2,",0)")}),e.jsx("line",{x2:a[n],transform:"translate(0,90)"})]})}const I=B.RunIn;function qe(){const{canvasScale:t}=p(x=>x.app),{svgWidth:n,svg_height:a,direction:r,info_panel_type:s,platform_num:o,psd_num:i,theme:c}=p(x=>x.param),m=n[I],l={platform:"translate(".concat(r===_.left?50:-50,",45)")};return e.jsxs(K,{type:I,svgWidth:m,svgHeight:a,canvasScale:t,theme:c,children:[e.jsx(Q,{variant:s,isShowLight:s!==C.gz2otis,isShowPSD:s!==C.gz2otis&&i}),e.jsx("g",{transform:s===C.gz2otis?l.platform:"",children:e.jsx(Ye,{num:o,style:{"--translate-x":"".concat(r===_.left?m-100:100,"px"),"--translate-y":"calc(var(--rmg-svg-height) / 2 - 30px)",transform:"translate(var(--translate-x, 100px), var(--translate-y))"}})}),e.jsx(Ge,{}),s===C.gz2otis&&e.jsx(Je,{canvasType:I})]})}const rt={runin:e.jsx(qe,{}),railmap:e.jsx(Ae,{})};export{rt as default};
