import{j as e}from"./chakra-IsC3UXVX.js";import{r as w,b as Q}from"./react-3b0LFcOb.js";import{aT as L,u as b,m as D}from"./index-ZgU6nnGx.js";import{i as U}from"./app-router-ApmcnsOG.js";import{S as q,d as ue,a as pe,c as J,g as je,b as _e}from"./share-n_njgBve.js";import{a as oe}from"./mtr-nriSrtbM.js";import"./param-manager-utils-5gyk9LbX.js";const ke=(r,s,t,n)=>{const a=r.length-n*2-t,l=r.findIndex(h=>h===s),o=[...r,...r,...r],i=r.length+l-Math.floor(a/2)+(a%2===0?1:0),c=r.length+l+Math.floor(a/2);return{top:o.slice(i,c+1),left:o.slice(i-n,i),right:o.slice(c+1,c+1+n),bottom:o.slice(c+1+n,c+1+n+t)}},$e=(r,s,t,n)=>{const a=r.length-n*2-t,l=[...r,...r,...r],o=r.length+r.findIndex(h=>h===s),i=l[o+a-1],c=r.length+r.findIndex(h=>h===i)+(o+a>r.length*2?r.length:0);return{top:l.slice(o,c+1),left:l.slice(o-n,o),right:l.slice(c+1,c+1+n),bottom:l.slice(c+1+n,c+1+n+t)}},we=(r,s,t,n)=>{let a=r.findIndex(g=>g===s[0]),l=r.findIndex(g=>g===s[1]);[a,l,s[0],s[1]]=a>l?[l,a,s[1],s[0]]:[a,l,s[0],s[1]];const o=r.slice(a,l+1),i=r.filter(g=>!o.filter(d=>!s.includes(d)).includes(g)),c=r.length-(n==="major"?Math.max:Math.min)(o.length,i.length)-t*2,h=n==="major"?o.length>i.length?s[0]:s[1]:o.length>i.length?s[1]:s[0];return $e(r,h,c,t)},Me=(r,s)=>{const t=Object.fromEntries(r.map(h=>[h,-1])),n=Object.fromEntries(r.map(h=>[h,-1])),[a,l,o,i]=[0,1,0,1],c=0;return s.top.forEach((h,g)=>{t[h]=c/2+(1-c)/(s.top.length+1)*(g+1),n[h]=a}),s.right.forEach((h,g)=>{t[h]=i,n[h]=c/2+(1-c)/(s.right.length+1)*(g+1)}),s.bottom.forEach((h,g)=>{t[h]=1-c/2-(1-c)/(s.bottom.length+1)*(g+1),n[h]=l}),s.left.forEach((h,g)=>{t[h]=o,n[h]=1-c/2-(1-c)/(s.left.length+1)*(g+1)}),{x_shares:t,y_shares:n}},be=(r,s,t,n)=>{const a=r[0].filter(c=>!["linestart","lineend"].includes(c)),l=[...a,...a,...a],o=s==="r"?l:l.reverse(),i=o.findIndex(c=>n===c)+a.length;return o.slice(i+1).filter(c=>t[c].loop_pivot).slice(void 0,2)},ce=L.Destination;function Ne(){const{canvasScale:r}=b(l=>l.app),{svgWidth:s,svg_height:t,theme:n}=b(l=>l.param),a=s[ce];return e.jsxs(q,{type:ce,svgWidth:a,svgHeight:t,canvasScale:r,theme:n,children:[e.jsx(He,{}),e.jsx(Oe,{})]})}const He=w.memo(function(){return e.jsx("defs",{children:e.jsx("marker",{id:"slope",viewBox:"-1.5 0 3 1.5",refY:.5,children:e.jsx("path",{d:"M0,0L1,1H-1z",fill:"var(--rmg-theme-colour)"})})})}),Oe=()=>{const{routes:r,branches:s}=b($=>$.helper),{line_name:t,theme:n,current_stn_idx:a,direction:l,stn_list:o,info_panel_type:i,loop:c,coline:h}=b($=>$.param),g=($,S,v)=>[...new Set($.filter(k=>k.includes(v)).map(k=>{const y=k.filter(N=>!["linestart","lineend"].includes(N));return S==="l"?y[0]:y.reverse()[0]}))],d=($,S)=>S?[[$.map(v=>o[v].name[0]).join("，"),$.map(v=>o[v].name[1]).join(", ")].map(v=>v.replace("\\",""))]:$.map(v=>o[v].name.map(k=>k.replace("\\",""))),j=c?be(s,l,o,a):g(r,l,a),u=(c?g(r,l,a):j).filter($=>s.slice(1).filter(S=>U(S,o)).some(S=>S.includes($))),x=j.filter($=>!u.includes($)),f=d(x,!c&&i!=="sh2020");console.log(f);const m=d(u,!0),p=250,_=Object.fromEntries(u.map($=>[$,Object.values(h).filter(S=>S.from===$||S.to===$).at(0)]).filter(([,$])=>$));return e.jsxs(e.Fragment,{children:[e.jsx(he,{dest_names:f,line_name:t,line_color:[n[2],n[3]],coline:!!u.length,upper:!!u.length}),u.length&&u.map($=>{var S,v,k;return e.jsx("g",{transform:"translate(0,".concat(-p,")"),children:e.jsx(he,{dest_names:[m.at(0)],line_name:(S=_[$])==null?void 0:S.colors.at(0).slice(4),line_color:[(v=_[$])==null?void 0:v.colors.at(0)[2],(k=_[$])==null?void 0:k.colors.at(0)[3]],coline:!0,upper:!1})},"coline_".concat($))})]})},he=r=>{const{dest_names:s,line_name:t,line_color:n,coline:a,upper:l}=r,{current_stn_idx:o,direction:i,platform_num:c,svgWidth:h,svg_height:g}=b(S=>S.param),d=w.useRef(null),[j,u]=w.useState({width:0});w.useEffect(()=>{d.current&&u(d.current.getBBox())},[JSON.stringify(s),JSON.stringify(o)]);const[x,f,m,p,_]=[h.destination/2,10,36,264,325],$=x-f-m-j.width>=_/2&&x-f-m-p>=_/2?x:i==="l"?(h.destination+j.width-p)/2:(h.destination-j.width+p)/2;return e.jsxs("g",{transform:"translate(0,".concat(g-300,")"),children:[e.jsx("path",{stroke:n[0],strokeWidth:12,d:i==="l"?"M".concat(h.destination-24,",16 H 36"):"M24,16 H ".concat(h.destination-36),transform:"translate(0,".concat(l?-20:220,")"),markerEnd:a?void 0:"url(#slope)"}),e.jsx(Ie,{ref:d,dest_names:s}),c!==""&&e.jsx("g",{transform:"translate(".concat($,",0)"),children:e.jsx(Le,{})}),t[0].match(/^[\w\d]+(号)?线/)?e.jsx(Be,{line_name:t,line_color:n}):e.jsx(ze,{line_name:t,line_color:n})]})},Ie=w.forwardRef(function(s,t){const{dest_names:n}=s,{direction:a,svgWidth:l}=b(o=>o.param);return e.jsxs("g",{ref:t,transform:"translate(".concat(a==="l"?36:l.destination-36,",145)"),children:[e.jsx("g",{transform:"translate(0,".concat(n.length===2?-20:20,")"),children:e.jsx("path",{d:"M60,60L0,0L60-60H100L55-15H160V15H55L100,60z",fill:"black",transform:"rotate(".concat(a==="l"?0:180,")scale(0.8)")})}),e.jsx("g",{textAnchor:a==="l"?"start":"end",transform:"translate(".concat(a==="l"?148:-148,",25)"),children:n.map((o,i)=>e.jsxs(w.Fragment,{children:[e.jsx("text",{className:"rmg-name__zh rmg-outline",fontSize:70,dy:i*-100+7,children:"往"+o[0]},"zh".concat(i)),e.jsx("text",{className:"rmg-name__en rmg-outline",fontSize:25,dy:i*-100+40,children:"To "+o[1]},"en".concat(i))]},i))})]})}),Le=()=>{const{platform_num:r}=b(s=>s.param);return w.useMemo(()=>e.jsxs("g",{transform:"translate(".concat(-325/2+60,",150)"),children:[e.jsx("circle",{r:60,fill:"none",stroke:"black",strokeWidth:2}),e.jsx("text",{className:"rmg-name__en rmg-outline",dominantBaseline:"central",fontSize:120,textAnchor:"middle",children:r}),e.jsx("text",{className:"rmg-name__zh rmg-outline",fontSize:100,dominantBaseline:"central",x:65,children:"站台"})]}),[r])},ze=r=>{const{line_name:s,line_color:t}=r,{direction:n,svgWidth:a}=b(d=>d.param),l=n==="l"?a.destination-42:42,o=w.useRef(null),[i,c]=w.useState({width:0});w.useEffect(()=>{o.current&&c(o.current.getBBox())},[...s]);const h=(n==="l"?-i.width:0)-6,g=(n==="l"?-1:1)*i.width/2;return w.useMemo(()=>e.jsxs("g",{transform:"translate(".concat(l,",92)"),children:[e.jsx("rect",{fill:t[0],x:h,width:i.width+10,height:120}),e.jsxs("g",{textAnchor:n==="r"?"start":"end",transform:"translate(0,68)",fill:t[1],children:[e.jsx("g",{ref:o,children:e.jsx("text",{className:"rmg-name__zh rmg-outline",fontSize:68,children:s[0]})}),e.jsx("text",{className:"rmg-name__en rmg-outline",fontSize:30,textAnchor:"middle",x:g,dy:42,children:s[1]})]})]}),[i,...s,...t,n,a.destination])},Be=r=>{const{line_name:s,line_color:t}=r,{direction:n,svgWidth:a}=b(c=>c.param),[l,o]=s[0].match(/^[\w\d]+|.+/g),i=n==="l"?a.destination-36-210:90;return w.useMemo(()=>e.jsxs("g",{transform:"translate(".concat(i,",92)"),children:[e.jsx("rect",{fill:t[0],x:-54,width:108,height:120}),e.jsx("text",{className:"rmg-name__zh rmg-outline",fill:t[1],fontSize:96,textAnchor:"middle",dominantBaseline:"central",transform:"translate(0,60)",letterSpacing:-5,children:l}),e.jsxs("g",{textAnchor:"start",transform:"translate(74,68)",children:[e.jsx("text",{className:"rmg-name__zh rmg-outline",fontSize:68,children:o}),e.jsx("text",{className:"rmg-name__en rmg-outline",fontSize:30,dy:42,children:s[1]})]})]}),[i,...s,...t,n,a.destination])},R=(r,s)=>r.map(t=>{const n=s.filter(c=>c.includes(t.from)&&c.includes(t.to));if(n.length!==1)return{linePath:[],colors:t.colors};const a=n.flat(),l=a.indexOf(t.from),o=a.indexOf(t.to);return{linePath:l<o?a.slice(l,o+1):a.slice(o,l+1),colors:t.colors}}).filter(t=>t.linePath.length!==0),Ee=(r,s)=>r.map(t=>{const n=ue(t.linePath,s);return{main:[{linePath:n.main,colors:t.colors}],pass:[{linePath:n.pass,colors:t.colors}]}}).reduce((t,n)=>(t.main=[...t.main,...n.main],t.pass=[...t.pass,...n.pass],t),{main:[],pass:[]}),ee=()=>Q.useMemo(()=>e.jsxs("filter",{id:"pujiang_outline",colorInterpolationFilters:"sRGB",filterUnits:"userSpaceOnUse",x:"0",y:"-1000",width:"5000",height:"2000",children:[e.jsxs("feComponentTransfer",{in:"SourceGraphic",children:[e.jsx("feFuncR",{type:"discrete",tableValues:"0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 1 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0"}),e.jsx("feFuncG",{type:"discrete",tableValues:"0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 1 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0"}),e.jsx("feFuncB",{type:"discrete",tableValues:"0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 1 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0"})]}),e.jsx("feColorMatrix",{type:"matrix",values:"1 0 0 0 0\n                            0 1 0 0 0\n                            0 0 1 0 0\n                            1 1 1 1 -3",result:"selectedColor"}),e.jsx("feMorphology",{operator:"erode",in:"selectedColor",radius:"0",result:"e1"}),e.jsx("feMorphology",{operator:"erode",in:"selectedColor",radius:"1",result:"e2"}),e.jsx("feComposite",{in:"e1",in2:"e2",operator:"xor",result:"uncoloredOutline"}),e.jsx("feFlood",{floodColor:"rgb(0,0,0)"}),e.jsx("feComposite",{operator:"in",in2:"uncoloredOutline",result:"outline"}),e.jsx("feComposite",{in:"outline",in2:"selectedColor",operator:"over",result:"result"}),e.jsx("feComposite",{in:"result",in2:"SourceGraphic",operator:"over"})]}),[]);ee.displayName="PujiangLineDefs";const A=12,de=L.RunIn,We=()=>{const{canvasScale:r}=b(x=>x.app),{branches:s,routes:t,depsStr:n}=b(x=>x.helper),{svgWidth:a,svg_height:l,current_stn_idx:o,direction:i,loop:c,theme:h}=b(x=>x.param),g=a[de],d=l-300,j=w.useMemo(()=>{let x=t.filter(f=>f.includes(o)).map(f=>f[f.indexOf(o)+(i==="l"?1:-1)]).filter(f=>f!==void 0).reduce((f,m)=>f.includes(m)?f:f.concat(m),[]);return c&&s[0].includes(o)&&x.length===1&&["linestart","lineend"].includes(x[0])&&(x=i==="l"?[s[0][1]]:[s[0][s[0].length-2]]),x},[n,o,i,c]),u=w.useMemo(()=>{let x=t.filter(f=>f.includes(o)).map(f=>f[f.indexOf(o)+(i==="l"?-1:1)]).filter(f=>f!==void 0).reduce((f,m)=>f.includes(m)?f:f.concat(m),[]);return c&&s[0].includes(o)&&x.length===1&&["linestart","lineend"].includes(x[0])&&(x=i==="l"?[s[0][s[0].length-2]]:[s[0][1]]),x},[n,o,i,c]);return e.jsxs(q,{type:de,svgWidth:g,svgHeight:l,canvasScale:r,theme:h,children:[e.jsx(Pe,{}),e.jsx("g",{transform:"translate(0,".concat(d,")"),children:e.jsx(Te,{prevStnIds:j,nextStnIds:u})})]})},Pe=w.memo(function(){return e.jsxs("defs",{children:[e.jsx("marker",{id:"slope",viewBox:"-1.5 0 3 1.5",refY:.5,children:e.jsx("path",{d:"M0,0L1,1H-1z",fill:"var(--rmg-theme-colour)"})}),e.jsx(ee,{})]})}),Te=r=>{const{prevStnIds:s,nextStnIds:t}=r,{info_panel_type:n,svgWidth:a,stn_list:l}=b(u=>u.param),o=a.runin/2,i=t.length===1&&["linestart","lineend"].includes(t[0]),c=s.length===1&&["linestart","lineend"].includes(s[0]),h=t.map(u=>l[u].name),g=s.map(u=>l[u].name),d=(t.length>1?(h[0][0].split("\\").length-1)*-50+(h[0][1].split("\\").length-1)*-30:0)+10,j=(s.length>1?(g[0][0].split("\\").length-1)*-50+(g[0][1].split("\\").length-1)*-30:0)+10;return e.jsxs(e.Fragment,{children:[e.jsx(De,{prevStnIds:s,nextStnIds:t,nextBranchLineDy:d,prevBranchLineDy:j}),i&&n!=="sh2020"?e.jsx(me,{mode:"terminal",prevStnIds:s,nextStnIds:t}):c&&n!=="sh2020"?e.jsx(me,{mode:"original",prevStnIds:s,nextStnIds:t}):e.jsxs(e.Fragment,{children:[e.jsx(Ce,{prevStnIds:s,nextStnIds:t}),e.jsx("g",{transform:"translate(".concat(o,",160)"),textAnchor:"middle",children:e.jsx(ve,{})})]}),(c||!i)&&e.jsx(Ae,{stnIds:r.nextStnIds}),(i||!c)&&e.jsx(Fe,{stnIds:r.prevStnIds})]})},me=r=>{var x;const{mode:s,prevStnIds:t,nextStnIds:n}=r,{current_stn_idx:a,theme:l,svgWidth:o,direction:i,coline:c}=b(f=>f.param),{branches:h}=b(f=>f.helper),g={l:{original:{x:o.runin-36,anchor:"end"},terminal:{x:36,anchor:"start"}},r:{original:{x:36,anchor:"start"},terminal:{x:o.runin-36,anchor:"end"}}},d=R(Object.values(c),h),j=s==="terminal"?t:n,u=n.length>1?"var(--rmg-theme-colour)":(x=d.filter(f=>f.linePath.includes(a)&&f.linePath.includes(j[0])).map(f=>f.colors[0][2])[0])!=null?x:"var(--rmg-theme-colour)";return e.jsxs(e.Fragment,{children:[s==="original"&&e.jsx("path",{transform:"translate(0,".concat(c.length?"198":"220",")").concat(c.length?"scale(1,2)":""),stroke:u,strokeWidth:12,d:i==="l"?"M ".concat(o.runin-24,",16 H 36"):"M24,16 H ".concat(o.runin-36),markerEnd:"url(#slope)"}),s==="terminal"&&e.jsx("g",{filter:l[2]==="#B5B5B6"?"url(#pujiang_outline)":void 0,children:e.jsx("path",{transform:"translate(0,".concat(c.length?"198":"220",")").concat(c.length?"scale(1,2)":""),stroke:"var(--rmg-grey)",strokeWidth:12,d:"M24,16 H ".concat(o.runin-24)})}),e.jsx("g",{transform:"translate(".concat(g[i][s].x,",160)"),textAnchor:g[i][s].anchor,children:e.jsx(ve,{})})]})},Ce=r=>{var S;const{prevStnIds:s,nextStnIds:t}=r,{direction:n,svgWidth:a,theme:l,coline:o,current_stn_idx:i,stn_list:c}=b(v=>v.param),{branches:h}=b(v=>v.helper),g=a.runin/2,d=v=>v.includes("linestart")||v.includes("lineend"),j=R(Object.values(o),h),u=t.length>1?"single":d(t)?j.filter(v=>[i,s[0]].every(k=>v.linePath.includes(k))).length>0?"multiple":"single":[i,t[0]].every(v=>h[0].includes(v))&&j.filter(v=>[i,t[0]].every(k=>v.linePath.includes(k))).length>0?"multiple":"single",x=d(t)?s:t,f=t.length>1?"var(--rmg-theme-colour)":(S=j.filter(v=>v.linePath.includes(i)&&v.linePath.includes(x[0])).map(v=>v.colors[0][2])[0])!=null?S:"var(--rmg-theme-colour)",m=(v,k,y,N)=>v.slice(1).filter(O=>[k,y[0]].every(M=>O.includes(M))).filter(O=>U(O,N)).length>0,p=Object.keys(o).length>0&&m(h,i,t,c)?f:"var(--rmg-theme-colour)",_=Object.keys(o).length>0&&t.length===1&&(d(s)||d(t)?!0:!([i,t[0]].every(v=>h[0].includes(v))&&j.filter(v=>v.linePath.includes(i)&&v.linePath.includes(t[0])).length!==0)),$=Object.keys(o).length>0&&s.length===1;return e.jsxs("g",{transform:"translate(0,220)",strokeWidth:12,children:[e.jsxs(e.Fragment,{children:[p!=="var(--rmg-theme-colour)"&&e.jsx("marker",{id:"slope_".concat(p),viewBox:"-1.5 0 3 1.5",refY:.5,children:e.jsx("path",{d:"M0,0L1,1H-1z",fill:p})}),e.jsx("path",{stroke:p,d:"M ".concat(g,",16 H ").concat(n==="l"?36:a.runin-36),markerEnd:p==="var(--rmg-theme-colour)"?"url(#slope)":"url(#slope_".concat(p,")"),transform:_?"translate(0,-22)scale(1,2)":void 0})]}),u==="multiple"&&e.jsxs(e.Fragment,{children:[e.jsx("marker",{id:"slope_".concat(f),viewBox:"-1.5 0 3 1.5",refY:.5,children:e.jsx("path",{d:"M0,0L1,1H-1z",fill:f})}),e.jsx("path",{stroke:f,d:"M ".concat(g,",16 H ").concat(n==="l"?36+A:a.runin-(36+A)),markerEnd:"url(#slope_".concat(f,")"),transform:"translate(0,-12)"})]}),e.jsx("g",{filter:l[2]==="#B5B5B6"?"url(#pujiang_outline)":void 0,transform:"translate(0,".concat($?-22:0,")scale(1,").concat($?2:1,")"),children:e.jsx("path",{stroke:"var(--rmg-grey)",d:"M ".concat(g,",16 H ").concat(n==="l"?a.runin-24:24," ")})})]})},De=r=>{const{prevStnIds:s,nextStnIds:t,nextBranchLineDy:n,prevBranchLineDy:a}=r,{direction:l,svgWidth:o,current_stn_idx:i,coline:c,theme:h}=b(_=>_.param),{branches:g}=b(_=>_.helper),d=o.runin/2,j=125,u=_=>"".concat(_[0],",").concat(_[1]),x=_=>"M".concat(u(_.at(0))," ")+_.slice(1).map($=>"L".concat(u($))).join(" "),f=l==="l"?[[o.runin/3,j],[o.runin/6,n],[36,n]]:[[o.runin/3*2,j],[o.runin/6*5,n],[o.runin-36,n]],m=l==="l"?[[o.runin/3*2,j],[o.runin/6*5,a],[o.runin-24,a]]:[[o.runin/3,j],[o.runin/6,a],[24,a]];let p="var(--rmg-theme-colour)";if(Object.keys(c).length>0){const _=R(Object.values(c),g);t.length>1&&_.filter($=>$.linePath.includes(i)&&t.some(S=>$.linePath.includes(S)))&&(f[0][1]-=A-1,f.unshift([d,j-A+1]),p=_.filter($=>$.linePath.includes(i)&&t.some(S=>$.linePath.includes(S))).at(0).colors.at(0)[2]),s.length>1&&_.filter($=>$.linePath.includes(i)&&s.some(S=>$.linePath.includes(S)))&&(m[0][1]-=A-1,m.unshift([d,j-A+1]))}return e.jsxs("g",{transform:"translate(0,110)",strokeWidth:12,fill:"none",filter:h[2]==="#B5B5B6"?"url(#pujiang_outline)":void 0,children:[e.jsx("marker",{id:"slope_branch",viewBox:"-1.5 0 3 1.5",refY:.5,children:e.jsx("path",{d:"M0,0L1,1H-1z",fill:p})}),t.length>1&&e.jsx("path",{stroke:p,d:x(f),markerEnd:"url(#slope_branch)"}),s.length>1&&e.jsx("path",{stroke:"var(--rmg-grey)",d:x(m)})]})},ve=()=>{const r=b(t=>t.param),{name:s}=r.stn_list[r.current_stn_idx];return w.useMemo(()=>e.jsxs(e.Fragment,{children:[e.jsx("text",{className:"rmg-name__zh rmg-outline",fontSize:112,children:s[0].replace("\\","")}),e.jsx("text",{className:"rmg-name__en rmg-outline",fontSize:36,dy:50,children:s[1].replace("\\","")})]}),[...s])},Z=r=>{const{nextName:s,...t}=r;return e.jsx("g",{...t,children:w.useMemo(()=>e.jsxs(e.Fragment,{children:[s[0].split("\\").map((n,a,l)=>e.jsx("text",{className:"rmg-name__zh rmg-outline",fontSize:48,dy:(l.length-1-a)*-50-(s[1].split("\\").length-1)*30,children:n},n)),s[1].split("\\").map((n,a,l)=>e.jsx("text",{className:"rmg-name__en rmg-outline",fontSize:24,dy:28+(l.length-1-a)*-30,children:n},n))]}),[...s])})},Fe=r=>{const s=b(l=>l.param),t=r.stnIds.map(l=>s.stn_list[l].name),n=(r.stnIds.length>1?15:125)+t.map(l=>l[0].split("\\").length).reduce((l,o)=>l+o,-t.length)*-50+t.map(l=>l[1].split("\\").length).reduce((l,o)=>l+o,-t.length)*-30,a=(r.stnIds.length>1?(t[0][0].split("\\").length-1)*-50+(t[0][1].split("\\").length-1)*-30:0)+70;return e.jsxs("g",{fill:"gray",textAnchor:s.direction==="l"?"end":"start",transform:"translate(".concat(s.direction==="l"?s.svgWidth.runin-36:36,",0)"),children:[e.jsx(Z,{nextName:t[0],transform:"translate(0,183)"}),r.stnIds.length>1&&e.jsx(Z,{nextName:t[1],transform:"translate(0,".concat(a,")")}),e.jsxs("g",{transform:"translate(0, ".concat(n,")"),children:[e.jsx("text",{className:"rmg-name__zh rmg-outline",fontSize:22,children:"上一站"}),e.jsx("text",{className:"rmg-name__en rmg-outline",fontSize:12,dx:s.direction==="l"?-70:70,children:"Past Stop"})]})]})},Ae=r=>{const s=b(l=>l.param),t=r.stnIds.map(l=>s.stn_list[l].name),n=(r.stnIds.length>1?15:125)+t.map(l=>l[0].split("\\").length).reduce((l,o)=>l+o,-t.length)*-50+t.map(l=>l[1].split("\\").length).reduce((l,o)=>l+o,-t.length)*-30,a=(r.stnIds.length>1?(t[0][0].split("\\").length-1)*-50+(t[0][1].split("\\").length-1)*-30:0)+70;return e.jsxs("g",{textAnchor:s.direction==="l"?"start":"end",transform:"translate(".concat(s.direction==="l"?36:s.svgWidth.runin-36,",0)"),children:[e.jsx(Z,{nextName:s.stn_list[r.stnIds[0]].name,transform:"translate(0,183)"}),r.stnIds.length>1&&e.jsx(Z,{nextName:s.stn_list[r.stnIds[1]].name,transform:"translate(0,".concat(a,")")}),e.jsxs("g",{transform:"translate(0, ".concat(n,")"),children:[e.jsx("text",{className:"rmg-name__zh rmg-outline",fontSize:22,children:"下一站"}),e.jsx("text",{className:"rmg-name__en rmg-outline",fontSize:12,dx:s.direction==="l"?70:-70,children:"Next Stop"})]})]})},K=r=>{var $;const{stnId:s,stnState:t,color:n,bank:a,direction:l}=r,{direction:o,info_panel_type:i,stn_list:c,loop:h}=b(S=>S.param),g=c[s],d=l!=null?l:o,j=h?0:(g.parents.length>1||g.children.length>1?8+12*g.name[1].split("\\").length:0)*(d==="r"?-1:1);let u;const x={};i==="sh2020"?(g.services.length===3?u="stn_sh_2020_direct":g.services.length===2?u="stn_sh_2020_express":u="stn_sh_2020",x.fill=t===-1?"gray":n||"var(--rmg-theme-colour)"):(g.services.length===3?u="direct_sh":g.services.length===2?u="express_sh":[...g.transfer.groups[0].lines||[],...(($=g.transfer.groups[1])==null?void 0:$.lines)||[]].length>0?u="int2_sh":u="stn_sh",x.stroke=t===-1?"gray":n||"var(--rmg-theme-colour)");const f=a!=null?a:0,m=(d==="l"?6:-6)+j+f*30,p=(i==="sh2020"?-20:-6)+Math.abs(f)*(i==="sh2020"?25:11),_=f?0:d==="l"?-45:45;return e.jsxs(e.Fragment,{children:[e.jsx("use",{xlinkHref:"#".concat(u),...x,transform:"translate(".concat(f*(i==="sh2020"?5:0),",0)rotate(").concat(f*90*(i==="sh2020"?1:-1),")")}),e.jsx("g",{transform:"translate(".concat(m,",").concat(p,")rotate(").concat(_,")"),children:e.jsx(Re,{name:g.name,groups:g.transfer.groups,stnState:t,direction:d,facility:g.facility,bank:f,oneLine:g.one_line,intPadding:g.int_padding})}),t===0?e.jsx(Ye,{}):void 0]})},Re=r=>{var p,_,$,S;const{name:s,groups:t,stnState:n,direction:a,facility:l,bank:o,oneLine:i,intPadding:c}=r,h=w.useRef(null),g=a==="l"?1:-1,d=l?30:0,j=o?-12:0,u=w.useRef(null),[x,f]=w.useState(0);w.useEffect(()=>{var v,k;return f((k=(v=u.current)==null?void 0:v.getBBox().width)!=null?k:0)},[JSON.stringify(t)]);const m=c-x;return e.jsxs(e.Fragment,{children:[t.map(v=>{var k;return(k=v.lines)!=null?k:[]}).flat().length>0&&e.jsxs(e.Fragment,{children:[e.jsx("line",{x1:(j+d)*g,x2:m*g,stroke:n===-1?"gray":"black",strokeWidth:.5}),e.jsx(Ve,{ref:u,groups:t,direction:a,transform:"translate(".concat(m*g,",-10.75)")})]}),l&&e.jsx("use",{xlinkHref:"#"+l,x:10*g,y:-30}),e.jsxs("g",{textAnchor:a==="l"?"start":"end",transform:"translate(".concat(d*g,",-14)"),children:[e.jsx(Ge,{ref:h,stnName:s,oneLine:i,directionPolarity:g,fill:n===-1?"gray":n===0?"red":"black"}),((_=(p=t[1])==null?void 0:p.lines)==null?void 0:_.length)&&e.jsx("g",{transform:"translate(".concat((m+x/2)*g,",-30)"),children:e.jsx(Ue,{osiInfos:t[1].lines})}),((S=($=t[2])==null?void 0:$.lines)==null?void 0:S.length)&&e.jsx("g",{transform:"translate(".concat((c+5)*g,",0)"),children:e.jsx(qe,{osysiInfos:t[2].lines,direction:r.direction})})]})]})},Ge=w.forwardRef(function(s,t){const{stnName:n,oneLine:a,directionPolarity:l,...o}=s,i=w.useRef(null),[c,h]=w.useState(0);w.useEffect(()=>{a&&i.current?h(i.current.getBBox().width+5):h(0)},[...n,a]);const[g,d]=[20,8];return e.jsx("g",{ref:t,...o,children:w.useMemo(()=>e.jsxs(e.Fragment,{children:[e.jsx("g",{ref:i,children:n[0].split("\\").map((j,u,x)=>e.jsx("text",{className:"rmg-name__zh rmg-outline",dy:(x.length-1-u)*-g+(a?d:(n[1].split("\\").length-1)*-d),children:j},u))}),e.jsx("g",{fontSize:8,transform:"translate(".concat(c*l,",0)"),children:n[1].split("\\").map((j,u,x)=>e.jsx("text",{className:"rmg-name__en rmg-outline",dy:(x.length-2-u)*-d+2,children:j},u))})]}),[...n,a,c,l])})}),Ye=()=>{const{stn_list:r}=b(n=>n.param),s=new Set(Object.values(r).map(n=>n.services).flat()),t=[-1,35,50,75][s.size];return e.jsx("g",{transform:"translate(0, ".concat(t,")"),children:e.jsx("text",{className:"rmg-name__zh",fill:"red",textAnchor:"middle",children:"本站"})})},Ve=w.forwardRef(function(s,t){var c,h,g;const{groups:n,direction:a,...l}=s,o=[...n[0].lines||[],...((c=n[1])==null?void 0:c.lines)||[],...((g=(h=n[2])==null?void 0:h.lines)==null?void 0:g.filter(d=>!!d.name[0].match(/^磁(悬)*浮/)))||[]];let i=0;return e.jsx("g",{ref:t,fontSize:14,textAnchor:"middle",...l,children:o.map((d,j)=>{const u=!!d.name[0].match(/^\w+(号)?线/),x=!!d.name[0].match(/^磁(悬)*浮/);s.direction==="r"&&(i-=(u||x?20:d.name[0].length*14+12)+(j===0?0:5));let f;return x?f=e.jsx("g",{transform:"translate(".concat(i,",-16)scale(0.1428571429)"),children:e.jsx(Xe,{info:d})},j):u?f=e.jsx("g",{transform:"translate(".concat(i,",0)"),children:e.jsx(Je,{info:d})},j):f=e.jsx("g",{transform:"translate(".concat(i,",0)"),children:e.jsx(Ze,{info:d})},j),s.direction==="l"&&(i+=u||x?25:d.name[0].length*14+12+5),f})})}),Xe=w.memo(function(s){var t,n;return e.jsx(e.Fragment,{children:e.jsx("use",{xlinkHref:"#intbox_maglev",fill:(t=s.info.theme)==null?void 0:t[2],stroke:(n=s.info.theme)==null?void 0:n[2]})})},(r,s)=>JSON.stringify(r.info)===JSON.stringify(s.info)),Je=w.memo(function(s){var t,n,a;return e.jsxs(e.Fragment,{children:[e.jsx("use",{xlinkHref:"#intbox_number",fill:(t=s.info.theme)==null?void 0:t[2]}),e.jsx("text",{x:10,className:"rmg-name__zh",fill:(n=s.info.theme)==null?void 0:n[3],dominantBaseline:"central",children:(a=s.info.name[0].match(/(\d*)\w+/))==null?void 0:a[0]})]})},(r,s)=>JSON.stringify(r.info)===JSON.stringify(s.info)),Ze=w.memo(function(s){var n,a;const t=s.info.name[0].split("\\")[0].length;return e.jsxs(e.Fragment,{children:[e.jsx("rect",{height:22,width:t*14+12,y:-11,fill:(n=s.info.theme)==null?void 0:n[2]}),e.jsx("text",{x:t*7+6,className:"rmg-name__zh",fill:(a=s.info.theme)==null?void 0:a[3],dominantBaseline:"central",children:s.info.name[0].split("\\")[0]})]})},(r,s)=>JSON.stringify(r.info)===JSON.stringify(s.info)),Ue=r=>{const s=r.osiInfos.map(t=>t.name[0]).join("，");return w.useMemo(()=>e.jsxs("g",{textAnchor:"middle",fontSize:"50%",children:[e.jsx("text",{className:"rmg-name__zh",dy:-5,children:"换乘".concat(s)}),e.jsx("text",{className:"rmg-name__zh",dy:5,children:"仅限公共交通卡"}),e.jsx("text",{className:"rmg-name__en",dy:12.5,fontSize:"75%",children:"Only for Public Transportation Card"})]}),[s.toString()])},qe=r=>{const s=r.osysiInfos.map(n=>n.name[0]).join("，"),t=r.osysiInfos.map(n=>n.name[1]).join(", ");return w.useMemo(()=>e.jsxs("g",{textAnchor:r.direction==="l"?"start":"end",fontSize:"50%",children:[e.jsxs("text",{className:"rmg-name__zh",dy:3,children:["转乘",s]}),e.jsxs("text",{className:"rmg-name__en",dy:10,fontSize:"75%",children:["To ",t]})]}),[JSON.stringify(r.osysiInfos),r.direction])},Ke=["shanghai","sh4","#5F259F","#fff","4号线","Line 4"],Qe=r=>{const{xs:s,servicesPresent:t,stnStates:n}=r,{svg_height:a,direction:l,stn_list:o,current_stn_idx:i,branchSpacingPct:c,info_panel_type:h,coline:g}=b(v=>v.param),{branches:d,depsStr:j}=b(v=>v.helper),u=w.useMemo(()=>(console.log("computing y shares"),Object.keys(o).reduce((v,k)=>{if(d[0].includes(k))return{...v,[k]:0};{const y=d.slice(1).filter(N=>N.includes(k))[0];return{...v,[k]:o[y[0]].children.indexOf(y[1])?-3:3}}},{})),[j]),x=Object.entries(u).filter(([v,k])=>k<=0).reduce((v,[k,y])=>({...v,[k]:y}),{}),f=Object.keys(x).reduce((v,k)=>({...v,[k]:-x[k]*c*a/300}),{}),m=w.useMemo(()=>Ee(R(Object.values(g).filter(v=>v.display),d),n),[JSON.stringify(g),i,l,j]),p=t.reduce((v,k)=>({...v,[k]:Object.keys(m).reduce((y,N)=>({...y,[N]:m[N].map(O=>({path:ye(O.linePath,N,s,f,l,k,t.length,o,"diagonal"),colors:O.colors})).filter(O=>O.path!=="")}),{})}),{}),_=R(Object.values(g).filter(v=>v.display),d).map(v=>v.linePath).flat(),$=12,S=h==="sh2020"?3:0;return e.jsx(e.Fragment,{children:e.jsxs("g",{id:"coline",transform:"translate(0,".concat($+S,")"),children:[e.jsx(et,{paths:p,direction:l}),e.jsx(tt,{colineStns:m,branches:d,xs:s,ys:f,stnStates:n,lineWidth:$,colineGap:S}),e.jsx(nt,{stnIds:Object.entries(u).filter(([v,k])=>k<0).reduce((v,[k,y])=>[...v,k],[]).filter(v=>!["linestart","lineend"].includes(v)).filter(v=>o[v].services.length!==0).filter(v=>_.includes(v)),xs:s,ys:f,stnStates:n})]})})},et=r=>{const{paths:s,direction:t}=r;return e.jsx(e.Fragment,{children:Object.keys(s).map((n,a)=>{var l,o;return e.jsx("g",{transform:"translate(0,".concat(a*25,")"),children:e.jsxs("g",{children:[(l=s[n])==null?void 0:l.pass.map((i,c)=>e.jsx(w.Fragment,{children:e.jsx("path",{stroke:"var(--rmg-grey)",strokeWidth:12,fill:"none",d:i.path,strokeLinejoin:"round",filter:n===D.local?void 0:"url(#contrast-".concat(n,")")},c)},c)),(o=s[n])==null?void 0:o.main.map((i,c)=>{var h;return e.jsxs(w.Fragment,{children:[i.colors.length>1&&e.jsx("linearGradient",{id:"grad".concat(c),y1:"-100%",y2:"100%",x1:"0",x2:"0",gradientUnits:"userSpaceOnUse",children:i.colors.map((g,d)=>e.jsxs(w.Fragment,{children:[e.jsx("stop",{offset:"".concat(100/i.colors.length*(d+0),"%"),stopColor:g[2]}),e.jsx("stop",{offset:"".concat(100/i.colors.length*(d+1),"%"),stopColor:g[2]})]},d))}),t==="l"&&e.jsx("marker",{id:"arrow_left_".concat(c,"_").concat(i.colors.map(g=>g[2]).join("_")),refY:.5,refX:1,children:e.jsx("path",{d:"M1,0L0,1H1z",fill:i.colors.length>1?"url(#grad".concat(c,")"):i.colors[0][2]})}),t==="r"&&e.jsx("marker",{id:"arrow_right_".concat(c,"_").concat(i.colors.map(g=>g[2]).join("_")),refY:.5,children:e.jsx("path",{d:"M0,0L1,1H-1z",fill:i.colors.length>1?"url(#grad".concat(c,")"):i.colors[0][2]})}),e.jsx("path",{stroke:((h=i.colors.at(-1))!=null?h:Ke)[2],strokeWidth:12,fill:"none",d:i.path,markerStart:t==="l"?"url(#arrow_left_".concat(c,"_").concat(i.colors.map(g=>g[2]).join("_"),")"):void 0,markerEnd:t==="r"?"url(#arrow_right_".concat(c,"_").concat(i.colors.map(g=>g[2]).join("_"),")"):void 0,strokeLinejoin:"round",filter:n===D.local?void 0:"url(#contrast-".concat(n,")")},c)]},c)})]})},"servicePath".concat(a))})})},tt=r=>{const{colineStns:s,branches:t,xs:n,ys:a,stnStates:l,lineWidth:o,colineGap:i}=r,{line_name:c,theme:h,info_panel_type:g}=b(j=>j.param),d=[...s.main,...s.pass].map(j=>j.linePath.map(u=>{var x;return{curStn:u,x:n[u],y:a[u],color:(x=j.colors.at(-1))!=null?x:[...h,...c]}})).flat().reduce((j,u)=>j.find(x=>x.curStn===u.curStn)?j:j.concat(u),[]).filter(j=>t[0].includes(j.curStn));return console.log(d),e.jsx("g",{id:"stations_in_mainline",children:d.map(j=>{const{curStn:u,x,y:f,color:m}=j,p=(l[u]===-1?0:o)+i+o,_=(l[u]===-1?0:-o)-i-o/2;return e.jsx("g",{transform:"translate(".concat(x,",").concat(f,")"),children:g==="sh2020"?e.jsx("rect",{stroke:"none",height:p,width:12,x:-6,y:_,fill:l[u]===-1?"var(--rmg-grey)":m[2]}):e.jsx("use",{xlinkHref:"#int2_sh",stroke:"var(--rmg-theme-colour)",transform:"translate(0,".concat(-o,")")})},u)})})},nt=r=>{const{xs:s,ys:t,stnStates:n,stnIds:a}=r,{branches:l,depsStr:o}=b(j=>j.helper),{line_name:i,theme:c,coline:h}=b(j=>j.param),g=w.useMemo(()=>R(Object.values(h),l),[JSON.stringify(h),o]),d=a.reduce((j,u)=>{var x;return{...j,[u]:(x=g.filter(f=>f.linePath.includes(u)).map(f=>f.colors).flat().at(0))!=null?x:[...c,...i]}},{});return e.jsx("g",{id:"stations_in_coline",children:a.map(j=>e.jsx("g",{transform:"translate(".concat(s[j],",").concat(t[j],")"),children:e.jsx(K,{stnId:j,stnState:n[j],color:d[j][2]})},j))})},st=()=>{const{routes:r,branches:s,depsStr:t}=b(y=>y.helper),n=b(y=>y.param),{svg_height:a,stn_list:l,branchSpacingPct:o,coline:i,direction:c}=b(y=>y.param),h=pe(n.stn_list,()=>0,()=>0),g=J("linestart","lineend",h),d=J(g.nodes[1],g.nodes.slice(-2)[0],h),j=w.useMemo(()=>(console.log("computing x shares"),Object.keys(n.stn_list).reduce((y,N)=>({...y,[N]:je(N,h,s)}),{})),[s.toString(),JSON.stringify(h)]),u=[n.svgWidth.railmap*n.padding/100,n.svgWidth.railmap*(1-n.padding/100)],x=Object.keys(j).reduce((y,N)=>({...y,[N]:u[0]+j[N]/d.len*(u[1]-u[0])}),{}),f=w.useMemo(()=>(console.log("computing y shares"),Object.keys(l).reduce((y,N)=>{if(s[0].includes(N))return{...y,[N]:0};{const O=s.slice(1).filter(M=>M.includes(N))[0];return{...y,[N]:l[O[0]].children.indexOf(O[1])?-3:3}}},{})),[t]),m=Object.entries(f).filter(([,y])=>y>=0).reduce((y,[N,O])=>({...y,[N]:O}),{}),p=Object.keys(m).reduce((y,N)=>({...y,[N]:-m[N]*o*a/300}),{}),_=w.useMemo(()=>_e(n.current_stn_idx,r,n.direction),[n.current_stn_idx,n.direction,r.toString()]),$=Object.values(D),S=Object.values(n.stn_list).map(y=>y.services).flat().reduce((y,N)=>(y[$.indexOf(N)]=!0,y),[!1,!1,!1]).map((y,N)=>[$[N],y]).filter(y=>y[1]).map(y=>y[0]),v=s.map(y=>ue(y,_)).reduce((y,N)=>(y.main.push(N.main),y.pass.push(N.pass),y),{main:[],pass:[]}),k=S.reduce((y,N)=>({...y,[N]:Object.keys(v).reduce((O,M)=>({...O,[M]:v[M].map(H=>ye(H,M,x,p,c,N,S.length,l)).filter(H=>H!=="")}),{})}),{});return e.jsxs("g",{id:"main",transform:"translate(0,".concat(n.svg_height*(Object.keys(i).length>0?.5:.7+.1),")"),children:[e.jsx(rt,{paths:k,direction:n.direction}),e.jsx(lt,{stnIds:Object.keys(m).filter(y=>!["linestart","lineend"].includes(y)).filter(y=>l[y].services.length!==0),xs:x,ys:p,stnStates:_}),Object.keys(i).length>0&&e.jsx(Qe,{xs:x,servicesPresent:S,stnStates:_}),S.length>1&&e.jsx(at,{servicesLevel:S,lineXs:u})]})},rt=r=>{const{theme:s}=b(a=>a.param),{paths:t,direction:n}=r;return e.jsx(e.Fragment,{children:Object.keys(t).map((a,l)=>{var o,i;return e.jsxs("g",{transform:"translate(0,".concat(l*25,")"),filter:s[2]==="#B5B5B6"?"url(#pujiang_outline)":void 0,children:[e.jsx("g",{children:(o=t[a])==null?void 0:o.pass.map((c,h)=>e.jsx("path",{stroke:"var(--rmg-grey)",strokeWidth:12,fill:"none",d:c,markerStart:r.direction==="l"?"url(#arrow_gray)":void 0,markerEnd:r.direction==="r"?"url(#arrow_gray)":void 0,strokeLinejoin:"round"},h))}),e.jsx("g",{children:(i=t[a])==null?void 0:i.main.map((c,h)=>e.jsx("path",{stroke:"var(--rmg-theme-colour)",strokeWidth:12,fill:"none",d:c,markerStart:n==="l"?"url(#arrow_theme_left)":void 0,markerEnd:n==="r"?"url(#arrow_theme_right)":void 0,strokeLinejoin:"round",filter:a===D.local?void 0:"url(#contrast-".concat(a,")")},h))})]},"servicePath".concat(l))})})},ye=(r,s,t,n,a,l,o,i,c="rightangle")=>{let[h,g]=[];const d={},j={local:0,express:20,direct:40}[l],u=o>1?50:0;let x=30;if(r.length>0){let m=!1,p=!1;i[r.at(-1)||0].children.some(_=>["linestart","lineend"].includes(_))?p=!0:i[r.at(0)||0].parents.some(_=>["linestart","lineend"].includes(_))&&(m=!0),x=m||p?x:0}const f=30;if(r.forEach(m=>{const p=t[m],_=n[m];if(!h&&h!==0){[g,h]=[p,_],d.start=[p,_];return}_===0?_!==h&&(d.bifurcate=[g,h]):_!==h&&(d.bifurcate=[p,_]),d.end=[p,_],[g,h]=[p,_]}),"start"in d)if("end"in d)if("bifurcate"in d){const[m,p]=d.start,_=d.bifurcate[0],[$,S]=d.end;return s==="main"?a==="l"?S>p?(console.log(d),c==="rightangle"?"M ".concat(m-x,",").concat(p," H ").concat($," V ").concat(S):"M ".concat(m,",").concat(p," H ").concat(m+f," L ").concat(_-f,",").concat(S," H ").concat($)):c==="rightangle"?"M ".concat(m,",").concat(p," V ").concat(S," H ").concat($):"M ".concat(m-x,",").concat(p," H ").concat(_+f," L ").concat($-f,",").concat(S," H ").concat($):S>p?c==="rightangle"?"M ".concat(m,",").concat(p," H ").concat($," V ").concat(S):"M ".concat(m,",").concat(p," H ").concat(m+f," L ").concat(_-f,",").concat(S," H ").concat($+x):c==="rightangle"?"M ".concat(m,",").concat(p," V ").concat(S," H ").concat($+x):"M ".concat(m,",").concat(p," H ").concat(_+f," L ").concat($-f,",").concat(S," H ").concat($):S>p?c==="rightangle"?"M ".concat(m-x,",").concat(p," H ").concat($," V ").concat(S):"M ".concat(m,",").concat(p," H ").concat(m+f," L ").concat(_-f,",").concat(S," H ").concat($+x):c==="rightangle"?"M ".concat(m,",").concat(p," V ").concat(S," H ").concat($+x):"M ".concat(m-x,",").concat(p," H ").concat(_+f," L ").concat($-f,",").concat(S," H ").concat($)}else{const[m,p]=d.start,_=d.end[0];return s==="main"?a==="l"?"M ".concat(m-x-j,",").concat(p," H ").concat(_):"M ".concat(m,",").concat(p," H ").concat(_+x+j):a==="l"?"M ".concat(m-x,",").concat(p," H ").concat(_+x+u):"M ".concat(m-x-u,",").concat(p," H ").concat(_+x)}else{const[m,p]=d.start;return s==="main"?a==="l"?"M ".concat(m-x-j,",").concat(p," H ").concat(m):"M ".concat(m,",").concat(p," H ").concat(m+x+j):a==="l"?"M ".concat(m,",").concat(p," L ").concat(m+x+u,",").concat(p):"M ".concat(m-x-u,",").concat(p," L ").concat(m,",").concat(p)}else return""},lt=r=>{const{xs:s,ys:t,stnStates:n,stnIds:a}=r;return e.jsx("g",{children:a.map(l=>e.jsx("g",{transform:"translate(".concat(s[l],",").concat(t[l],")"),children:e.jsx(K,{stnId:l,stnState:n[l]})},l))})},at=r=>{const{svg_height:s,direction:t,svgWidth:n}=b(c=>c.param),a=-s+130,l=r.servicesLevel.map(c=>({local:"普通车",express:"大站车",direct:"直达车"})[c]),o=t==="r"?r.lineXs[0]-42:r.lineXs[1]+42,i=r.servicesLevel.length===2?350:500;return w.useMemo(()=>e.jsxs("g",{children:[l.map((c,h)=>e.jsxs("g",{transform:"translate(".concat(o,",").concat(h*25,")"),children:[e.jsx("rect",{x:-27.5,height:10,width:55,fill:"white",stroke:"black",y:-5}),e.jsx("text",{className:"rmg-name__zh",fontSize:9,y:3,textAnchor:"middle",children:"".concat(c,"运行线")})]},c)),e.jsxs("g",{transform:"translate(".concat(t==="r"?30:n.railmap-i,",").concat(a,")"),children:[e.jsx("text",{className:"rmg-name__zh",children:"图例："}),l.map((c,h)=>e.jsxs("g",{transform:"translate(".concat(h*150+50,",0)"),children:[e.jsx("line",{x1:"0",x2:"35",y1:"-5",y2:"-5",stroke:"var(--rmg-theme-colour)",strokeWidth:"12",filter:h===2?"url(#contrast-direct)":h===1?"url(#contrast-express)":""}),e.jsx("use",{x:"17.5",y:"-5",xlinkHref:"#stn_sh",fill:"var(--rmg-theme-colour)"}),e.jsx("text",{x:"40",className:"rmg-name__zh",children:"".concat(c,"停靠站")})]},"serviceLevel".concat(h)))]})]}),[s,t,n,r.servicesLevel,r.lineXs])},it=()=>{const{direction:r,svgWidth:s,coline:t}=b(a=>a.param),n=!!Object.keys(t).length;return w.useMemo(()=>e.jsxs("g",{transform:"translate(".concat(r==="l"?50:s.railmap-150,",50)"),children:[e.jsx("text",{className:"rmg-name__zh",children:"列车前进方向"}),e.jsx("path",{d:"M60,60L0,0L60-60H100L55-15H160V15H55L100,60z",stroke:n?"var(--rmg-black)":void 0,strokeWidth:n?5:void 0,fill:n?"var(--rmg-white)":"var(--rmg-theme-colour)",transform:"translate(".concat(r==="l"?-30:125,",-5)rotate(").concat(r==="l"?0:180,")scale(0.15)")})]}),[r,t,s.railmap])},te=r=>{var h,g;const{stnId:s,nameDirection:t,services:n,color:a}=r,l=b(d=>d.param.stn_list[s]),o=[...((h=l.transfer.groups[0])==null?void 0:h.lines)||[],...((g=l.transfer.groups[1])==null?void 0:g.lines)||[]];let i;l.services.length===3?i="direct_indoor_sh":l.services.length===2?i="express_indoor_sh":o.length>0?i="int2_indoor_sh":i="stn_indoor_sh";const c=t==="left"||t==="right"?90:0;return e.jsxs(e.Fragment,{children:[e.jsx(ot,{name:l.name,groups:l.transfer.groups,nameDirection:t,services:n}),e.jsx("use",{xlinkHref:"#".concat(i),stroke:o.length>0?"var(--rmg-black)":a!=null?a:"var(--rmg-theme-colour)",transform:"rotate(".concat(c,")")}),l.services.length>1&&e.jsx("text",{className:"rmg-name__zh",writingMode:"tb",fontSize:"60%",dy:"-12",children:"大站车".concat(l.services.length>2?" 直达车":"","停靠")})]})},ot=r=>{var j,u,x,f,m,p,_,$,S,v,k,y,N,O,M,H,z,P,W,E,T,G,Y,X,V,I,B,C,F,ne,se,re,le,ae,ie;const{name:s,groups:t,nameDirection:n,services:a}=r,l={upward:60,downward:-30,left:0,right:0}[n],o=(u=(j=t[2])==null?void 0:j.lines)!=null&&u.length?{upward:0,downward:0,left:(((x=t[0].lines)==null?void 0:x.length)||0)+(((m=(f=t[1])==null?void 0:f.lines)==null?void 0:m.length)||0)!==0?85:25,right:(((p=t[0].lines)==null?void 0:p.length)||0)+((($=(_=t[1])==null?void 0:_.lines)==null?void 0:$.length)||0)!==0?-85:-25}[n]:0,i=(v=(S=t[2])==null?void 0:S.lines)!=null&&v.length?{upward:(y=(k=t[0])==null?void 0:k.lines)!=null&&y.length&&((O=(N=t[1])==null?void 0:N.lines)!=null&&O.length)?-210:(H=(M=t[0])==null?void 0:M.lines)!=null&&H.length||(P=(z=t[1])==null?void 0:z.lines)!=null&&P.length?-177.5:-145,downward:((E=(W=t[0])==null?void 0:W.lines)!=null&&E.length&&((G=(T=t[1])==null?void 0:T.lines)!=null&&G.length)?185:(Y=t[0].lines)!=null&&Y.length||(V=(X=t[1])==null?void 0:X.lines)!=null&&V.length?157.5:125)+(a.length===3?40:0),left:(B=(I=t[1])==null?void 0:I.lines)!=null&&B.length?-60:(C=t[0].lines)!=null&&C.length?-30:0,right:(ne=(F=t[1])==null?void 0:F.lines)!=null&&ne.length?-60:(se=t[0].lines)!=null&&se.length?-30:0}[n]:0,c=w.useRef(null),h=60,[g,d]=w.useState(h);return w.useEffect(()=>{c!=null&&c.current&&d(Math.max(h,c.current.getBBox().width))},[...s]),e.jsxs("g",{transform:"translate(0,".concat(l,")"),children:[n==="upward"||n==="downward"?e.jsxs(e.Fragment,{children:[e.jsx("line",{x1:-g/2,x2:g/2,y1:n==="upward"?-23:-10,y2:n==="upward"?-23:-10,stroke:"black"}),e.jsx("line",{y1:n==="upward"?-23:-10,y2:n==="upward"?-48:20,stroke:"black"})]}):e.jsxs(e.Fragment,{children:[e.jsx("line",{x1:n==="left"?-50:15,x2:n==="left"?-15:50,y1:0,y2:0,stroke:"black"}),e.jsx("line",{x1:n==="left"?-50:50,x2:n==="left"?-50:50,y1:-30,y2:30,stroke:"black"})]}),[...t[0].lines||[],...((re=t[1])==null?void 0:re.lines)||[]].length&&e.jsx(ht,{intInfos:[t[0].lines||[],((le=t[1])==null?void 0:le.lines)||[]],arrowDirection:n,services:a}),e.jsx(ct,{ref:c,stnName:s,nameDirection:n,fill:"black"}),((ie=(ae=t[2])==null?void 0:ae.lines)==null?void 0:ie.length)&&e.jsx("g",{transform:"translate(".concat(o,",").concat(i,")"),children:e.jsx(dt,{osysiInfos:t[2].lines,nameDirection:n})})]})},ct=w.forwardRef(function(s,t){const{stnName:n,nameDirection:a,...l}=s,o=n[0].split("\\"),i=n[1].split("\\").length,c={upward:0,downward:0,left:-60,right:60}[a],h={upward:-2,downward:-30-12*(i-1),left:-10*(i-1),right:-10*(i-1)}[a],g={upward:"middle",downward:"middle",left:"end",right:"start"}[a];return e.jsx("g",{ref:t,...l,textAnchor:g,transform:"translate(".concat(c,",").concat(h,")"),children:w.useMemo(()=>e.jsxs(e.Fragment,{children:[o.map((d,j,u)=>e.jsx("text",{className:"rmg-name__zh",dy:a==="upward"?16*j:(u.length-1-j)*-16,children:d},j)),e.jsx("g",{fontSize:9.6,children:n[1].split("\\").map((d,j)=>e.jsx("text",{className:"rmg-name__en",dy:12*(j+1)+(a==="upward"&&o.length>1?o.length*7.5:0),children:d},j))})]}),[...n])})}),ht=r=>{var m,p,_,$,S,v,k,y,N;const{intInfos:s,arrowDirection:t,services:n}=r,a=s.flatMap(O=>O.map(M=>{var H;return(H=M.theme)==null?void 0:H[2]})).reduce((O,M)=>O+M,""),l=s.map(O=>[O.filter(M=>M.name[0].match(/^\d+.*$/)).map(M=>M.name[0].replace(/^(\d+)(.*)$/,"$1")).join("，").concat("号线"),O.filter(M=>!M.name[0].match(/^\d+.*$/)).map(M=>M.name[0]).join("，")].filter(M=>M&&M!=="号线").join("，")),o=s.map(O=>["Line ".concat(O.filter(M=>/^(L|l)ine \d+$/.test(M.name[1])).map(M=>M.name[1].replace("Line","").replace("line","").trim()).join(",")),O.filter(M=>!/^(L|l)ine \d+$/.test(M.name[1])).map(M=>M.name[1]).join(", ")].filter(M=>M&&M!=="Line ").join(", ")),i=n.length===3?80:45,c={upward:-145,downward:125+(n.length===3?40:0),left:7,right:7}[t],h={upward:0,downward:0,left:20,right:-20}[t],g={upward:-74,downward:44,left:0,right:0}[t],d={upward:0,downward:180,left:90,right:-90}[t],j={upward:0,downward:0,left:85,right:-85}[t],u={upward:"middle",downward:"middle",left:"start",right:"end"}[t],x=j,f={upward:(p=(m=s.at(0))==null?void 0:m.length)!=null&&p?-177.5:-145,downward:(($=(_=s.at(0))==null?void 0:_.length)!=null&&$?157.5:125)+(n.length===3?40:0),left:-30,right:-30}[t];return console.log(s),console.log(l,o),e.jsxs("g",{children:[e.jsx("path",{id:"int_indoor_arrow_sh",stroke:"var(--rmg-black)",strokeWidth:1,transform:"translate(".concat(h,",").concat(g,")rotate(").concat(d,")"),fill:s.flat().length===1?(S=s.flat()[0].theme)==null?void 0:S[2]:"url(#grad".concat(a,")"),d:"M -7.5,0 v -".concat(i," h -7.5 l 15,-15 l 15,15 h -7.5 v ").concat(i," Z")}),s.flat().length>1&&e.jsx("linearGradient",{id:"grad".concat(a),y1:"0",y2:"0",x1:t==="upward"?"25%":"75%",x2:t==="upward"?"75%":"25%",children:s.flat().map((O,M)=>{var H,z;return e.jsxs(w.Fragment,{children:[e.jsx("stop",{offset:"".concat(100/s.flat().length*M,"%"),stopColor:(H=O.theme)==null?void 0:H[2]}),e.jsx("stop",{offset:"".concat(100/s.flat().length*(M+1),"%"),stopColor:(z=O.theme)==null?void 0:z[2]})]},M)})}),((k=(v=s.at(0))==null?void 0:v.length)!=null?k:0)>0&&e.jsxs("g",{transform:"translate(".concat(j,",").concat(c,")"),textAnchor:"".concat(u),children:[e.jsx("text",{className:"rmg-name__zh",dy:-7,children:"换乘".concat(l[0])}),e.jsx("text",{className:"rmg-name__en",dy:5,fontSize:9.6,children:"Interchange ".concat(o[0])})]}),((N=(y=s.at(1))==null?void 0:y.length)!=null?N:0)>0&&e.jsxs("g",{transform:"translate(".concat(x,",").concat(f,")"),textAnchor:"".concat(u),children:[e.jsx("text",{className:"rmg-name__zh",dy:-7,children:"出站换乘".concat(l[1])}),e.jsx("text",{className:"rmg-name__en",dy:5,fontSize:9.6,children:"Out-of-station Transfer ".concat(o[1])})]})]})},dt=r=>{const s={upward:"middle",downward:"middle",left:"start",right:"end"}[r.nameDirection];return w.useMemo(()=>e.jsxs("g",{textAnchor:"".concat(s),children:[e.jsx("text",{className:"rmg-name__zh",dy:-5,children:"转乘".concat(r.osysiInfos.map(t=>t.name[0]).join("，"))}),e.jsx("text",{className:"rmg-name__en",dy:7.5,fontSize:9.6,children:"To ".concat(r.osysiInfos.map(t=>t.name[1]).join(", "))})]}),[JSON.stringify(r.osysiInfos),r.nameDirection])},mt=(r,s,t,n,a,l)=>{var j,u,x,f;const o=r[0].filter(m=>!["linestart","lineend"].includes(m)),i=r.slice(1,3).map(m=>m.slice(1,m.length-1)),c=i.reduce((m,p)=>m+p.filter(_=>!["linestart","lineend",...s].includes(_)).length,0)+o.length-l-a*2,h=(t-t*n/100*2)/(1+c),g=[t*n/100+((j=i.at(0))!=null?j:[]).length*h,t*(1-n/100)-((u=i.at(1))!=null?u:[]).length*h],d={...Object.fromEntries(((x=i.at(0))!=null?x:[]).map((m,p)=>[m,t*n/100+p*h])),...Object.fromEntries(((f=i.at(1))!=null?f:[]).map((m,p)=>[m,g[1]+(1+p)*h]))};return{loop_branches:i,line_xs_branches:g,xs_branches:d}},gt=r=>{var _,$,S,v;const{loop_branches:s,edges:t,xs:n,ys:a,canvas:l}=r,[o,i,c,h]=t,{branches:g}=b(k=>k.helper),{current_stn_idx:d,direction:j,coline:u}=b(k=>k.param),x=l===L.RailMap?30:0,f=["M ".concat(o,",").concat(c," H ").concat(Number(n[($=(_=s.at(0))==null?void 0:_.at(0))!=null?$:""])-x),"M ".concat(i,",").concat(c," H ").concat(Number(n[(v=(S=s.at(1))==null?void 0:S.at(-1))!=null?v:""])+x)],m=g[0].filter(k=>!["linestart","lineend"].includes(k)),p=Object.values(u).filter(k=>![k.from,k.to].every(y=>m.includes(y))).map(k=>k.colors);return e.jsx(e.Fragment,{children:s.map((k,y)=>{var N,O,M;return e.jsxs(Q.Fragment,{children:[p.filter((H,z,P)=>z===P.findIndex(W=>{var E,T;return((E=W.at(0))==null?void 0:E.at(2))===((T=H.at(0))==null?void 0:T.at(2))})).map(H=>e.jsx("marker",{id:"arrow_theme_".concat(H[0][2]),refX:1,refY:.5,children:e.jsx("path",{d:"M0,1H2L1,0z",fill:H[0][2]})},H[0][2])),e.jsx("path",{stroke:(M=(O=(N=p.at(y))==null?void 0:N.at(0))==null?void 0:O.at(2))!=null?M:"var(--rmg-theme-colour)",strokeWidth:12,fill:"none",d:f[y],markerEnd:l===L.RailMap&&(j==="l"&&y===0||j==="r"&&y===1)?p.at(y)?"url(#arrow_theme_".concat(p[y][0][2],")"):"url(#arrow_theme)":void 0}),k.filter(H=>!["linestart","lineend"].includes(H)).map(H=>{var z,P,W,E;return e.jsxs(Q.Fragment,{children:[l===L.RailMap&&e.jsx("g",{transform:"translate(".concat(n[H],",").concat(a[H],")"),children:e.jsx(K,{stnId:H,stnState:d===H?0:1,bank:0,direction:j,color:(P=(z=p.at(y))==null?void 0:z.at(0))==null?void 0:P.at(2)})},H),l===L.Indoor&&e.jsx("g",{transform:"translate(".concat(n[H],",").concat(a[H],")"),children:e.jsx(te,{stnId:H,nameDirection:s.filter(T=>T.includes(H)).map(T=>T.indexOf(H)%2===0?"downward":"upward")[0],services:[D.local],color:(E=(W=p.at(y))==null?void 0:W.at(0))==null?void 0:E.at(2)})},H)]},H)})]},k.at(0))})})},xt=r=>{var p;const{edges:s,loop_stns:t,xs:n,ys:a,canvas:l}=r,[o,i,c,h]=s,{info_panel_type:g,stn_list:d,coline:j}=b(_=>_.param),{branches:u}=b(_=>_.helper),x=Object.values(j).filter(_=>[_.from,_.to].every($=>u.slice(1,3).filter(S=>U(S,d)).flat().includes($))).map(_=>_.colors).at(0),f=12,m=l===L.RailMap&&g==="sh2020"?3:0;return e.jsxs("g",{id:"coline_main",children:[e.jsx("path",{d:"M ".concat(o,",").concat(c," H").concat(i),strokeWidth:12,stroke:(p=x==null?void 0:x.at(0))==null?void 0:p.at(2)}),l===L.RailMap&&Object.keys(j).length>0&&t.top.map(_=>{var $;return e.jsx("g",{transform:"translate(".concat(n[_],",").concat(a[_],")"),children:g==="sh2020"?e.jsxs(e.Fragment,{children:[e.jsx("rect",{stroke:"none",height:24,width:12,x:-6,y:-m-1,fill:($=x==null?void 0:x.at(0))==null?void 0:$.at(2)}),e.jsx("rect",{stroke:"none",height:m+f,width:12,x:-6,y:f-2,fill:"var(--rmg-theme-colour)"})]}):e.jsx("use",{xlinkHref:"#int2_sh",stroke:"var(--rmg-theme-colour)",transform:"translate(0,".concat(1+f,")")})},_)})]})},Se=r=>{var V;const{bank_angle:s,canvas:t}=r,{branches:n}=b(I=>I.helper),{current_stn_idx:a,svgWidth:l,svg_height:o,padding:i,branchSpacingPct:c,direction:h,info_panel_type:g,stn_list:d,loop_info:{left_and_right_factor:j,bottom_factor:u},coline:x}=b(I=>I.param),f=n[0].filter(I=>!["linestart","lineend"].includes(I)),m=n.slice(0,3).flat().filter((I=>B=>(I[B]=(I[B]||0)+1)===2)({})).filter(I=>!["linestart","lineend"].includes(I)),p=(V=Object.values(x).filter(I=>[I.from,I.to].every(B=>n.slice(1,3).filter(C=>U(C,d)).flat().includes(B))).map(I=>{const B=f.findIndex(F=>F===I.from),C=f.findIndex(F=>F===I.to);return Math.abs(C-B)>f.length-2-Math.abs(C-B)?"major":"minor"}).at(0))!=null?V:"minor",_=m.at(1)?we(f,m,j,p):m.at(0)?$e(f,m[0],u,j):ke(f,a,u,j),{x_shares:$,y_shares:S}=Me(f,_),{loop_branches:v,line_xs_branches:k,xs_branches:y}=mt(n,m,l[t],i,j,_.bottom.length),N={...S,...Object.fromEntries(v.flat().map(I=>[I,0]))},O=c*o/300,M=[225+O,o-75-(t===L.RailMap?0:125)-O],H=Object.keys(N).reduce((I,B)=>({...I,[B]:M[0]+N[B]*(M[1]-M[0])}),{}),z=[Math.max(l[t]*i/100+(s&&t===L.RailMap?100:0),k[0]),Math.min(l[t]*(1-i/100)-(s&&t===L.RailMap?100:0),k[1])],P=Object.keys($).reduce((I,B)=>({...I,[B]:z[0]+$[B]*(z[1]-z[0])}),{}),W=s?{l:1,r:-1}[h]:0;[..._.right,..._.left].forEach(I=>{P[I]-=(H[I]-M[0])*W}),_.bottom.forEach(I=>{P[I]-=(M[1]-M[0])*W});const E={...y,...P},T=ft(_,E,H,W,[...z,...M],h),G=12,Y=t===L.RailMap&&g==="sh2020"?3:0;Object.keys(x).length>0&&_.top.forEach(I=>{H[I]-=Y+G});const X=v.length?0:(M[1]-M[0])*W/2;return e.jsxs("g",{id:"loop",transform:"translate(".concat(X,",0)"),children:[e.jsx("path",{stroke:"var(--rmg-theme-colour)",strokeWidth:12,fill:"none",d:T,strokeLinejoin:"round"}),t===L.RailMap&&e.jsx(ge,{canvas:t,loop_stns:_,xs:E,ys:H}),e.jsxs("g",{transform:"translate(0,".concat(Object.keys(x).length>0?-G-Y:0,")"),children:[e.jsx(gt,{loop_branches:v,edges:[...z,...M],xs:E,ys:H,canvas:t}),Object.keys(x).length>0&&e.jsx(xt,{edges:[...z,...M],loop_stns:_,xs:E,ys:H,canvas:t})]}),t===L.Indoor&&e.jsx(ge,{canvas:t,loop_stns:_,xs:E,ys:H})]})},ft=(r,s,t,n,a,l)=>{const[o,i,c,h]=a,g=(u,x,f,m,p)=>({right:[f+(m-c)*n,x],bottom:[u-(h-x)*n,m],left:[f-(h-m)*n,x],top:[u+(x-c)*n,m]})[p],d=[];r.top.forEach(u=>{d.push([s[u],t[u]])}),["right","bottom","left"].forEach(u=>{if(r[u].length>0)d.push(g(d.at(-1)[0],d.at(-1)[1],s[r[u][0]],t[r[u][0]],u)),r[u].forEach(x=>{d.push([s[x],t[x]])});else{const x={right:[i,d.at(-1)[1]],bottom:[d.at(-1)[0]+(h-d.at(-1)[1])*-n,d.at(-1)[1]+(h-d.at(-1)[1])],left:[o+(n===0?0:(h-c)*(l==="l"?-1:1)),d.at(-1)[1]]};d.push(x[u])}}),d.push(g(d.at(-1)[0],d.at(-1)[1],s[r.top[0]],t[r.top[0]],"top"));const j=d.slice(1).map(([u,x])=>"L".concat(u,",").concat(x," ")).join(" ");return"M".concat(d[0][0],",").concat(d[0][1]," ").concat(j," Z")},ge=r=>{const{canvas:s,loop_stns:t,xs:n,ys:a}=r,{current_stn_idx:l}=b(h=>h.param),o={top:0,bottom:0,left:-1,right:1},i={left:"r",right:"l",top:void 0,bottom:void 0},c=(h,g)=>({top:g%2===0?"upward":"downward",bottom:g%2===0?"upward":"downward",left:"left",right:"right"})[h];return e.jsxs("g",{id:"loop_stations",children:[s===L.RailMap&&Object.entries(t).map(([h,g])=>g.map(d=>e.jsx("g",{transform:"translate(".concat(n[d],",").concat(a[d],")"),children:e.jsx(K,{stnId:d,stnState:l===d?0:1,bank:o[h],direction:i[h]})},d))),s===L.Indoor&&Object.entries(t).map(([h,g])=>g.map((d,j)=>e.jsx("g",{transform:"translate(".concat(n[d],",").concat(a[d],")"),children:e.jsx(te,{stnId:d,nameDirection:c(h,j),services:[D.local]})},d)))]})},xe=L.RailMap;function ut(){const{canvasScale:r}=b(i=>i.app),{svgWidth:s,svg_height:t,theme:n,loop:a,loop_info:{bank:l}}=b(i=>i.param),o=s[xe];return e.jsxs(q,{type:xe,svgWidth:o,svgHeight:t,canvasScale:r,theme:n,children:[e.jsx(pt,{}),a?e.jsx(Se,{bank_angle:l,canvas:L.RailMap}):e.jsx(st,{}),e.jsx(it,{})]})}const pt=w.memo(function(){return e.jsxs("defs",{children:[e.jsx("circle",{id:"stn_sh",fill:"var(--rmg-white)",strokeWidth:2,r:5}),e.jsx("path",{id:"int2_sh",fill:"var(--rmg-white)",strokeWidth:2,d:"M -5,0 a 5,5 0 1 1 10,0 V10 a 5,5 0 1 1 -10,0Z"}),e.jsx("path",{id:"express_sh",fill:"var(--rmg-white)",strokeWidth:2,d:"M -5,0 a 5,5 0 1 1 10,0 V25 a 5,5 0 1 1 -10,0Z"}),e.jsx("path",{id:"direct_sh",fill:"var(--rmg-white)",strokeWidth:2,d:"M -5,0 a 5,5 0 1 1 10,0 V50 a 5,5 0 1 1 -10,0Z"}),e.jsx("rect",{id:"stn_sh_2020",stroke:"none",height:24,width:12,x:-6,y:-18}),e.jsx("rect",{id:"stn_sh_2020_express",stroke:"none",height:49,width:12,x:-6,y:-18}),e.jsx("rect",{id:"stn_sh_2020_direct",stroke:"none",height:74,width:12,x:-6,y:-18}),e.jsx("rect",{id:"intbox_number",height:22,width:20,y:-11}),e.jsxs("g",{id:"intbox_maglev",transform:"translate(-25,0)",children:[e.jsx("rect",{id:"maglev_5",height:144,width:130,y:"40",x:"30",strokeWidth:10}),e.jsx("path",{id:"maglev_3",fill:"var(--rmg-white)",d:"m90,55a40,5 0 0 0 -40,3a5,5 0 0 0 -5,5a5,60 0 0 0 -3,60a5,5 0 0 0 5,5l96,0a5,5 0 0 0 5,-5a5,60 0 0 0 -3,-60a5,5 0 0 0 -5,-5a40,5 0 0 0 -40,-3l-5,-10l-5,10"}),e.jsx("path",{id:"maglev_4",fill:"var(--rmg-white)",d:"m90,140l-40,0a10,5 0 0 1 -10,-5l0,25a10,15 0 0 0 10,15l15,0l0,-10l-15,0l0,-15l90,0l0,15l-15,0l0,10l15,0a10,15 0 0 0 10,-15l0,-25a10,5 0 0 1 -10,5l-50,0"}),e.jsx("rect",{id:"maglev_1",height:"25",width:"40",y:"80",x:"50"}),e.jsx("rect",{id:"maglev_2",height:"25",width:"40",y:"80",x:"100"})]}),e.jsxs("g",{id:"airport",transform:"scale(0.5)",children:[e.jsx("circle",{cx:"0",cy:"29.33899",r:"29.33899",fill:"var(--rmg-grey)"}),e.jsx("path",{id:"airport",d:"M28.9769,6.60134c1.711.013,3.111,2.53205,3.111,4.241v10.337s17.106,15.435,17.358,15.666a1.145,1.145,0,0,1,.488,1.152v2.833c0,.651-.451.61-.695.467-.334-.119-17.151-8.863-17.151-8.863-.004,1.458-.797,9.006-1.326,13.304,0,0,4.61,2.457,4.699,2.521.334.268.352.359.352.852v2.001c0,.477-.352.428-.51.324-.183-.062-5.693-1.921-5.693-1.921a2.56018,2.56018,0,0,0-.633-.127,2.31654,2.31654,0,0,0-.666.127s-5.477,1.859-5.672,1.921c-.185.104-.523.153-.523-.324v-2.001c0-.493.029-.584.367-.852.086-.064,4.678-2.521,4.678-2.521-.524-4.298-1.307-11.846-1.325-13.304,0,0-16.822,8.744-17.148,8.863-.217.143-.69.184-.69-.467v-2.833a1.16206,1.16206,0,0,1,.473-1.152c.276-.231,17.365-15.666,17.365-15.666v-10.337c0-1.709,1.403-4.228,3.14105-4.241",transform:"translate(-28.9697,0.14347)",fill:"var(--rmg-white)"})]}),e.jsxs("g",{id:"disney",transform:"scale(0.5)",children:[e.jsx("circle",{cx:"0",cy:"29.33899",r:"29.33899",fill:"var(--rmg-grey)"}),e.jsx("path",{fill:"var(--rmg-white)",d:"M45.6152,7.85015a9.80248,9.80248,0,0,0-9.79907,9.801,9.70059,9.70059,0,0,0,.342,2.582c.002.026.002.055.002.093a.31815.31815,0,0,1-.31494.318.67741.67741,0,0,1-.12806-.02,15.71521,15.71521,0,0,0-13.498,0,.61.61,0,0,1-.122.02.31841.31841,0,0,1-.322-.318v-.067a9.62553,9.62553,0,0,0,.35608-2.608,9.803,9.803,0,1,0-9.797,9.8,10.10364,10.10364,0,0,0,2.308-.271h.05493a.31113.31113,0,0,1,.31409.318.32433.32433,0,0,1-.019.12,15.72588,15.72588,0,1,0,29.703,7.216,15.83676,15.83676,0,0,0-1.746-7.23.18417.18417,0,0,1-.0271-.106.31612.31612,0,0,1,.32007-.318h.057a10.15953,10.15953,0,0,0,2.316.271,9.80051,9.80051,0,0,0,0-19.601",transform:"translate(-28.9697 0.13398)"})]}),e.jsxs("g",{id:"railway",children:[e.jsx("circle",{cx:"0",cy:"29.33899",r:"29.33899",fill:"var(--rmg-grey)",transform:"translate(0,-2)scale(0.5)"}),e.jsx("path",{fill:"var(--rmg-white)",d:"M169,273.5c0-19,14.7-34.8,33.7-36.3c18.9-1.5,38.1-2.2,57.4-2.2c19.3,0,38.4,0.8,57.3,2.2  c19,1.5,33.7,17.3,33.7,36.3v47.3l-51.3,14.7c-11.2,3.2-18.9,13.4-18.9,25v147.8c0,17.4,12.2,32.3,29.3,35.7l110.6,22.1  c4.9,1,8.4,5.2,8.4,10.2V599H91v-22.7c0-5,3.5-9.2,8.4-10.2L209.9,544c17-3.4,29.3-18.3,29.3-35.7V360.5c0-11.6-7.7-21.8-18.9-25  L169,320.8V273.5z M309.4,31.7c0.2-1.2,0.3-2.4,0.3-3.6c0-14-11.1-25.4-24.9-26C276.6,1.4,268.3,1,260,1c-8.3,0-16.6,0.4-24.7,1.1  c-13.9,0.6-24.9,12-24.9,26c0,1.2,0.1,2.5,0.3,3.6C90.6,54.8,0,160.3,0,287c0,97.2,53.4,182,132.4,226.6l36.8-48.1  C104.3,432.4,59.8,364.9,59.8,287c0-110.6,89.6-200.2,200.2-200.2S460.2,176.4,460.2,287c0,77.9-44.5,145.4-109.4,178.5  c15,19.6,25.6,33.5,36.8,48.1C466.6,469,520,384.2,520,287C520,160.3,429.4,54.8,309.4,31.7z",transform:"translate(-10,0)scale(0.04)"})]}),e.jsx("marker",{id:"arrow_gray",viewBox:"-1.5 0 3 1.5",refY:.5,children:e.jsx("path",{d:"M0,0L1,1H-1z",fill:"var(--rmg-grey)"})}),e.jsx("marker",{id:"arrow_theme_left",refX:1,refY:.5,children:e.jsx("path",{d:"M1,0L0,1H1z",fill:"var(--rmg-theme-colour)"})}),e.jsx("marker",{id:"arrow_theme_right",refY:.5,children:e.jsx("path",{d:"M0,0L1,1H-1z",fill:"var(--rmg-theme-colour)"})}),e.jsx("marker",{id:"arrow_theme",refX:1,refY:.5,children:e.jsx("path",{d:"M0,1H2L1,0z",fill:"var(--rmg-theme-colour)"})}),e.jsx("filter",{id:"contrast-direct",filterUnits:"userSpaceOnUse",children:e.jsxs("feComponentTransfer",{children:[e.jsx("feFuncR",{type:"linear",slope:.5,intercept:.25}),e.jsx("feFuncG",{type:"linear",slope:.5,intercept:.25}),e.jsx("feFuncB",{type:"linear",slope:.5,intercept:.25})]})}),e.jsx("filter",{id:"contrast-express",filterUnits:"userSpaceOnUse",children:e.jsxs("feComponentTransfer",{children:[e.jsx("feFuncR",{type:"linear",slope:.75,intercept:.125}),e.jsx("feFuncG",{type:"linear",slope:.75,intercept:.125}),e.jsx("feFuncB",{type:"linear",slope:.75,intercept:.125})]})}),e.jsx(ee,{})]})}),fe=L.Indoor;function jt(){const{canvasScale:r}=b(o=>o.app),{svgWidth:s,svg_height:t,theme:n,loop:a}=b(o=>o.param),l=s[fe];return e.jsxs(q,{type:fe,svgWidth:l,svgHeight:t,canvasScale:r,theme:n,children:[e.jsx(_t,{}),a?e.jsx(Se,{bank_angle:!1,canvas:L.Indoor}):e.jsx(yt,{}),e.jsx(wt,{})]})}const _t=w.memo(function(){return e.jsxs("defs",{children:[e.jsx("circle",{id:"stn_indoor_sh",fill:"var(--rmg-white)",strokeWidth:5,r:8,transform:"scale(1.5)"}),e.jsx("path",{id:"int2_indoor_sh",fill:"var(--rmg-white)",transform:"translate(0, -10)scale(2)",strokeWidth:4,d:"M -5,0 a 5,5 0 1 1 10,0 V10 a 5,5 0 1 1 -10,0Z"}),e.jsx("path",{id:"express_indoor_sh",fill:"var(--rmg-white)",transform:"translate(0, -10)scale(2)",strokeWidth:4,d:"M -5,0 a 5,5 0 1 1 10,0 V25 a 5,5 0 1 1 -10,0Z"}),e.jsx("path",{id:"direct_indoor_sh",fill:"var(--rmg-white)",transform:"translate(0, -10)scale(2)",strokeWidth:4,d:"M -5,0 a 5,5 0 1 1 10,0 V40 a 5,5 0 1 1 -10,0Z"})]})}),$t=(r,s)=>{let t=0;return r[s].parents.length===2&&(t+=1),r[r[s].parents[0]].children.length===2&&(t+=1),t},vt=(r,s)=>{let t=0;return r[s].children.length===2&&(t+=1),r[r[s].children[0]].parents.length===2&&(t+=1),t},yt=()=>{const{routes:r,branches:s,depsStr:t}=b(m=>m.helper),n=b(m=>m.param),a=pe(n.stn_list,$t,vt),l=J("linestart","lineend",a),o=J(l.nodes[1],l.nodes.slice(-2)[0],a),i=w.useMemo(()=>(console.log("computing x shares"),Object.keys(n.stn_list).reduce((m,p)=>({...m,[p]:je(p,a,s)}),{})),[s.toString(),JSON.stringify(a)]),c=[n.svgWidth.indoor*n.padding/100,n.svgWidth.indoor*(1-n.padding/100)],h=Object.keys(i).reduce((m,p)=>({...m,[p]:c[0]+i[p]/o.len*(c[1]-c[0])}),{}),g=w.useMemo(()=>oe.getYShares(n.stn_list,s),[t]),d=Object.keys(g).reduce((m,p)=>({...m,[p]:g[p]*n.branchSpacingPct*n.svg_height/200}),{}),j=w.useMemo(()=>_e(n.current_stn_idx,r,n.direction),[n.current_stn_idx,n.direction,r.toString()]),u=Object.values(D),x=Object.values(n.stn_list).map(m=>m.services).flat().reduce((m,p)=>(m[u.indexOf(p)]=!0,m),[!1,!1,!1]).map((m,p)=>[u[p],m]).filter(m=>m[1]).map(m=>m[0]),f=oe.drawLine(s,j,n.stn_list,c,h,d,n.branchSpacingPct*n.svg_height/200,l,0);return e.jsxs("g",{id:"main",transform:"translate(0,".concat(n.svg_height/2,")"),children:[e.jsx(St,{paths:f,services:x}),e.jsx(kt,{xs:h,ys:d,services:x})]})},St=r=>e.jsx("g",{fill:"none",strokeWidth:12,stroke:"var(--rmg-theme-colour)",children:r.services.map((s,t)=>e.jsxs("g",{transform:"translate(0, ".concat(t*30,")"),children:[r.paths.main.map((n,a)=>e.jsx("path",{d:n},a)),r.paths.pass.map((n,a)=>e.jsx("path",{d:n},a))]},"indoor_line_".concat(t)))}),kt=r=>{const{branches:s}=b(h=>h.helper),{stn_list:t,namePosMTR:{isFlip:n}}=b(h=>h.param),{xs:a,ys:l,services:o}=r,i=n==null||n?"upward":"downward",c=i==="upward"?"downward":"upward";return e.jsx("g",{children:Object.keys(t).filter(h=>!["linestart","lineend"].includes(h)).filter(h=>t[h].services.length!==0).map(h=>e.jsx("g",{transform:"translate(".concat(a[h],",").concat(l[h],")"),children:e.jsx(te,{stnId:h,nameDirection:o.length>1?"downward":s.filter(g=>g.includes(h)).map(g=>g.indexOf(h)%2===0?i:c)[0],services:o})},h))})},wt=()=>{const r=b(s=>s.param);return w.useMemo(()=>e.jsxs(e.Fragment,{children:[e.jsx("g",{transform:"translate(".concat(r.svgWidth.indoor/2,",50)"),children:e.jsxs("text",{textAnchor:"middle",fontSize:"30",className:"rmg-name__zh",children:["轨道交通",r.line_name[0],"运营线路示意图"]})}),e.jsxs("g",{transform:"translate(".concat(r.svgWidth.indoor/2,",").concat(r.svg_height-270,")"),children:[e.jsx("text",{textAnchor:"middle",fontSize:"18",className:"rmg-name__zh",dx:"-30",dy:"230",children:"友情提示：请留意您需要换乘线路的首末班时间，以免耽误您的出行，末班车进站前三分钟停售该末班车车票。"}),e.jsx("text",{textAnchor:"middle",fontSize:"12",className:"rmg-name__en",dx:"10",dy:"250",children:"Please pay attention to the interchange schedule if you want to transfer to other lines. Stop selling tickets 3 minutes before the last train services."}),e.jsxs("g",{transform:"translate(-600,215)",children:[e.jsx("rect",{x:"-5",y:"-25",width:"100",height:"70",fill:"none",stroke:"black",rx:"5"}),e.jsx("line",{x1:"28",x2:"28",y1:"-20",y2:"40",stroke:"black"}),e.jsx("text",{className:"rmg-name__zh",dx:"3",fontSize:"18",children:"图"}),e.jsx("text",{className:"rmg-name__zh",dx:"3",dy:"18",fontSize:"18",children:"例"}),e.jsx("text",{className:"rmg-name__en",dy:"35",fontSize:"8",children:"legend"}),e.jsx("use",{transform:"translate(45,10)",xlinkHref:"#int2_indoor_sh",stroke:"var(--rmg-black)"}),e.jsx("text",{className:"rmg-name__zh",dx:"60",dy:"10",fontSize:"10",children:"换乘站"}),e.jsx("text",{className:"rmg-name__en",dx:"60",dy:"20",fontSize:"6",children:"Interchange"}),e.jsx("text",{className:"rmg-name__en",dx:"60",dy:"30",fontSize:"6",children:"Station"})]})]})]}),[r.svgWidth.indoor,r.svg_height,r.line_name])},zt={destination:e.jsx(Ne,{}),runin:e.jsx(We,{}),railmap:e.jsx(ut,{}),indoor:e.jsx(jt,{})};export{zt as default};
