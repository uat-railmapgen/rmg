System.register(["./chakra-legacy-rsWUbD51.js","./react-legacy-gc_DZOLI.js","./index-legacy-dLc-u08Z.js","./app-router-legacy-xZ-_hZo2.js","./share-legacy-sdJOVrGc.js","./mtr-legacy-y93NZaF6.js","./param-manager-utils-legacy-YYk9sGgj.js"],(function(e,t){"use strict";var n,r,s,l,i,a,o,d,c,h,m,g,u,x;return{setters:[e=>{n=e.j},e=>{r=e.r,s=e.b},e=>{l=e.aT,i=e.u,a=e.m},e=>{o=e.i},e=>{d=e.S,c=e.d,h=e.a,m=e.c,g=e.g,u=e.b},e=>{x=e.a},null],execute:function(){const t=(e,t,n,r)=>{const s=e.length-2*r-n,l=[...e,...e,...e],i=e.length+e.findIndex((e=>e===t)),a=l[i+s-1],o=e.length+e.findIndex((e=>e===a))+(i+s>2*e.length?e.length:0);return{top:l.slice(i,o+1),left:l.slice(i-r,i),right:l.slice(o+1,o+1+r),bottom:l.slice(o+1+r,o+1+r+n)}},f=l.Destination;function p(){const{canvasScale:e}=i((e=>e.app)),{svgWidth:t,svg_height:r,theme:s}=i((e=>e.param)),l=t[f];return n.jsxs(d,{type:f,svgWidth:l,svgHeight:r,canvasScale:e,theme:s,children:[n.jsx(j,{}),n.jsx(v,{})]})}const j=r.memo((function(){return n.jsx("defs",{children:n.jsx("marker",{id:"slope",viewBox:"-1.5 0 3 1.5",refY:.5,children:n.jsx("path",{d:"M0,0L1,1H-1z",fill:"var(--rmg-theme-colour)"})})})})),v=()=>{const{routes:e,branches:t}=i((e=>e.helper)),{line_name:r,theme:s,current_stn_idx:l,direction:a,stn_list:d,info_panel_type:c,loop:h,coline:m}=i((e=>e.param)),g=(e,t,n)=>[...new Set(e.filter((e=>e.includes(n))).map((e=>{const n=e.filter((e=>!["linestart","lineend"].includes(e)));return"l"===t?n[0]:n.reverse()[0]})))],u=(e,t)=>t?[[e.map((e=>d[e].name[0])).join("，"),e.map((e=>d[e].name[1])).join(", ")].map((e=>e.replace("\\","")))]:e.map((e=>d[e].name.map((e=>e.replace("\\",""))))),x=h?((e,t,n,r)=>{const s=e[0].filter((e=>!["linestart","lineend"].includes(e))),l=[...s,...s,...s],i="r"===t?l:l.reverse(),a=i.findIndex((e=>r===e))+s.length;return i.slice(a+1).filter((e=>n[e].loop_pivot)).slice(void 0,2)})(t,a,d,l):g(e,a,l),f=(h?g(e,a,l):x).filter((e=>t.slice(1).filter((e=>o(e,d))).some((t=>t.includes(e))))),p=u(x.filter((e=>!f.includes(e))),!(h||"sh2020"===c));console.log(p);const j=u(f,!0),v=Object.fromEntries(f.map((e=>[e,Object.values(m).filter((t=>t.from===e||t.to===e)).at(0)])).filter((([,e])=>e)));return n.jsxs(n.Fragment,{children:[n.jsx(_,{dest_names:p,line_name:r,line_color:[s[2],s[3]],coline:!!f.length,upper:!!f.length}),f.length&&f.map((e=>{var t,r,s;return n.jsx("g",{transform:"translate(0,-250)",children:n.jsx(_,{dest_names:[j.at(0)],line_name:null===(t=v[e])||void 0===t?void 0:t.colors.at(0).slice(4),line_color:[null===(r=v[e])||void 0===r?void 0:r.colors.at(0)[2],null===(s=v[e])||void 0===s?void 0:s.colors.at(0)[3]],coline:!0,upper:!1})},`coline_${e}`)}))]})},_=e=>{const{dest_names:t,line_name:s,line_color:l,coline:a,upper:o}=e,{current_stn_idx:d,direction:c,platform_num:h,svgWidth:m,svg_height:g}=i((e=>e.param)),u=r.useRef(null),[x,f]=r.useState({width:0});r.useEffect((()=>{u.current&&f(u.current.getBBox())}),[JSON.stringify(t),JSON.stringify(d)]);const[p,j,v,_,b]=[m.destination/2,10,36,264,325],S=p-j-v-x.width>=b/2&&p-j-v-_>=b/2?p:"l"===c?(m.destination+x.width-_)/2:(m.destination-x.width+_)/2;return n.jsxs("g",{transform:`translate(0,${g-300})`,children:[n.jsx("path",{stroke:l[0],strokeWidth:12,d:"l"===c?`M${m.destination-24},16 H 36`:"M24,16 H "+(m.destination-36),transform:`translate(0,${o?-20:220})`,markerEnd:a?void 0:"url(#slope)"}),n.jsx($,{ref:u,dest_names:t}),""!==h&&n.jsx("g",{transform:`translate(${S},0)`,children:n.jsx(y,{})}),s[0].match(/^[\w\d]+(号)?线/)?n.jsx(w,{line_name:s,line_color:l}):n.jsx(k,{line_name:s,line_color:l})]})},$=r.forwardRef((function(e,t){const{dest_names:s}=e,{direction:l,svgWidth:a}=i((e=>e.param));return n.jsxs("g",{ref:t,transform:`translate(${"l"===l?36:a.destination-36},145)`,children:[n.jsx("g",{transform:`translate(0,${2===s.length?-20:20})`,children:n.jsx("path",{d:"M60,60L0,0L60-60H100L55-15H160V15H55L100,60z",fill:"black",transform:`rotate(${"l"===l?0:180})scale(0.8)`})}),n.jsx("g",{textAnchor:"l"===l?"start":"end",transform:`translate(${"l"===l?148:-148},25)`,children:s.map(((e,t)=>n.jsxs(r.Fragment,{children:[n.jsx("text",{className:"rmg-name__zh rmg-outline",fontSize:70,dy:-100*t+7,children:"往"+e[0]},`zh${t}`),n.jsx("text",{className:"rmg-name__en rmg-outline",fontSize:25,dy:-100*t+40,children:"To "+e[1]},`en${t}`)]},t)))})]})})),y=()=>{const{platform_num:e}=i((e=>e.param));return r.useMemo((()=>n.jsxs("g",{transform:"translate(-102.5,150)",children:[n.jsx("circle",{r:60,fill:"none",stroke:"black",strokeWidth:2}),n.jsx("text",{className:"rmg-name__en rmg-outline",dominantBaseline:"central",fontSize:120,textAnchor:"middle",children:e}),n.jsx("text",{className:"rmg-name__zh rmg-outline",fontSize:100,dominantBaseline:"central",x:65,children:"站台"})]})),[e])},k=e=>{const{line_name:t,line_color:s}=e,{direction:l,svgWidth:a}=i((e=>e.param)),o="l"===l?a.destination-42:42,d=r.useRef(null),[c,h]=r.useState({width:0});r.useEffect((()=>{d.current&&h(d.current.getBBox())}),[...t]);const m=("l"===l?-c.width:0)-6,g=("l"===l?-1:1)*c.width/2;return r.useMemo((()=>n.jsxs("g",{transform:`translate(${o},92)`,children:[n.jsx("rect",{fill:s[0],x:m,width:c.width+10,height:120}),n.jsxs("g",{textAnchor:"r"===l?"start":"end",transform:"translate(0,68)",fill:s[1],children:[n.jsx("g",{ref:d,children:n.jsx("text",{className:"rmg-name__zh rmg-outline",fontSize:68,children:t[0]})}),n.jsx("text",{className:"rmg-name__en rmg-outline",fontSize:30,textAnchor:"middle",x:g,dy:42,children:t[1]})]})]})),[c,...t,...s,l,a.destination])},w=e=>{const{line_name:t,line_color:s}=e,{direction:l,svgWidth:a}=i((e=>e.param)),[o,d]=t[0].match(/^[\w\d]+|.+/g),c="l"===l?a.destination-36-210:90;return r.useMemo((()=>n.jsxs("g",{transform:`translate(${c},92)`,children:[n.jsx("rect",{fill:s[0],x:-54,width:108,height:120}),n.jsx("text",{className:"rmg-name__zh rmg-outline",fill:s[1],fontSize:96,textAnchor:"middle",dominantBaseline:"central",transform:"translate(0,60)",letterSpacing:-5,children:o}),n.jsxs("g",{textAnchor:"start",transform:"translate(74,68)",children:[n.jsx("text",{className:"rmg-name__zh rmg-outline",fontSize:68,children:d}),n.jsx("text",{className:"rmg-name__en rmg-outline",fontSize:30,dy:42,children:t[1]})]})]})),[c,...t,...s,l,a.destination])},b=(e,t)=>e.map((e=>{const n=t.filter((t=>t.includes(e.from)&&t.includes(e.to)));if(1!==n.length)return{linePath:[],colors:e.colors};const r=n.flat(),s=r.indexOf(e.from),l=r.indexOf(e.to);return{linePath:s<l?r.slice(s,l+1):r.slice(l,s+1),colors:e.colors}})).filter((e=>0!==e.linePath.length)),S=()=>s.useMemo((()=>n.jsxs("filter",{id:"pujiang_outline",colorInterpolationFilters:"sRGB",filterUnits:"userSpaceOnUse",x:"0",y:"-1000",width:"5000",height:"2000",children:[n.jsxs("feComponentTransfer",{in:"SourceGraphic",children:[n.jsx("feFuncR",{type:"discrete",tableValues:"0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 1 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0"}),n.jsx("feFuncG",{type:"discrete",tableValues:"0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 1 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0"}),n.jsx("feFuncB",{type:"discrete",tableValues:"0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 1 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0"})]}),n.jsx("feColorMatrix",{type:"matrix",values:"1 0 0 0 0\n                            0 1 0 0 0\n                            0 0 1 0 0\n                            1 1 1 1 -3",result:"selectedColor"}),n.jsx("feMorphology",{operator:"erode",in:"selectedColor",radius:"0",result:"e1"}),n.jsx("feMorphology",{operator:"erode",in:"selectedColor",radius:"1",result:"e2"}),n.jsx("feComposite",{in:"e1",in2:"e2",operator:"xor",result:"uncoloredOutline"}),n.jsx("feFlood",{floodColor:"rgb(0,0,0)"}),n.jsx("feComposite",{operator:"in",in2:"uncoloredOutline",result:"outline"}),n.jsx("feComposite",{in:"outline",in2:"selectedColor",operator:"over",result:"result"}),n.jsx("feComposite",{in:"result",in2:"SourceGraphic",operator:"over"})]})),[]);S.displayName="PujiangLineDefs";const M=l.RunIn,z=()=>{const{canvasScale:e}=i((e=>e.app)),{branches:t,routes:s,depsStr:l}=i((e=>e.helper)),{svgWidth:a,svg_height:o,current_stn_idx:c,direction:h,loop:m,theme:g}=i((e=>e.param)),u=a[M],x=o-300,f=r.useMemo((()=>{let e=s.filter((e=>e.includes(c))).map((e=>e[e.indexOf(c)+("l"===h?1:-1)])).filter((e=>void 0!==e)).reduce(((e,t)=>e.includes(t)?e:e.concat(t)),[]);return m&&t[0].includes(c)&&1===e.length&&["linestart","lineend"].includes(e[0])&&(e="l"===h?[t[0][1]]:[t[0][t[0].length-2]]),e}),[l,c,h,m]),p=r.useMemo((()=>{let e=s.filter((e=>e.includes(c))).map((e=>e[e.indexOf(c)+("l"===h?-1:1)])).filter((e=>void 0!==e)).reduce(((e,t)=>e.includes(t)?e:e.concat(t)),[]);return m&&t[0].includes(c)&&1===e.length&&["linestart","lineend"].includes(e[0])&&(e="l"===h?[t[0][t[0].length-2]]:[t[0][1]]),e}),[l,c,h,m]);return n.jsxs(d,{type:M,svgWidth:u,svgHeight:o,canvasScale:e,theme:g,children:[n.jsx(O,{}),n.jsx("g",{transform:`translate(0,${x})`,children:n.jsx(N,{prevStnIds:f,nextStnIds:p})})]})},O=r.memo((function(){return n.jsxs("defs",{children:[n.jsx("marker",{id:"slope",viewBox:"-1.5 0 3 1.5",refY:.5,children:n.jsx("path",{d:"M0,0L1,1H-1z",fill:"var(--rmg-theme-colour)"})}),n.jsx(S,{})]})})),N=e=>{const{prevStnIds:t,nextStnIds:r}=e,{info_panel_type:s,svgWidth:l,stn_list:a}=i((e=>e.param)),o=l.runin/2,d=1===r.length&&["linestart","lineend"].includes(r[0]),c=1===t.length&&["linestart","lineend"].includes(t[0]),h=r.map((e=>a[e].name)),m=t.map((e=>a[e].name)),g=10+(r.length>1?-50*(h[0][0].split("\\").length-1)+-30*(h[0][1].split("\\").length-1):0),u=10+(t.length>1?-50*(m[0][0].split("\\").length-1)+-30*(m[0][1].split("\\").length-1):0);return n.jsxs(n.Fragment,{children:[n.jsx(W,{prevStnIds:t,nextStnIds:r,nextBranchLineDy:g,prevBranchLineDy:u}),d&&"sh2020"!==s?n.jsx(I,{mode:"terminal",prevStnIds:t,nextStnIds:r}):c&&"sh2020"!==s?n.jsx(I,{mode:"original",prevStnIds:t,nextStnIds:r}):n.jsxs(n.Fragment,{children:[n.jsx(H,{prevStnIds:t,nextStnIds:r}),n.jsx("g",{transform:`translate(${o},160)`,textAnchor:"middle",children:n.jsx(L,{})})]}),(c||!d)&&n.jsx(P,{stnIds:e.nextStnIds}),(d||!c)&&n.jsx(B,{stnIds:e.prevStnIds})]})},I=e=>{var t;const{mode:r,prevStnIds:s,nextStnIds:l}=e,{current_stn_idx:a,theme:o,svgWidth:d,direction:c,coline:h}=i((e=>e.param)),{branches:m}=i((e=>e.helper)),g={l:{original:{x:d.runin-36,anchor:"end"},terminal:{x:36,anchor:"start"}},r:{original:{x:36,anchor:"start"},terminal:{x:d.runin-36,anchor:"end"}}},u=b(Object.values(h),m),x="terminal"===r?s:l,f=l.length>1?"var(--rmg-theme-colour)":null!==(t=u.filter((e=>e.linePath.includes(a)&&e.linePath.includes(x[0]))).map((e=>e.colors[0][2]))[0])&&void 0!==t?t:"var(--rmg-theme-colour)";return n.jsxs(n.Fragment,{children:["original"===r&&n.jsx("path",{transform:`translate(0,${h.length?"198":"220"})${h.length?"scale(1,2)":""}`,stroke:f,strokeWidth:12,d:"l"===c?`M ${d.runin-24},16 H 36`:"M24,16 H "+(d.runin-36),markerEnd:"url(#slope)"}),"terminal"===r&&n.jsx("g",{filter:"#B5B5B6"===o[2]?"url(#pujiang_outline)":void 0,children:n.jsx("path",{transform:`translate(0,${h.length?"198":"220"})${h.length?"scale(1,2)":""}`,stroke:"var(--rmg-grey)",strokeWidth:12,d:"M24,16 H "+(d.runin-24)})}),n.jsx("g",{transform:`translate(${g[c][r].x},160)`,textAnchor:g[c][r].anchor,children:n.jsx(L,{})})]})},H=e=>{var t;const{prevStnIds:r,nextStnIds:s}=e,{direction:l,svgWidth:a,theme:d,coline:c,current_stn_idx:h,stn_list:m}=i((e=>e.param)),{branches:g}=i((e=>e.helper)),u=a.runin/2,x=e=>e.includes("linestart")||e.includes("lineend"),f=b(Object.values(c),g),p=s.length>1?"single":x(s)?f.filter((e=>[h,r[0]].every((t=>e.linePath.includes(t))))).length>0?"multiple":"single":[h,s[0]].every((e=>g[0].includes(e)))&&f.filter((e=>[h,s[0]].every((t=>e.linePath.includes(t))))).length>0?"multiple":"single",j=x(s)?r:s,v=s.length>1?"var(--rmg-theme-colour)":null!==(t=f.filter((e=>e.linePath.includes(h)&&e.linePath.includes(j[0]))).map((e=>e.colors[0][2]))[0])&&void 0!==t?t:"var(--rmg-theme-colour)",_=Object.keys(c).length>0&&($=h,y=s,k=m,g.slice(1).filter((e=>[$,y[0]].every((t=>e.includes(t))))).filter((e=>o(e,k))).length>0)?v:"var(--rmg-theme-colour)";var $,y,k;const w=Object.keys(c).length>0&&1===s.length&&(!(!x(r)&&!x(s))||!([h,s[0]].every((e=>g[0].includes(e)))&&0!==f.filter((e=>e.linePath.includes(h)&&e.linePath.includes(s[0]))).length)),S=Object.keys(c).length>0&&1===r.length;return n.jsxs("g",{transform:"translate(0,220)",strokeWidth:12,children:[n.jsxs(n.Fragment,{children:["var(--rmg-theme-colour)"!==_&&n.jsx("marker",{id:`slope_${_}`,viewBox:"-1.5 0 3 1.5",refY:.5,children:n.jsx("path",{d:"M0,0L1,1H-1z",fill:_})}),n.jsx("path",{stroke:_,d:`M ${u},16 H ${"l"===l?36:a.runin-36}`,markerEnd:"var(--rmg-theme-colour)"===_?"url(#slope)":`url(#slope_${_})`,transform:w?"translate(0,-22)scale(1,2)":void 0})]}),"multiple"===p&&n.jsxs(n.Fragment,{children:[n.jsx("marker",{id:`slope_${v}`,viewBox:"-1.5 0 3 1.5",refY:.5,children:n.jsx("path",{d:"M0,0L1,1H-1z",fill:v})}),n.jsx("path",{stroke:v,d:`M ${u},16 H ${"l"===l?48:a.runin-48}`,markerEnd:`url(#slope_${v})`,transform:"translate(0,-12)"})]}),n.jsx("g",{filter:"#B5B5B6"===d[2]?"url(#pujiang_outline)":void 0,transform:`translate(0,${S?-22:0})scale(1,${S?2:1})`,children:n.jsx("path",{stroke:"var(--rmg-grey)",d:`M ${u},16 H ${"l"===l?a.runin-24:24} `})})]})},W=e=>{const{prevStnIds:t,nextStnIds:r,nextBranchLineDy:s,prevBranchLineDy:l}=e,{direction:a,svgWidth:o,current_stn_idx:d,coline:c,theme:h}=i((e=>e.param)),{branches:m}=i((e=>e.helper)),g=o.runin/2,u=125,x=e=>`${e[0]},${e[1]}`,f=e=>`M${x(e.at(0))} `+e.slice(1).map((e=>`L${x(e)}`)).join(" "),p="l"===a?[[o.runin/3,u],[o.runin/6,s],[36,s]]:[[o.runin/3*2,u],[o.runin/6*5,s],[o.runin-36,s]],j="l"===a?[[o.runin/3*2,u],[o.runin/6*5,l],[o.runin-24,l]]:[[o.runin/3,u],[o.runin/6,l],[24,l]];let v="var(--rmg-theme-colour)";if(Object.keys(c).length>0){const e=b(Object.values(c),m);r.length>1&&e.filter((e=>e.linePath.includes(d)&&r.some((t=>e.linePath.includes(t)))))&&(p[0][1]-=11,p.unshift([g,114]),v=e.filter((e=>e.linePath.includes(d)&&r.some((t=>e.linePath.includes(t))))).at(0).colors.at(0)[2]),t.length>1&&e.filter((e=>e.linePath.includes(d)&&t.some((t=>e.linePath.includes(t)))))&&(j[0][1]-=11,j.unshift([g,114]))}return n.jsxs("g",{transform:"translate(0,110)",strokeWidth:12,fill:"none",filter:"#B5B5B6"===h[2]?"url(#pujiang_outline)":void 0,children:[n.jsx("marker",{id:"slope_branch",viewBox:"-1.5 0 3 1.5",refY:.5,children:n.jsx("path",{d:"M0,0L1,1H-1z",fill:v})}),r.length>1&&n.jsx("path",{stroke:v,d:f(p),markerEnd:"url(#slope_branch)"}),t.length>1&&n.jsx("path",{stroke:"var(--rmg-grey)",d:f(j)})]})},L=()=>{const e=i((e=>e.param)),{name:t}=e.stn_list[e.current_stn_idx];return r.useMemo((()=>n.jsxs(n.Fragment,{children:[n.jsx("text",{className:"rmg-name__zh rmg-outline",fontSize:112,children:t[0].replace("\\","")}),n.jsx("text",{className:"rmg-name__en rmg-outline",fontSize:36,dy:50,children:t[1].replace("\\","")})]})),[...t])},F=e=>{const{nextName:t,...s}=e;return n.jsx("g",{...s,children:r.useMemo((()=>n.jsxs(n.Fragment,{children:[t[0].split("\\").map(((e,r,s)=>n.jsx("text",{className:"rmg-name__zh rmg-outline",fontSize:48,dy:-50*(s.length-1-r)-30*(t[1].split("\\").length-1),children:e},e))),t[1].split("\\").map(((e,t,r)=>n.jsx("text",{className:"rmg-name__en rmg-outline",fontSize:24,dy:28+-30*(r.length-1-t),children:e},e)))]})),[...t])})},B=e=>{const t=i((e=>e.param)),r=e.stnIds.map((e=>t.stn_list[e].name)),s=(e.stnIds.length>1?15:125)+-50*r.map((e=>e[0].split("\\").length)).reduce(((e,t)=>e+t),-r.length)+-30*r.map((e=>e[1].split("\\").length)).reduce(((e,t)=>e+t),-r.length),l=70+(e.stnIds.length>1?-50*(r[0][0].split("\\").length-1)+-30*(r[0][1].split("\\").length-1):0);return n.jsxs("g",{fill:"gray",textAnchor:"l"===t.direction?"end":"start",transform:`translate(${"l"===t.direction?t.svgWidth.runin-36:36},0)`,children:[n.jsx(F,{nextName:r[0],transform:"translate(0,183)"}),e.stnIds.length>1&&n.jsx(F,{nextName:r[1],transform:`translate(0,${l})`}),n.jsxs("g",{transform:`translate(0, ${s})`,children:[n.jsx("text",{className:"rmg-name__zh rmg-outline",fontSize:22,children:"上一站"}),n.jsx("text",{className:"rmg-name__en rmg-outline",fontSize:12,dx:"l"===t.direction?-70:70,children:"Past Stop"})]})]})},P=e=>{const t=i((e=>e.param)),r=e.stnIds.map((e=>t.stn_list[e].name)),s=(e.stnIds.length>1?15:125)+-50*r.map((e=>e[0].split("\\").length)).reduce(((e,t)=>e+t),-r.length)+-30*r.map((e=>e[1].split("\\").length)).reduce(((e,t)=>e+t),-r.length),l=70+(e.stnIds.length>1?-50*(r[0][0].split("\\").length-1)+-30*(r[0][1].split("\\").length-1):0);return n.jsxs("g",{textAnchor:"l"===t.direction?"start":"end",transform:`translate(${"l"===t.direction?36:t.svgWidth.runin-36},0)`,children:[n.jsx(F,{nextName:t.stn_list[e.stnIds[0]].name,transform:"translate(0,183)"}),e.stnIds.length>1&&n.jsx(F,{nextName:t.stn_list[e.stnIds[1]].name,transform:`translate(0,${l})`}),n.jsxs("g",{transform:`translate(0, ${s})`,children:[n.jsx("text",{className:"rmg-name__zh rmg-outline",fontSize:22,children:"下一站"}),n.jsx("text",{className:"rmg-name__en rmg-outline",fontSize:12,dx:"l"===t.direction?70:-70,children:"Next Stop"})]})]})},E=e=>{const{stnId:t,stnState:r,color:s,bank:l,direction:a}=e,{direction:o,info_panel_type:d,stn_list:c,loop:h}=i((e=>e.param)),m=c[t],g=null!=a?a:o,u=h?0:(m.parents.length>1||m.children.length>1?8+12*m.name[1].split("\\").length:0)*("r"===g?-1:1);let x;const f={};var p;"sh2020"===d?(x=3===m.services.length?"stn_sh_2020_direct":2===m.services.length?"stn_sh_2020_express":"stn_sh_2020",f.fill=-1===r?"gray":s||"var(--rmg-theme-colour)"):(x=3===m.services.length?"direct_sh":2===m.services.length?"express_sh":[...m.transfer.groups[0].lines||[],...(null===(p=m.transfer.groups[1])||void 0===p?void 0:p.lines)||[]].length>0?"int2_sh":"stn_sh",f.stroke=-1===r?"gray":s||"var(--rmg-theme-colour)");const j=null!=l?l:0,v=("l"===g?6:-6)+u+30*j,_=("sh2020"===d?-20:-6)+Math.abs(j)*("sh2020"===d?25:11),$=j?0:"l"===g?-45:45;return n.jsxs(n.Fragment,{children:[n.jsx("use",{xlinkHref:`#${x}`,...f,transform:`translate(${j*("sh2020"===d?5:0)},0)rotate(${90*j*("sh2020"===d?1:-1)})`}),n.jsx("g",{transform:`translate(${v},${_})rotate(${$})`,children:n.jsx(R,{name:m.name,groups:m.transfer.groups,stnState:r,direction:g,facility:m.facility,bank:j,oneLine:m.one_line,intPadding:m.int_padding})}),0===r?n.jsx(C,{}):void 0]})},R=e=>{var t,s;const{name:l,groups:i,stnState:a,direction:o,facility:d,bank:c,oneLine:h,intPadding:m}=e,g=r.useRef(null),u="l"===o?1:-1,x=d?30:0,f=c?-12:0,p=r.useRef(null),[j,v]=r.useState(0);r.useEffect((()=>{var e,t;return v(null!==(e=null===(t=p.current)||void 0===t?void 0:t.getBBox().width)&&void 0!==e?e:0)}),[JSON.stringify(i)]);const _=m-j;return n.jsxs(n.Fragment,{children:[i.map((e=>{var t;return null!==(t=e.lines)&&void 0!==t?t:[]})).flat().length>0&&n.jsxs(n.Fragment,{children:[n.jsx("line",{x1:(f+x)*u,x2:_*u,stroke:-1===a?"gray":"black",strokeWidth:.5}),n.jsx(V,{ref:p,groups:i,direction:o,transform:`translate(${_*u},-10.75)`})]}),d&&n.jsx("use",{xlinkHref:"#"+d,x:10*u,y:-30}),n.jsxs("g",{textAnchor:"l"===o?"start":"end",transform:`translate(${x*u},-14)`,children:[n.jsx(A,{ref:g,stnName:l,oneLine:h,directionPolarity:u,fill:-1===a?"gray":0===a?"red":"black"}),(null===(t=i[1])||void 0===t||null===(t=t.lines)||void 0===t?void 0:t.length)&&n.jsx("g",{transform:`translate(${(_+j/2)*u},-30)`,children:n.jsx(T,{osiInfos:i[1].lines})}),(null===(s=i[2])||void 0===s||null===(s=s.lines)||void 0===s?void 0:s.length)&&n.jsx("g",{transform:`translate(${(m+5)*u},0)`,children:n.jsx(G,{osysiInfos:i[2].lines,direction:e.direction})})]})]})},A=r.forwardRef((function(e,t){const{stnName:s,oneLine:l,directionPolarity:i,...a}=e,o=r.useRef(null),[d,c]=r.useState(0);r.useEffect((()=>{l&&o.current?c(o.current.getBBox().width+5):c(0)}),[...s,l]);const[h,m]=[20,8];return n.jsx("g",{ref:t,...a,children:r.useMemo((()=>n.jsxs(n.Fragment,{children:[n.jsx("g",{ref:o,children:s[0].split("\\").map(((e,t,r)=>n.jsx("text",{className:"rmg-name__zh rmg-outline",dy:(r.length-1-t)*-h+(l?m:(s[1].split("\\").length-1)*-m),children:e},t)))}),n.jsx("g",{fontSize:8,transform:`translate(${d*i},0)`,children:s[1].split("\\").map(((e,t,r)=>n.jsx("text",{className:"rmg-name__en rmg-outline",dy:(r.length-2-t)*-m+2,children:e},t)))})]})),[...s,l,d,i])})})),C=()=>{const{stn_list:e}=i((e=>e.param)),t=[-1,35,50,75][new Set(Object.values(e).map((e=>e.services)).flat()).size];return n.jsx("g",{transform:`translate(0, ${t})`,children:n.jsx("text",{className:"rmg-name__zh",fill:"red",textAnchor:"middle",children:"本站"})})},V=r.forwardRef((function(e,t){var r,s;const{groups:l,direction:i,...a}=e,o=[...l[0].lines||[],...(null===(r=l[1])||void 0===r?void 0:r.lines)||[],...(null===(s=l[2])||void 0===s||null===(s=s.lines)||void 0===s?void 0:s.filter((e=>Boolean(e.name[0].match(/^磁(悬)*浮/)))))||[]];let d=0;return n.jsx("g",{ref:t,fontSize:14,textAnchor:"middle",...a,children:o.map(((t,r)=>{const s=Boolean(t.name[0].match(/^\w+(号)?线/)),l=Boolean(t.name[0].match(/^磁(悬)*浮/));let i;return"r"===e.direction&&(d-=(s||l?20:14*t.name[0].length+12)+(0===r?0:5)),i=l?n.jsx("g",{transform:`translate(${d},-16)scale(0.1428571429)`,children:n.jsx(D,{info:t})},r):s?n.jsx("g",{transform:`translate(${d},0)`,children:n.jsx(J,{info:t})},r):n.jsx("g",{transform:`translate(${d},0)`,children:n.jsx(Y,{info:t})},r),"l"===e.direction&&(d+=s||l?25:14*t.name[0].length+12+5),i}))})})),D=r.memo((function(e){var t,r;return n.jsx(n.Fragment,{children:n.jsx("use",{xlinkHref:"#intbox_maglev",fill:null===(t=e.info.theme)||void 0===t?void 0:t[2],stroke:null===(r=e.info.theme)||void 0===r?void 0:r[2]})})}),((e,t)=>JSON.stringify(e.info)===JSON.stringify(t.info))),J=r.memo((function(e){var t,r,s;return n.jsxs(n.Fragment,{children:[n.jsx("use",{xlinkHref:"#intbox_number",fill:null===(t=e.info.theme)||void 0===t?void 0:t[2]}),n.jsx("text",{x:10,className:"rmg-name__zh",fill:null===(r=e.info.theme)||void 0===r?void 0:r[3],dominantBaseline:"central",children:null===(s=e.info.name[0].match(/(\d*)\w+/))||void 0===s?void 0:s[0]})]})}),((e,t)=>JSON.stringify(e.info)===JSON.stringify(t.info))),Y=r.memo((function(e){var t,r;const s=e.info.name[0].split("\\")[0].length;return n.jsxs(n.Fragment,{children:[n.jsx("rect",{height:22,width:14*s+12,y:-11,fill:null===(t=e.info.theme)||void 0===t?void 0:t[2]}),n.jsx("text",{x:7*s+6,className:"rmg-name__zh",fill:null===(r=e.info.theme)||void 0===r?void 0:r[3],dominantBaseline:"central",children:e.info.name[0].split("\\")[0]})]})}),((e,t)=>JSON.stringify(e.info)===JSON.stringify(t.info))),T=e=>{const t=e.osiInfos.map((e=>e.name[0])).join("，");return r.useMemo((()=>n.jsxs("g",{textAnchor:"middle",fontSize:"50%",children:[n.jsx("text",{className:"rmg-name__zh",dy:-5,children:`换乘${t}`}),n.jsx("text",{className:"rmg-name__zh",dy:5,children:"仅限公共交通卡"}),n.jsx("text",{className:"rmg-name__en",dy:12.5,fontSize:"75%",children:"Only for Public Transportation Card"})]})),[t.toString()])},G=e=>{const t=e.osysiInfos.map((e=>e.name[0])).join("，"),s=e.osysiInfos.map((e=>e.name[1])).join(", ");return r.useMemo((()=>n.jsxs("g",{textAnchor:"l"===e.direction?"start":"end",fontSize:"50%",children:[n.jsxs("text",{className:"rmg-name__zh",dy:3,children:["转乘",t]}),n.jsxs("text",{className:"rmg-name__en",dy:10,fontSize:"75%",children:["To ",s]})]})),[JSON.stringify(e.osysiInfos),e.direction])},U=["shanghai","sh4","#5F259F","#fff","4号线","Line 4"],X=e=>{const{xs:t,servicesPresent:s,stnStates:l}=e,{svg_height:a,direction:o,stn_list:d,current_stn_idx:h,branchSpacingPct:m,info_panel_type:g,coline:u}=i((e=>e.param)),{branches:x,depsStr:f}=i((e=>e.helper)),p=r.useMemo((()=>(console.log("computing y shares"),Object.keys(d).reduce(((e,t)=>{if(x[0].includes(t))return{...e,[t]:0};{const n=x.slice(1).filter((e=>e.includes(t)))[0];return{...e,[t]:d[n[0]].children.indexOf(n[1])?-3:3}}}),{}))),[f]),j=Object.entries(p).filter((([e,t])=>t<=0)).reduce(((e,[t,n])=>({...e,[t]:n})),{}),v=Object.keys(j).reduce(((e,t)=>({...e,[t]:-j[t]*m*a/300})),{}),_=r.useMemo((()=>((e,t)=>e.map((e=>{const n=c(e.linePath,t);return{main:[{linePath:n.main,colors:e.colors}],pass:[{linePath:n.pass,colors:e.colors}]}})).reduce(((e,t)=>(e.main=[...e.main,...t.main],e.pass=[...e.pass,...t.pass],e)),{main:[],pass:[]}))(b(Object.values(u).filter((e=>e.display)),x),l)),[JSON.stringify(u),h,o,f]),$=s.reduce(((e,n)=>({...e,[n]:Object.keys(_).reduce(((e,r)=>({...e,[r]:_[r].map((e=>({path:te(e.linePath,r,t,v,o,n,s.length,d,"diagonal"),colors:e.colors}))).filter((e=>""!==e.path))})),{})})),{}),y=b(Object.values(u).filter((e=>e.display)),x).map((e=>e.linePath)).flat(),k="sh2020"===g?3:0;return n.jsx(n.Fragment,{children:n.jsxs("g",{id:"coline",transform:`translate(0,${12+k})`,children:[n.jsx(Z,{paths:$,direction:o}),n.jsx(q,{colineStns:_,branches:x,xs:t,ys:v,stnStates:l,lineWidth:12,colineGap:k}),n.jsx(K,{stnIds:Object.entries(p).filter((([e,t])=>t<0)).reduce(((e,[t,n])=>[...e,t]),[]).filter((e=>!["linestart","lineend"].includes(e))).filter((e=>0!==d[e].services.length)).filter((e=>y.includes(e))),xs:t,ys:v,stnStates:l})]})})},Z=e=>{const{paths:t,direction:s}=e;return n.jsx(n.Fragment,{children:Object.keys(t).map(((e,l)=>{var i,o;return n.jsx("g",{transform:`translate(0,${25*l})`,children:n.jsxs("g",{children:[null===(i=t[e])||void 0===i?void 0:i.pass.map(((t,s)=>n.jsx(r.Fragment,{children:n.jsx("path",{stroke:"var(--rmg-grey)",strokeWidth:12,fill:"none",d:t.path,strokeLinejoin:"round",filter:e===a.local?void 0:`url(#contrast-${e})`},s)},s))),null===(o=t[e])||void 0===o?void 0:o.main.map(((t,l)=>{var i;return n.jsxs(r.Fragment,{children:[t.colors.length>1&&n.jsx("linearGradient",{id:`grad${l}`,y1:"-100%",y2:"100%",x1:"0",x2:"0",gradientUnits:"userSpaceOnUse",children:t.colors.map(((e,s)=>n.jsxs(r.Fragment,{children:[n.jsx("stop",{offset:100/t.colors.length*(s+0)+"%",stopColor:e[2]}),n.jsx("stop",{offset:100/t.colors.length*(s+1)+"%",stopColor:e[2]})]},s)))}),"l"===s&&n.jsx("marker",{id:`arrow_left_${l}_${t.colors.map((e=>e[2])).join("_")}`,refY:.5,refX:1,children:n.jsx("path",{d:"M1,0L0,1H1z",fill:t.colors.length>1?`url(#grad${l})`:t.colors[0][2]})}),"r"===s&&n.jsx("marker",{id:`arrow_right_${l}_${t.colors.map((e=>e[2])).join("_")}`,refY:.5,children:n.jsx("path",{d:"M0,0L1,1H-1z",fill:t.colors.length>1?`url(#grad${l})`:t.colors[0][2]})}),n.jsx("path",{stroke:(null!==(i=t.colors.at(-1))&&void 0!==i?i:U)[2],strokeWidth:12,fill:"none",d:t.path,markerStart:"l"===s?`url(#arrow_left_${l}_${t.colors.map((e=>e[2])).join("_")})`:void 0,markerEnd:"r"===s?`url(#arrow_right_${l}_${t.colors.map((e=>e[2])).join("_")})`:void 0,strokeLinejoin:"round",filter:e===a.local?void 0:`url(#contrast-${e})`},l)]},l)}))]})},`servicePath${l}`)}))})},q=e=>{const{colineStns:t,branches:r,xs:s,ys:l,stnStates:a,lineWidth:o,colineGap:d}=e,{line_name:c,theme:h,info_panel_type:m}=i((e=>e.param)),g=[...t.main,...t.pass].map((e=>e.linePath.map((t=>{var n;return{curStn:t,x:s[t],y:l[t],color:null!==(n=e.colors.at(-1))&&void 0!==n?n:[...h,...c]}})))).flat().reduce(((e,t)=>e.find((e=>e.curStn===t.curStn))?e:e.concat(t)),[]).filter((e=>r[0].includes(e.curStn)));return console.log(g),n.jsx("g",{id:"stations_in_mainline",children:g.map((e=>{const{curStn:t,x:r,y:s,color:l}=e,i=(-1===a[t]?0:o)+d+o,c=(-1===a[t]?0:-o)-d-o/2;return n.jsx("g",{transform:`translate(${r},${s})`,children:"sh2020"===m?n.jsx("rect",{stroke:"none",height:i,width:12,x:-6,y:c,fill:-1===a[t]?"var(--rmg-grey)":l[2]}):n.jsx("use",{xlinkHref:"#int2_sh",stroke:"var(--rmg-theme-colour)",transform:`translate(0,${-o})`})},t)}))})},K=e=>{const{xs:t,ys:s,stnStates:l,stnIds:a}=e,{branches:o,depsStr:d}=i((e=>e.helper)),{line_name:c,theme:h,coline:m}=i((e=>e.param)),g=r.useMemo((()=>b(Object.values(m),o)),[JSON.stringify(m),d]),u=a.reduce(((e,t)=>{var n;return{...e,[t]:null!==(n=g.filter((e=>e.linePath.includes(t))).map((e=>e.colors)).flat().at(0))&&void 0!==n?n:[...h,...c]}}),{});return n.jsx("g",{id:"stations_in_coline",children:a.map((e=>n.jsx("g",{transform:`translate(${t[e]},${s[e]})`,children:n.jsx(E,{stnId:e,stnState:l[e],color:u[e][2]})},e)))})},Q=()=>{const{routes:e,branches:t,depsStr:s}=i((e=>e.helper)),l=i((e=>e.param)),{svg_height:o,stn_list:d,branchSpacingPct:x,coline:f,direction:p}=i((e=>e.param)),j=h(l.stn_list,(()=>0),(()=>0)),v=m("linestart","lineend",j),_=m(v.nodes[1],v.nodes.slice(-2)[0],j),$=r.useMemo((()=>(console.log("computing x shares"),Object.keys(l.stn_list).reduce(((e,n)=>({...e,[n]:g(n,j,t)})),{}))),[t.toString(),JSON.stringify(j)]),y=[l.svgWidth.railmap*l.padding/100,l.svgWidth.railmap*(1-l.padding/100)],k=Object.keys($).reduce(((e,t)=>({...e,[t]:y[0]+$[t]/_.len*(y[1]-y[0])})),{}),w=r.useMemo((()=>(console.log("computing y shares"),Object.keys(d).reduce(((e,n)=>{if(t[0].includes(n))return{...e,[n]:0};{const r=t.slice(1).filter((e=>e.includes(n)))[0];return{...e,[n]:d[r[0]].children.indexOf(r[1])?-3:3}}}),{}))),[s]),b=Object.entries(w).filter((([,e])=>e>=0)).reduce(((e,[t,n])=>({...e,[t]:n})),{}),S=Object.keys(b).reduce(((e,t)=>({...e,[t]:-b[t]*x*o/300})),{}),M=r.useMemo((()=>u(l.current_stn_idx,e,l.direction)),[l.current_stn_idx,l.direction,e.toString()]),z=Object.values(a),O=Object.values(l.stn_list).map((e=>e.services)).flat().reduce(((e,t)=>(e[z.indexOf(t)]=!0,e)),[!1,!1,!1]).map(((e,t)=>[z[t],e])).filter((e=>e[1])).map((e=>e[0])),N=t.map((e=>c(e,M))).reduce(((e,t)=>(e.main.push(t.main),e.pass.push(t.pass),e)),{main:[],pass:[]}),I=O.reduce(((e,t)=>({...e,[t]:Object.keys(N).reduce(((e,n)=>({...e,[n]:N[n].map((e=>te(e,n,k,S,p,t,O.length,d))).filter((e=>""!==e))})),{})})),{});return n.jsxs("g",{id:"main",transform:`translate(0,${l.svg_height*(Object.keys(f).length>0?.5:.7+.1)})`,children:[n.jsx(ee,{paths:I,direction:l.direction}),n.jsx(ne,{stnIds:Object.keys(b).filter((e=>!["linestart","lineend"].includes(e))).filter((e=>0!==d[e].services.length)),xs:k,ys:S,stnStates:M}),Object.keys(f).length>0&&n.jsx(X,{xs:k,servicesPresent:O,stnStates:M}),O.length>1&&n.jsx(re,{servicesLevel:O,lineXs:y})]})},ee=e=>{const{theme:t}=i((e=>e.param)),{paths:r,direction:s}=e;return n.jsx(n.Fragment,{children:Object.keys(r).map(((l,i)=>{var o,d;return n.jsxs("g",{transform:`translate(0,${25*i})`,filter:"#B5B5B6"===t[2]?"url(#pujiang_outline)":void 0,children:[n.jsx("g",{children:null===(o=r[l])||void 0===o?void 0:o.pass.map(((t,r)=>n.jsx("path",{stroke:"var(--rmg-grey)",strokeWidth:12,fill:"none",d:t,markerStart:"l"===e.direction?"url(#arrow_gray)":void 0,markerEnd:"r"===e.direction?"url(#arrow_gray)":void 0,strokeLinejoin:"round"},r)))}),n.jsx("g",{children:null===(d=r[l])||void 0===d?void 0:d.main.map(((e,t)=>n.jsx("path",{stroke:"var(--rmg-theme-colour)",strokeWidth:12,fill:"none",d:e,markerStart:"l"===s?"url(#arrow_theme_left)":void 0,markerEnd:"r"===s?"url(#arrow_theme_right)":void 0,strokeLinejoin:"round",filter:l===a.local?void 0:`url(#contrast-${l})`},t)))})]},`servicePath${i}`)}))})},te=(e,t,n,r,s,l,i,a,o="rightangle")=>{let[d,c]=[];const h={},m={local:0,express:20,direct:40}[l],g=i>1?50:0;let u=30;if(e.length>0){let t=!1,n=!1;a[e.at(-1)||0].children.some((e=>["linestart","lineend"].includes(e)))?n=!0:a[e.at(0)||0].parents.some((e=>["linestart","lineend"].includes(e)))&&(t=!0),u=t||n?u:0}const x=30;if(e.forEach((e=>{const t=n[e],s=r[e];if(!d&&0!==d)return[c,d]=[t,s],void(h.start=[t,s]);0===s?s!==d&&(h.bifurcate=[c,d]):s!==d&&(h.bifurcate=[t,s]),h.end=[t,s],[c,d]=[t,s]})),"start"in h){if("end"in h){if("bifurcate"in h){const[e,n]=h.start,r=h.bifurcate[0],[l,i]=h.end;return"main"===t?"l"===s?i>n?(console.log(h),"rightangle"===o?`M ${e-u},${n} H ${l} V ${i}`:`M ${e},${n} H ${e+x} L ${r-x},${i} H ${l}`):"rightangle"===o?`M ${e},${n} V ${i} H ${l}`:`M ${e-u},${n} H ${r+x} L ${l-x},${i} H ${l}`:i>n?"rightangle"===o?`M ${e},${n} H ${l} V ${i}`:`M ${e},${n} H ${e+x} L ${r-x},${i} H ${l+u}`:"rightangle"===o?`M ${e},${n} V ${i} H ${l+u}`:`M ${e},${n} H ${r+x} L ${l-x},${i} H ${l}`:i>n?"rightangle"===o?`M ${e-u},${n} H ${l} V ${i}`:`M ${e},${n} H ${e+x} L ${r-x},${i} H ${l+u}`:"rightangle"===o?`M ${e},${n} V ${i} H ${l+u}`:`M ${e-u},${n} H ${r+x} L ${l-x},${i} H ${l}`}{const[e,n]=h.start,r=h.end[0];return"main"===t?"l"===s?`M ${e-u-m},${n} H ${r}`:`M ${e},${n} H ${r+u+m}`:"l"===s?`M ${e-u},${n} H ${r+u+g}`:`M ${e-u-g},${n} H ${r+u}`}}{const[e,n]=h.start;return"main"===t?"l"===s?`M ${e-u-m},${n} H ${e}`:`M ${e},${n} H ${e+u+m}`:"l"===s?`M ${e},${n} L ${e+u+g},${n}`:`M ${e-u-g},${n} L ${e},${n}`}}return""},ne=e=>{const{xs:t,ys:r,stnStates:s,stnIds:l}=e;return n.jsx("g",{children:l.map((e=>n.jsx("g",{transform:`translate(${t[e]},${r[e]})`,children:n.jsx(E,{stnId:e,stnState:s[e]})},e)))})},re=e=>{const{svg_height:t,direction:s,svgWidth:l}=i((e=>e.param)),a=130-t,o=e.servicesLevel.map((e=>({local:"普通车",express:"大站车",direct:"直达车"}[e]))),d="r"===s?e.lineXs[0]-42:e.lineXs[1]+42,c=2===e.servicesLevel.length?350:500;return r.useMemo((()=>n.jsxs("g",{children:[o.map(((e,t)=>n.jsxs("g",{transform:`translate(${d},${25*t})`,children:[n.jsx("rect",{x:-27.5,height:10,width:55,fill:"white",stroke:"black",y:-5}),n.jsx("text",{className:"rmg-name__zh",fontSize:9,y:3,textAnchor:"middle",children:`${e}运行线`})]},e))),n.jsxs("g",{transform:`translate(${"r"===s?30:l.railmap-c},${a})`,children:[n.jsx("text",{className:"rmg-name__zh",children:"图例："}),o.map(((e,t)=>n.jsxs("g",{transform:`translate(${150*t+50},0)`,children:[n.jsx("line",{x1:"0",x2:"35",y1:"-5",y2:"-5",stroke:"var(--rmg-theme-colour)",strokeWidth:"12",filter:2===t?"url(#contrast-direct)":1===t?"url(#contrast-express)":""}),n.jsx("use",{x:"17.5",y:"-5",xlinkHref:"#stn_sh",fill:"var(--rmg-theme-colour)"}),n.jsx("text",{x:"40",className:"rmg-name__zh",children:`${e}停靠站`})]},`serviceLevel${t}`)))]})]})),[t,s,l,e.servicesLevel,e.lineXs])},se=()=>{const{direction:e,svgWidth:t,coline:s}=i((e=>e.param)),l=!!Object.keys(s).length;return r.useMemo((()=>n.jsxs("g",{transform:`translate(${"l"===e?50:t.railmap-150},50)`,children:[n.jsx("text",{className:"rmg-name__zh",children:"列车前进方向"}),n.jsx("path",{d:"M60,60L0,0L60-60H100L55-15H160V15H55L100,60z",stroke:l?"var(--rmg-black)":void 0,strokeWidth:l?5:void 0,fill:l?"var(--rmg-white)":"var(--rmg-theme-colour)",transform:`translate(${"l"===e?-30:125},-5)rotate(${"l"===e?0:180})scale(0.15)`})]})),[e,s,t.railmap])},le=e=>{var t,r,s,l;const{stnId:a,nameDirection:o,services:d,color:c}=e,h=i((e=>e.param.stn_list[a])),m=[...(null===(t=h.transfer.groups[0])||void 0===t?void 0:t.lines)||[],...(null===(r=h.transfer.groups[1])||void 0===r?void 0:r.lines)||[]];let g;g=3===h.services.length?"direct_indoor_sh":2===h.services.length?"express_indoor_sh":null!==(s=null===(l=h.transfer.groups[1])||void 0===l||null===(l=l.lines)||void 0===l?void 0:l.length)&&void 0!==s&&s?"osi_indoor_sh":m.length>0?"int2_indoor_sh":"stn_indoor_sh";const u="left"===o||"right"===o?90:0;return n.jsxs(n.Fragment,{children:[n.jsx(ie,{name:h.name,groups:h.transfer.groups,nameDirection:o,services:d}),n.jsx("use",{xlinkHref:`#${g}`,stroke:m.length>0?"var(--rmg-black)":null!=c?c:"var(--rmg-theme-colour)",transform:`rotate(${u})`}),h.services.length>1&&n.jsx("text",{className:"rmg-name__zh",writingMode:"tb",fontSize:"60%",dy:"-12",children:`大站车${h.services.length>2?" 直达车":""}停靠`})]})},ie=e=>{var t,s,l,i,a,o,d,c,h,m,g,u,x,f,p,j,v,_,$,y,k,w,b,S,M;const{name:z,groups:O,nameDirection:N,services:I}=e,H={upward:60,downward:-30,left:0,right:0}[N],W=null!==(t=O[2])&&void 0!==t&&null!==(t=t.lines)&&void 0!==t&&t.length?{upward:0,downward:0,left:((null===(s=O[0].lines)||void 0===s?void 0:s.length)||0)+((null===(l=O[1])||void 0===l||null===(l=l.lines)||void 0===l?void 0:l.length)||0)!==0?85:25,right:((null===(i=O[0].lines)||void 0===i?void 0:i.length)||0)+((null===(a=O[1])||void 0===a||null===(a=a.lines)||void 0===a?void 0:a.length)||0)!==0?-85:-25}[N]:0,L=null!==(o=O[2])&&void 0!==o&&null!==(o=o.lines)&&void 0!==o&&o.length?{upward:null!==(d=O[0])&&void 0!==d&&null!==(d=d.lines)&&void 0!==d&&d.length&&null!==(c=O[1])&&void 0!==c&&null!==(c=c.lines)&&void 0!==c&&c.length?-210:null!==(h=O[0])&&void 0!==h&&null!==(h=h.lines)&&void 0!==h&&h.length||null!==(m=O[1])&&void 0!==m&&null!==(m=m.lines)&&void 0!==m&&m.length?-177.5:-145,downward:(null!==(g=O[0])&&void 0!==g&&null!==(g=g.lines)&&void 0!==g&&g.length&&null!==(u=O[1])&&void 0!==u&&null!==(u=u.lines)&&void 0!==u&&u.length?185:null!==(x=O[0].lines)&&void 0!==x&&x.length||null!==(f=O[1])&&void 0!==f&&null!==(f=f.lines)&&void 0!==f&&f.length?157.5:125)+(3===I.length?40:0),left:null!==(p=O[0])&&void 0!==p&&null!==(p=p.lines)&&void 0!==p&&p.length&&null!==(j=O[1])&&void 0!==j&&null!==(j=j.lines)&&void 0!==j&&j.length?-67:null!==(v=O[0].lines)&&void 0!==v&&v.length||null!==(_=O[1])&&void 0!==_&&null!==(_=_.lines)&&void 0!==_&&_.length?-30:0,right:null!==($=O[0])&&void 0!==$&&null!==($=$.lines)&&void 0!==$&&$.length&&null!==(y=O[1])&&void 0!==y&&null!==(y=y.lines)&&void 0!==y&&y.length?-67:null!==(k=O[0].lines)&&void 0!==k&&k.length||null!==(w=O[1])&&void 0!==w&&null!==(w=w.lines)&&void 0!==w&&w.length?-30:0}[N]:0,F=r.useRef(null),[B,P]=r.useState(60);return r.useEffect((()=>{(null==F?void 0:F.current)&&P(Math.max(60,F.current.getBBox().width))}),[...z]),n.jsxs("g",{transform:`translate(0,${H})`,children:["upward"===N||"downward"===N?n.jsxs(n.Fragment,{children:[n.jsx("line",{x1:-B/2,x2:B/2,y1:"upward"===N?-23:-10,y2:"upward"===N?-23:-10,stroke:"black"}),n.jsx("line",{y1:"upward"===N?-23:-10,y2:"upward"===N?-48:20,stroke:"black"})]}):n.jsxs(n.Fragment,{children:[n.jsx("line",{x1:"left"===N?-50:15,x2:"left"===N?-15:50,y1:0,y2:0,stroke:"black"}),n.jsx("line",{x1:"left"===N?-50:50,x2:"left"===N?-50:50,y1:-30,y2:30,stroke:"black"})]}),[...O[0].lines||[],...(null===(b=O[1])||void 0===b?void 0:b.lines)||[]].length&&n.jsx(oe,{intInfos:[O[0].lines||[],(null===(S=O[1])||void 0===S?void 0:S.lines)||[]],arrowDirection:N,services:I}),n.jsx(ae,{ref:F,stnName:z,nameDirection:N,fill:"black"}),(null===(M=O[2])||void 0===M||null===(M=M.lines)||void 0===M?void 0:M.length)&&n.jsx("g",{transform:`translate(${W},${L})`,children:n.jsx(de,{osysiInfos:O[2].lines,nameDirection:N})})]})},ae=r.forwardRef((function(e,t){const{stnName:s,nameDirection:l,...i}=e,a=s[0].split("\\"),o=s[1].split("\\").length,d={upward:0,downward:0,left:-60,right:60}[l],c={upward:-2,downward:-30-12*(o-1),left:-10*(o-1),right:-10*(o-1)}[l],h={upward:"middle",downward:"middle",left:"end",right:"start"}[l];return n.jsx("g",{ref:t,...i,textAnchor:h,transform:`translate(${d},${c})`,children:r.useMemo((()=>n.jsxs(n.Fragment,{children:[a.map(((e,t,r)=>n.jsx("text",{className:"rmg-name__zh",dy:"upward"===l?16*t:-16*(r.length-1-t),children:e},t))),n.jsx("g",{fontSize:9.6,children:s[1].split("\\").map(((e,t)=>n.jsx("text",{className:"rmg-name__en",dy:12*(t+1)+("upward"===l&&a.length>1?7.5*a.length:0),children:e},t)))})]})),[...s])})})),oe=e=>{var t,s,l,i,a,o,d,c,h,m,g,u,x;const{intInfos:f,arrowDirection:p,services:j}=e,v=f.flatMap((e=>e.map((e=>{var t;return null===(t=e.theme)||void 0===t?void 0:t[2]})))).reduce(((e,t)=>e+t),""),_=f.map((e=>[e.filter((e=>e.name[0].match(/^\d+.*$/))).map((e=>e.name[0].replace(/^(\d+)(.*)$/,"$1"))).join("，").concat("号线"),e.filter((e=>!e.name[0].match(/^\d+.*$/))).map((e=>e.name[0])).join("，")].filter((e=>e&&"号线"!==e)).join("，"))),$=f.map((e=>["Line ".concat(e.filter((e=>/^(L|l)ine \d+$/.test(e.name[1]))).map((e=>e.name[1].replace("Line","").replace("line","").trim())).join(",")),e.filter((e=>!/^(L|l)ine \d+$/.test(e.name[1]))).map((e=>e.name[1])).join(", ")].filter((e=>e&&"Line "!==e)).join(", "))),y=3===j.length?80:45,k={upward:-145,downward:125+(3===j.length?40:0),left:7,right:7}[p],w={upward:0,downward:0,left:20,right:-20}[p],b={upward:-74,downward:44,left:0,right:0}[p],S={upward:0,downward:180,left:90,right:-90}[p],M={upward:0,downward:0,left:85,right:-85}[p],z={upward:"middle",downward:"middle",left:"start",right:"end"}[p],O=M,N={upward:null!==(t=null===(s=f.at(0))||void 0===s?void 0:s.length)&&void 0!==t&&t?-177.5:-145,downward:(null!==(l=null===(i=f.at(0))||void 0===i?void 0:i.length)&&void 0!==l&&l?157.5:125)+(3===j.length?40:0),left:null!==(a=null===(o=f.at(0))||void 0===o?void 0:o.length)&&void 0!==a&&a?-30:7,right:null!==(d=null===(c=f.at(0))||void 0===c?void 0:c.length)&&void 0!==d&&d?-30:7}[p];return n.jsxs("g",{children:[n.jsx("path",{id:"int_indoor_arrow_sh",stroke:"var(--rmg-black)",strokeWidth:1,transform:`translate(${w},${b})rotate(${S})`,fill:1===f.flat().length?null===(h=f.flat()[0].theme)||void 0===h?void 0:h[2]:`url(#grad${v})`,d:`M -7.5,0 v -${y} h -7.5 l 15,-15 l 15,15 h -7.5 v ${y} Z`}),f.flat().length>1&&n.jsx("linearGradient",{id:`grad${v}`,y1:"0",y2:"0",x1:"upward"===p?"25%":"75%",x2:"upward"===p?"75%":"25%",children:f.flat().map(((e,t)=>{var s,l;return n.jsxs(r.Fragment,{children:[n.jsx("stop",{offset:100/f.flat().length*t+"%",stopColor:null===(s=e.theme)||void 0===s?void 0:s[2]}),n.jsx("stop",{offset:100/f.flat().length*(t+1)+"%",stopColor:null===(l=e.theme)||void 0===l?void 0:l[2]})]},t)}))}),(null!==(m=null===(g=f.at(0))||void 0===g?void 0:g.length)&&void 0!==m?m:0)>0&&n.jsxs("g",{transform:`translate(${M},${k})`,textAnchor:`${z}`,children:[n.jsx("text",{className:"rmg-name__zh",dy:-7,children:`换乘${_[0]}`}),n.jsx("text",{className:"rmg-name__en",dy:5,fontSize:9.6,children:`Interchange ${$[0]}`})]}),(null!==(u=null===(x=f.at(1))||void 0===x?void 0:x.length)&&void 0!==u?u:0)>0&&n.jsxs("g",{transform:`translate(${O},${N})`,textAnchor:`${z}`,children:[n.jsx("text",{className:"rmg-name__zh",dy:-7,children:`出站换乘${_[1]}`}),n.jsx("text",{className:"rmg-name__en",dy:5,fontSize:9.6,children:`Out-of-station Transfer ${$[1]}`})]})]})},de=e=>{const t={upward:"middle",downward:"middle",left:"start",right:"end"}[e.nameDirection];return r.useMemo((()=>n.jsxs("g",{textAnchor:`${t}`,children:[n.jsx("text",{className:"rmg-name__zh",dy:-5,children:`转乘${e.osysiInfos.map((e=>e.name[0])).join("，")}`}),n.jsx("text",{className:"rmg-name__en",dy:7.5,fontSize:9.6,children:`To ${e.osysiInfos.map((e=>e.name[1])).join(", ")}`})]})),[JSON.stringify(e.osysiInfos),e.nameDirection])},ce=e=>{var t,r,o,d;const{loop_branches:c,edges:h,xs:m,ys:g,canvas:u}=e,[x,f,p,j]=h,{branches:v}=i((e=>e.helper)),{current_stn_idx:_,direction:$,coline:y}=i((e=>e.param)),k=u===l.RailMap?30:0,w=[`M ${x},${p} H ${Number(m[null!==(t=null===(r=c.at(0))||void 0===r?void 0:r.at(0))&&void 0!==t?t:""])-k}`,`M ${f},${p} H ${Number(m[null!==(o=null===(d=c.at(1))||void 0===d?void 0:d.at(-1))&&void 0!==o?o:""])+k}`],b=v[0].filter((e=>!["linestart","lineend"].includes(e))),S=Object.values(y).filter((e=>![e.from,e.to].every((e=>b.includes(e))))).map((e=>e.colors));return n.jsx(n.Fragment,{children:c.map(((e,t)=>{var r,i;return n.jsxs(s.Fragment,{children:[S.filter(((e,t,n)=>t===n.findIndex((t=>{var n,r;return(null===(n=t.at(0))||void 0===n?void 0:n.at(2))===(null===(r=e.at(0))||void 0===r?void 0:r.at(2))})))).map((e=>n.jsx("marker",{id:`arrow_theme_${e[0][2]}`,refX:1,refY:.5,children:n.jsx("path",{d:"M0,1H2L1,0z",fill:e[0][2]})},e[0][2]))),n.jsx("path",{stroke:null!==(r=null===(i=S.at(t))||void 0===i||null===(i=i.at(0))||void 0===i?void 0:i.at(2))&&void 0!==r?r:"var(--rmg-theme-colour)",strokeWidth:12,fill:"none",d:w[t],markerEnd:u===l.RailMap&&("l"===$&&0===t||"r"===$&&1===t)?S.at(t)?`url(#arrow_theme_${S[t][0][2]})`:"url(#arrow_theme)":void 0}),e.filter((e=>!["linestart","lineend"].includes(e))).map((e=>{var r,i;return n.jsxs(s.Fragment,{children:[u===l.RailMap&&n.jsx("g",{transform:`translate(${m[e]},${g[e]})`,children:n.jsx(E,{stnId:e,stnState:_===e?0:1,bank:0,direction:$,color:null===(r=S.at(t))||void 0===r||null===(r=r.at(0))||void 0===r?void 0:r.at(2)})},e),u===l.Indoor&&n.jsx("g",{transform:`translate(${m[e]},${g[e]})`,children:n.jsx(le,{stnId:e,nameDirection:c.filter((t=>t.includes(e))).map((t=>t.indexOf(e)%2==0?"downward":"upward"))[0],services:[a.local],color:null===(i=S.at(t))||void 0===i||null===(i=i.at(0))||void 0===i?void 0:i.at(2)})},e)]},e)}))]},e.at(0))}))})},he=e=>{var t;const{edges:r,loop_stns:s,xs:a,ys:d,canvas:c}=e,[h,m,g,u]=r,{info_panel_type:x,stn_list:f,coline:p}=i((e=>e.param)),{branches:j}=i((e=>e.helper)),v=Object.values(p).filter((e=>[e.from,e.to].every((e=>j.slice(1,3).filter((e=>o(e,f))).flat().includes(e))))).map((e=>e.colors)).at(0),_=c===l.RailMap&&"sh2020"===x?3:0;return n.jsxs("g",{id:"coline_main",children:[n.jsx("path",{d:`M ${h},${g} H${m}`,strokeWidth:12,stroke:null==v||null===(t=v.at(0))||void 0===t?void 0:t.at(2)}),c===l.RailMap&&Object.keys(p).length>0&&s.top.map((e=>{var t;return n.jsx("g",{transform:`translate(${a[e]},${d[e]})`,children:"sh2020"===x?n.jsxs(n.Fragment,{children:[n.jsx("rect",{stroke:"none",height:24,width:12,x:-6,y:-_-1,fill:null==v||null===(t=v.at(0))||void 0===t?void 0:t.at(2)}),n.jsx("rect",{stroke:"none",height:_+12,width:12,x:-6,y:10,fill:"var(--rmg-theme-colour)"})]}):n.jsx("use",{xlinkHref:"#int2_sh",stroke:"var(--rmg-theme-colour)",transform:"translate(0,13)"})},e)}))]})},me=e=>{var r;const{bank_angle:s,canvas:a}=e,{branches:d}=i((e=>e.helper)),{current_stn_idx:c,svgWidth:h,svg_height:m,padding:g,branchSpacingPct:u,direction:x,info_panel_type:f,stn_list:p,loop_info:{left_and_right_factor:j,bottom_factor:v},coline:_}=i((e=>e.param)),$=d[0].filter((e=>!["linestart","lineend"].includes(e))),y=d.slice(0,3).flat().filter((e=>t=>2===(e[t]=(e[t]||0)+1))({})).filter((e=>!["linestart","lineend"].includes(e))),k=null!==(r=Object.values(_).filter((e=>[e.from,e.to].every((e=>d.slice(1,3).filter((e=>o(e,p))).flat().includes(e))))).map((e=>{const t=$.findIndex((t=>t===e.from)),n=$.findIndex((t=>t===e.to));return Math.abs(n-t)>$.length-2-Math.abs(n-t)?"major":"minor"})).at(0))&&void 0!==r?r:"minor",w=y.at(1)?((e,n,r,s)=>{let l=e.findIndex((e=>e===n[0])),i=e.findIndex((e=>e===n[1]));[l,i,n[0],n[1]]=l>i?[i,l,n[1],n[0]]:[l,i,n[0],n[1]];const a=e.slice(l,i+1),o=e.filter((e=>!a.filter((e=>!n.includes(e))).includes(e))),d=e.length-("major"===s?Math.max:Math.min)(a.length,o.length)-2*r,c="major"===s?a.length>o.length?n[0]:n[1]:a.length>o.length?n[1]:n[0];return t(e,c,d,r)})($,y,j,k):y.at(0)?t($,y[0],v,j):((e,t,n,r)=>{const s=e.length-2*r-n,l=e.findIndex((e=>e===t)),i=[...e,...e,...e],a=e.length+l-Math.floor(s/2)+(s%2==0?1:0),o=e.length+l+Math.floor(s/2);return{top:i.slice(a,o+1),left:i.slice(a-r,a),right:i.slice(o+1,o+1+r),bottom:i.slice(o+1+r,o+1+r+n)}})($,c,v,j),{x_shares:b,y_shares:S}=((e,t)=>{const n=Object.fromEntries(e.map((e=>[e,-1]))),r=Object.fromEntries(e.map((e=>[e,-1]))),[s,l,i,a]=[0,1,0,1];return t.top.forEach(((e,l)=>{n[e]=0+1/(t.top.length+1)*(l+1),r[e]=s})),t.right.forEach(((e,s)=>{n[e]=a,r[e]=0+1/(t.right.length+1)*(s+1)})),t.bottom.forEach(((e,s)=>{n[e]=1-1/(t.bottom.length+1)*(s+1),r[e]=l})),t.left.forEach(((e,s)=>{n[e]=i,r[e]=1-1/(t.left.length+1)*(s+1)})),{x_shares:n,y_shares:r}})($,w),{loop_branches:M,line_xs_branches:z,xs_branches:O}=((e,t,n,r,s,l)=>{var i,a,o,d;const c=e[0].filter((e=>!["linestart","lineend"].includes(e))),h=e.slice(1,3).map((e=>e.slice(1,e.length-1))),m=h.reduce(((e,n)=>e+n.filter((e=>!["linestart","lineend",...t].includes(e))).length),0)+c.length-l-2*s,g=(n-n*r/100*2)/(1+m),u=[n*r/100+(null!==(i=h.at(0))&&void 0!==i?i:[]).length*g,n*(1-r/100)-(null!==(a=h.at(1))&&void 0!==a?a:[]).length*g],x={...Object.fromEntries((null!==(o=h.at(0))&&void 0!==o?o:[]).map(((e,t)=>[e,n*r/100+t*g]))),...Object.fromEntries((null!==(d=h.at(1))&&void 0!==d?d:[]).map(((e,t)=>[e,u[1]+(1+t)*g])))};return{loop_branches:h,line_xs_branches:u,xs_branches:x}})(d,y,h[a],g,j,w.bottom.length),N={...S,...Object.fromEntries(M.flat().map((e=>[e,0])))},I=u*m/300,H=[225+I,m-75-(a===l.RailMap?0:125)-I],W=Object.keys(N).reduce(((e,t)=>({...e,[t]:H[0]+N[t]*(H[1]-H[0])})),{}),L=[Math.max(h[a]*g/100+(s&&a===l.RailMap?100:0),z[0]),Math.min(h[a]*(1-g/100)-(s&&a===l.RailMap?100:0),z[1])],F=Object.keys(b).reduce(((e,t)=>({...e,[t]:L[0]+b[t]*(L[1]-L[0])})),{}),B=s?{l:1,r:-1}[x]:0;[...w.right,...w.left].forEach((e=>{F[e]-=(W[e]-H[0])*B})),w.bottom.forEach((e=>{F[e]-=(H[1]-H[0])*B}));const P={...O,...F},E=ge(w,P,W,B,[...L,...H],x),R=a===l.RailMap&&"sh2020"===f?3:0;Object.keys(_).length>0&&w.top.forEach((e=>{W[e]-=R+12}));const A=M.length?0:(H[1]-H[0])*B/2;return n.jsxs("g",{id:"loop",transform:`translate(${A},0)`,children:[n.jsx("path",{stroke:"var(--rmg-theme-colour)",strokeWidth:12,fill:"none",d:E,strokeLinejoin:"round"}),a===l.RailMap&&n.jsx(ue,{canvas:a,loop_stns:w,xs:P,ys:W}),n.jsxs("g",{transform:`translate(0,${Object.keys(_).length>0?-12-R:0})`,children:[n.jsx(ce,{loop_branches:M,edges:[...L,...H],xs:P,ys:W,canvas:a}),Object.keys(_).length>0&&n.jsx(he,{edges:[...L,...H],loop_stns:w,xs:P,ys:W,canvas:a})]}),a===l.Indoor&&n.jsx(ue,{canvas:a,loop_stns:w,xs:P,ys:W})]})},ge=(e,t,n,r,s,l)=>{const[i,a,o,d]=s,c=(e,t,n,s,l)=>({right:[n+(s-o)*r,t],bottom:[e-(d-t)*r,s],left:[n-(d-s)*r,t],top:[e+(t-o)*r,s]}[l]),h=[];e.top.forEach((e=>{h.push([t[e],n[e]])})),["right","bottom","left"].forEach((s=>{if(e[s].length>0)h.push(c(h.at(-1)[0],h.at(-1)[1],t[e[s][0]],n[e[s][0]],s)),e[s].forEach((e=>{h.push([t[e],n[e]])}));else{const e={right:[a,h.at(-1)[1]],bottom:[h.at(-1)[0]+(d-h.at(-1)[1])*-r,h.at(-1)[1]+(d-h.at(-1)[1])],left:[i+(0===r?0:(d-o)*("l"===l?-1:1)),h.at(-1)[1]]};h.push(e[s])}})),h.push(c(h.at(-1)[0],h.at(-1)[1],t[e.top[0]],n[e.top[0]],"top"));const m=h.slice(1).map((([e,t])=>`L${e},${t} `)).join(" ");return`M${h[0][0]},${h[0][1]} ${m} Z`},ue=e=>{const{canvas:t,loop_stns:r,xs:s,ys:o}=e,{current_stn_idx:d}=i((e=>e.param)),c={top:0,bottom:0,left:-1,right:1},h={left:"r",right:"l",top:void 0,bottom:void 0},m=(e,t)=>({top:t%2==0?"upward":"downward",bottom:t%2==0?"upward":"downward",left:"left",right:"right"}[e]);return n.jsxs("g",{id:"loop_stations",children:[t===l.RailMap&&Object.entries(r).map((([e,t])=>t.map((t=>n.jsx("g",{transform:`translate(${s[t]},${o[t]})`,children:n.jsx(E,{stnId:t,stnState:d===t?0:1,bank:c[e],direction:h[e]})},t))))),t===l.Indoor&&Object.entries(r).map((([e,t])=>t.map(((t,r)=>n.jsx("g",{transform:`translate(${s[t]},${o[t]})`,children:n.jsx(le,{stnId:t,nameDirection:m(e,r),services:[a.local]})},t)))))]})},xe=l.RailMap;function fe(){const{canvasScale:e}=i((e=>e.app)),{svgWidth:t,svg_height:r,theme:s,loop:a,loop_info:{bank:o}}=i((e=>e.param)),c=t[xe];return n.jsxs(d,{type:xe,svgWidth:c,svgHeight:r,canvasScale:e,theme:s,children:[n.jsx(pe,{}),a?n.jsx(me,{bank_angle:o,canvas:l.RailMap}):n.jsx(Q,{}),n.jsx(se,{})]})}const pe=r.memo((function(){return n.jsxs("defs",{children:[n.jsx("circle",{id:"stn_sh",fill:"var(--rmg-white)",strokeWidth:2,r:5}),n.jsx("path",{id:"int2_sh",fill:"var(--rmg-white)",strokeWidth:2,d:"M -5,0 a 5,5 0 1 1 10,0 V10 a 5,5 0 1 1 -10,0Z"}),n.jsx("path",{id:"express_sh",fill:"var(--rmg-white)",strokeWidth:2,d:"M -5,0 a 5,5 0 1 1 10,0 V25 a 5,5 0 1 1 -10,0Z"}),n.jsx("path",{id:"direct_sh",fill:"var(--rmg-white)",strokeWidth:2,d:"M -5,0 a 5,5 0 1 1 10,0 V50 a 5,5 0 1 1 -10,0Z"}),n.jsx("rect",{id:"stn_sh_2020",stroke:"none",height:24,width:12,x:-6,y:-18}),n.jsx("rect",{id:"stn_sh_2020_express",stroke:"none",height:49,width:12,x:-6,y:-18}),n.jsx("rect",{id:"stn_sh_2020_direct",stroke:"none",height:74,width:12,x:-6,y:-18}),n.jsx("rect",{id:"intbox_number",height:22,width:20,y:-11}),n.jsxs("g",{id:"intbox_maglev",transform:"translate(-25,0)",children:[n.jsx("rect",{id:"maglev_5",height:144,width:130,y:"40",x:"30",strokeWidth:10}),n.jsx("path",{id:"maglev_3",fill:"var(--rmg-white)",d:"m90,55a40,5 0 0 0 -40,3a5,5 0 0 0 -5,5a5,60 0 0 0 -3,60a5,5 0 0 0 5,5l96,0a5,5 0 0 0 5,-5a5,60 0 0 0 -3,-60a5,5 0 0 0 -5,-5a40,5 0 0 0 -40,-3l-5,-10l-5,10"}),n.jsx("path",{id:"maglev_4",fill:"var(--rmg-white)",d:"m90,140l-40,0a10,5 0 0 1 -10,-5l0,25a10,15 0 0 0 10,15l15,0l0,-10l-15,0l0,-15l90,0l0,15l-15,0l0,10l15,0a10,15 0 0 0 10,-15l0,-25a10,5 0 0 1 -10,5l-50,0"}),n.jsx("rect",{id:"maglev_1",height:"25",width:"40",y:"80",x:"50"}),n.jsx("rect",{id:"maglev_2",height:"25",width:"40",y:"80",x:"100"})]}),n.jsxs("g",{id:"airport",transform:"scale(0.5)",children:[n.jsx("circle",{cx:"0",cy:"29.33899",r:"29.33899",fill:"var(--rmg-grey)"}),n.jsx("path",{id:"airport",d:"M28.9769,6.60134c1.711.013,3.111,2.53205,3.111,4.241v10.337s17.106,15.435,17.358,15.666a1.145,1.145,0,0,1,.488,1.152v2.833c0,.651-.451.61-.695.467-.334-.119-17.151-8.863-17.151-8.863-.004,1.458-.797,9.006-1.326,13.304,0,0,4.61,2.457,4.699,2.521.334.268.352.359.352.852v2.001c0,.477-.352.428-.51.324-.183-.062-5.693-1.921-5.693-1.921a2.56018,2.56018,0,0,0-.633-.127,2.31654,2.31654,0,0,0-.666.127s-5.477,1.859-5.672,1.921c-.185.104-.523.153-.523-.324v-2.001c0-.493.029-.584.367-.852.086-.064,4.678-2.521,4.678-2.521-.524-4.298-1.307-11.846-1.325-13.304,0,0-16.822,8.744-17.148,8.863-.217.143-.69.184-.69-.467v-2.833a1.16206,1.16206,0,0,1,.473-1.152c.276-.231,17.365-15.666,17.365-15.666v-10.337c0-1.709,1.403-4.228,3.14105-4.241",transform:"translate(-28.9697,0.14347)",fill:"var(--rmg-white)"})]}),n.jsxs("g",{id:"disney",transform:"scale(0.5)",children:[n.jsx("circle",{cx:"0",cy:"29.33899",r:"29.33899",fill:"var(--rmg-grey)"}),n.jsx("path",{fill:"var(--rmg-white)",d:"M45.6152,7.85015a9.80248,9.80248,0,0,0-9.79907,9.801,9.70059,9.70059,0,0,0,.342,2.582c.002.026.002.055.002.093a.31815.31815,0,0,1-.31494.318.67741.67741,0,0,1-.12806-.02,15.71521,15.71521,0,0,0-13.498,0,.61.61,0,0,1-.122.02.31841.31841,0,0,1-.322-.318v-.067a9.62553,9.62553,0,0,0,.35608-2.608,9.803,9.803,0,1,0-9.797,9.8,10.10364,10.10364,0,0,0,2.308-.271h.05493a.31113.31113,0,0,1,.31409.318.32433.32433,0,0,1-.019.12,15.72588,15.72588,0,1,0,29.703,7.216,15.83676,15.83676,0,0,0-1.746-7.23.18417.18417,0,0,1-.0271-.106.31612.31612,0,0,1,.32007-.318h.057a10.15953,10.15953,0,0,0,2.316.271,9.80051,9.80051,0,0,0,0-19.601",transform:"translate(-28.9697 0.13398)"})]}),n.jsxs("g",{id:"railway",children:[n.jsx("circle",{cx:"0",cy:"29.33899",r:"29.33899",fill:"var(--rmg-grey)",transform:"translate(0,-2)scale(0.5)"}),n.jsx("path",{fill:"var(--rmg-white)",d:"M169,273.5c0-19,14.7-34.8,33.7-36.3c18.9-1.5,38.1-2.2,57.4-2.2c19.3,0,38.4,0.8,57.3,2.2  c19,1.5,33.7,17.3,33.7,36.3v47.3l-51.3,14.7c-11.2,3.2-18.9,13.4-18.9,25v147.8c0,17.4,12.2,32.3,29.3,35.7l110.6,22.1  c4.9,1,8.4,5.2,8.4,10.2V599H91v-22.7c0-5,3.5-9.2,8.4-10.2L209.9,544c17-3.4,29.3-18.3,29.3-35.7V360.5c0-11.6-7.7-21.8-18.9-25  L169,320.8V273.5z M309.4,31.7c0.2-1.2,0.3-2.4,0.3-3.6c0-14-11.1-25.4-24.9-26C276.6,1.4,268.3,1,260,1c-8.3,0-16.6,0.4-24.7,1.1  c-13.9,0.6-24.9,12-24.9,26c0,1.2,0.1,2.5,0.3,3.6C90.6,54.8,0,160.3,0,287c0,97.2,53.4,182,132.4,226.6l36.8-48.1  C104.3,432.4,59.8,364.9,59.8,287c0-110.6,89.6-200.2,200.2-200.2S460.2,176.4,460.2,287c0,77.9-44.5,145.4-109.4,178.5  c15,19.6,25.6,33.5,36.8,48.1C466.6,469,520,384.2,520,287C520,160.3,429.4,54.8,309.4,31.7z",transform:"translate(-10,0)scale(0.04)"})]}),n.jsx("marker",{id:"arrow_gray",viewBox:"-1.5 0 3 1.5",refY:.5,children:n.jsx("path",{d:"M0,0L1,1H-1z",fill:"var(--rmg-grey)"})}),n.jsx("marker",{id:"arrow_theme_left",refX:1,refY:.5,children:n.jsx("path",{d:"M1,0L0,1H1z",fill:"var(--rmg-theme-colour)"})}),n.jsx("marker",{id:"arrow_theme_right",refY:.5,children:n.jsx("path",{d:"M0,0L1,1H-1z",fill:"var(--rmg-theme-colour)"})}),n.jsx("marker",{id:"arrow_theme",refX:1,refY:.5,children:n.jsx("path",{d:"M0,1H2L1,0z",fill:"var(--rmg-theme-colour)"})}),n.jsx("filter",{id:"contrast-direct",filterUnits:"userSpaceOnUse",children:n.jsxs("feComponentTransfer",{children:[n.jsx("feFuncR",{type:"linear",slope:.5,intercept:.25}),n.jsx("feFuncG",{type:"linear",slope:.5,intercept:.25}),n.jsx("feFuncB",{type:"linear",slope:.5,intercept:.25})]})}),n.jsx("filter",{id:"contrast-express",filterUnits:"userSpaceOnUse",children:n.jsxs("feComponentTransfer",{children:[n.jsx("feFuncR",{type:"linear",slope:.75,intercept:.125}),n.jsx("feFuncG",{type:"linear",slope:.75,intercept:.125}),n.jsx("feFuncB",{type:"linear",slope:.75,intercept:.125})]})}),n.jsx(S,{})]})})),je=l.Indoor;function ve(){const{canvasScale:e}=i((e=>e.app)),{svgWidth:t,svg_height:r,theme:s,loop:a}=i((e=>e.param)),o=t[je];return n.jsxs(d,{type:je,svgWidth:o,svgHeight:r,canvasScale:e,theme:s,children:[n.jsx(_e,{}),a?n.jsx(me,{bank_angle:!1,canvas:l.Indoor}):n.jsx(ke,{}),n.jsx(Se,{})]})}const _e=r.memo((function(){return n.jsxs("defs",{children:[n.jsx("circle",{id:"stn_indoor_sh",fill:"var(--rmg-white)",strokeWidth:5,r:8,transform:"scale(1.5)"}),n.jsx("path",{id:"int2_indoor_sh",fill:"var(--rmg-white)",transform:"translate(0, -10)scale(2)",strokeWidth:4,d:"M -5,0 a 5,5 0 1 1 10,0 V10 a 5,5 0 1 1 -10,0Z"}),n.jsx("path",{id:"express_indoor_sh",fill:"var(--rmg-white)",transform:"translate(0, -10)scale(2)",strokeWidth:4,d:"M -5,0 a 5,5 0 1 1 10,0 V25 a 5,5 0 1 1 -10,0Z"}),n.jsx("path",{id:"direct_indoor_sh",fill:"var(--rmg-white)",transform:"translate(0, -10)scale(2)",strokeWidth:4,d:"M -5,0 a 5,5 0 1 1 10,0 V40 a 5,5 0 1 1 -10,0Z"}),n.jsxs("g",{id:"osi_indoor_sh",children:[n.jsx("line",{x1:"0",x2:"0",y1:"-12",y2:"12",stroke:"var(--rmg-black)",strokeWidth:22}),n.jsx("line",{x1:"0",x2:"0",y1:"-12",y2:"12",stroke:"var(--rmg-white)",strokeWidth:10}),n.jsx("circle",{cy:"-12",fill:"var(--rmg-white)",strokeWidth:5,r:8,transform:"scale(1.5)"}),n.jsx("circle",{cy:"12",fill:"var(--rmg-white)",strokeWidth:5,r:8,transform:"scale(1.5)"})]})]})})),$e=(e,t)=>{let n=0;return 2===e[t].parents.length&&(n+=1),2===e[e[t].parents[0]].children.length&&(n+=1),n},ye=(e,t)=>{let n=0;return 2===e[t].children.length&&(n+=1),2===e[e[t].children[0]].parents.length&&(n+=1),n},ke=()=>{const{routes:e,branches:t,depsStr:s}=i((e=>e.helper)),l=i((e=>e.param)),o=h(l.stn_list,$e,ye),d=m("linestart","lineend",o),c=m(d.nodes[1],d.nodes.slice(-2)[0],o),f=r.useMemo((()=>(console.log("computing x shares"),Object.keys(l.stn_list).reduce(((e,n)=>({...e,[n]:g(n,o,t)})),{}))),[t.toString(),JSON.stringify(o)]),p=[l.svgWidth.indoor*l.padding/100,l.svgWidth.indoor*(1-l.padding/100)],j=Object.keys(f).reduce(((e,t)=>({...e,[t]:p[0]+f[t]/c.len*(p[1]-p[0])})),{}),v=r.useMemo((()=>x.getYShares(l.stn_list,t)),[s]),_=Object.keys(v).reduce(((e,t)=>({...e,[t]:v[t]*l.branchSpacingPct*l.svg_height/200})),{}),$=r.useMemo((()=>u(l.current_stn_idx,e,l.direction)),[l.current_stn_idx,l.direction,e.toString()]),y=Object.values(a),k=Object.values(l.stn_list).map((e=>e.services)).flat().reduce(((e,t)=>(e[y.indexOf(t)]=!0,e)),[!1,!1,!1]).map(((e,t)=>[y[t],e])).filter((e=>e[1])).map((e=>e[0])),w=x.drawLine(t,$,l.stn_list,p,j,_,l.branchSpacingPct*l.svg_height/200,d,0);return n.jsxs("g",{id:"main",transform:`translate(0,${l.svg_height/2})`,children:[n.jsx(we,{paths:w,services:k}),n.jsx(be,{xs:j,ys:_,services:k})]})},we=e=>n.jsx("g",{fill:"none",strokeWidth:12,stroke:"var(--rmg-theme-colour)",children:e.services.map(((t,r)=>n.jsxs("g",{transform:`translate(0, ${30*r})`,children:[e.paths.main.map(((e,t)=>n.jsx("path",{d:e},t))),e.paths.pass.map(((e,t)=>n.jsx("path",{d:e},t)))]},`indoor_line_${r}`)))}),be=e=>{const{branches:t}=i((e=>e.helper)),{stn_list:r,namePosMTR:{isFlip:s}}=i((e=>e.param)),{xs:l,ys:a,services:o}=e,d=null==s||s?"upward":"downward",c="upward"===d?"downward":"upward";return n.jsx("g",{children:Object.keys(r).filter((e=>!["linestart","lineend"].includes(e))).filter((e=>0!==r[e].services.length)).map((e=>n.jsx("g",{transform:`translate(${l[e]},${a[e]})`,children:n.jsx(le,{stnId:e,nameDirection:o.length>1?"downward":t.filter((t=>t.includes(e))).map((t=>t.indexOf(e)%2==0?d:c))[0],services:o})},e)))})},Se=r.memo((()=>{const e=i((e=>e.param));return n.jsxs(n.Fragment,{children:[n.jsx("g",{transform:`translate(${e.svgWidth.indoor/2},50)`,children:n.jsxs("text",{textAnchor:"middle",fontSize:"30",className:"rmg-name__zh",children:["轨道交通",e.line_name[0],"运营线路示意图"]})}),n.jsxs("g",{transform:`translate(${e.svgWidth.indoor/2},${e.svg_height-270})`,children:[n.jsx("text",{textAnchor:"middle",fontSize:"18",className:"rmg-name__zh",dx:"-30",dy:"230",children:"友情提示：请留意您需要换乘线路的首末班时间，以免耽误您的出行，末班车进站前三分钟停售该末班车车票。"}),n.jsx("text",{textAnchor:"middle",fontSize:"12",className:"rmg-name__en",dx:"10",dy:"250",children:"Please pay attention to the interchange schedule if you want to transfer to other lines. Stop selling tickets 3 minutes before the last train services."}),n.jsxs("g",{transform:"translate(-700,215)",children:[n.jsx("rect",{x:"-5",y:"-25",width:"200",height:"70",fill:"none",stroke:"black",rx:"5"}),n.jsx("line",{x1:"28",x2:"28",y1:"-20",y2:"40",stroke:"black"}),n.jsx("text",{className:"rmg-name__zh",dx:"3",fontSize:"18",children:"图"}),n.jsx("text",{className:"rmg-name__zh",dx:"3",dy:"18",fontSize:"18",children:"例"}),n.jsx("text",{className:"rmg-name__en",dy:"35",fontSize:"8",children:"legend"}),n.jsx("use",{transform:"translate(45,10)",xlinkHref:"#int2_indoor_sh",stroke:"var(--rmg-black)"}),n.jsx("text",{className:"rmg-name__zh",dx:"65",dy:"5",fontSize:"10",children:"换乘站"}),n.jsx("text",{className:"rmg-name__en",dx:"65",dy:"15",fontSize:"6",children:"Interchange"}),n.jsx("text",{className:"rmg-name__en",dx:"65",dy:"25",fontSize:"6",children:"Station"}),n.jsx("use",{transform:"translate(115,10)scale(0.75)",xlinkHref:"#osi_indoor_sh",stroke:"var(--rmg-black)"}),n.jsx("text",{className:"rmg-name__zh",dx:"130",dy:"5",fontSize:"10",children:"出站换乘车站"}),n.jsx("text",{className:"rmg-name__en",dx:"130",dy:"15",fontSize:"6",children:"Out-of-station Transfer"}),n.jsx("text",{className:"rmg-name__en",dx:"130",dy:"25",fontSize:"6",children:"Station"})]})]})]})}));Se.displayName="InfoElements",e("default",{destination:n.jsx(p,{}),runin:n.jsx(z,{}),railmap:n.jsx(fe,{}),indoor:n.jsx(ve,{})})}}}));
